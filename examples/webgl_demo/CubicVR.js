/*
  Javascript port of CubicVR 3D engine for WebGL
  by Charles J. Cliffe
  http://www.cubicvr.org/

  May be used under the terms of the MIT license.
  http://www.opensource.org/licenses/mit-license.php
*/

/*globals alert: false */
try{if(!window)self.window=self,self.document={},self.fakeWindow=!0,self.console={log:function(){}}}catch(e$$5){self.window=self,self.document={},self.fakeWindow=!0,self.console={log:function(){}}}
(function(v,x,r,n,o){function g(a,b){A.registry[a]=!0;var h=b(A),q;for(q in h)h.hasOwnProperty(q)&&(c[q]=h[q])}var d="";try{for(var m=x.querySelectorAll("script"),a=0,b=m.length;a<b;a++){var e=m[a].src.lastIndexOf("/CubicVR.js");e>-1&&(d=m[a].src.substr(0,e)+"/")}}catch(h){}var c=v.CubicVR={},q={CoreShader_vs:null,CoreShader_fs:null,canvas:null,width:null,height:null,fixed_aspect:0,fixed_size:null,depth_alpha:!1,default_filter:1,mainloop:null,shadow_near:0.1,shadow_far:100,soft_shadow:!1,resize_active:!1,
emptyLight:null,resizeList:[],canvasSizeFactor:1},t;try{t=console!==void 0&&console.log?function(a){console.log("CubicVR Log: "+a)}:function(){}}catch(s){t=n}var L={quality:{LOW:0,MEDIUM:1,HIGH:2}},A={undef:o,nop:n,scriptLocation:d,GLCore:q,Textures:[],Textures_obj:[],Textures_ref:[],Images:[],ShaderPool:[],log:t,registry:{},enums:L,MAX_LIGHTS:6,features:{},quality:L.HIGH},I={low:{antiAlias:!1,lightPerPixel:!1,lightShadows:!1,texturePerPixel:!1,postProcess:!1},medium:{antiAlias:!1,lightPerPixel:!0,
lightShadows:!1,texturePerPixel:!1,postProcess:!1},high:{antiAlias:!0,lightPerPixel:!0,lightShadows:!0,texturePerPixel:!0,postProcess:!0}};A.features=I.high;q.init=function(a,b,h){var e,s=c.util;b&&h?(b=s.getScriptContents(b),h=s.getScriptContents(h)):c.CubicVRCoreVS&&c.CubicVRCoreFS?(b=c.CubicVRCoreVS,h=c.CubicVRCoreFS):(b=s.getScriptContents(d+"CubicVR_Core.vs"),h=s.getScriptContents(d+"CubicVR_Core.fs"));if(a===o){a=x.createElement("canvas");e||(e=a.getContext("experimental-webgl",{antialias:A.features.antiAlias}));
q.gl=e;if(q.fixed_size!==null)q.width=q.fixed_size[0],q.height=q.fixed_size[1],q.resizeElement(a,q.width,q.height);else if(q.addResizeable(a),q.canvasSizeFactor!==1&&a.getContext!==o){var s=r.round(v.innerWidth*q.canvasSizeFactor),m=r.round(v.innerHeight*q.canvasSizeFactor);q.resizeElement(a,s,m);a.style.top=v.innerHeight/2-m/2+"px";a.style.left=v.innerWidth/2-s/2+"px";a.style.position="absolute"}else q.resizeElement(a,v.innerWidth,v.innerHeight);x.body.appendChild(a)}if(a.getContext!==o&&a.width!==
o&&a.height!==o){try{e||(e=a.getContext("experimental-webgl")),e.viewport(0,0,a.width,a.height),q.canvas=a,q.width=a.width,q.height=a.height,e.clearColor(0,0,0,1),e.clearDepth(1),e.enable(e.DEPTH_TEST),e.depthFunc(e.LEQUAL)}catch(g){}if(!e)return null}else e=a;q.gl=e;q.CoreShader_vs=b;q.CoreShader_fs=h;e.enable(e.CULL_FACE);e.cullFace(e.BACK);e.frontFace(e.CCW);for(b=L.light.type.NULL;b<L.light.type.MAX;b++)A.ShaderPool[b]=[];h=new c.Texture;a=new c.Material;for(b=0;b<L.texture.map.MAX;b++)b!==L.texture.map.BUMP&&
a.setTexture(h,b);a.opacity=0.5;b=1;try{for(;;){a.use(L.light.type.POINT,b);if(b===8){A.MAX_LIGHTS=b;break}b++}}catch(u){A.MAX_LIGHTS=b}a=q.emptyLight=new c.Light(L.light.type.POINT);a.diffuse=[0,0,0];a.specular=[0,0,0];a.distance=0;a.intensity=0;a.cutoff=0;t("Calibrated maximum lights per pass to: "+b);for(b=L.light.type.NULL;b<L.light.type.MAX;b++)A.ShaderPool[b]=[];if(q.resizeList.length)v.addEventListener("resize",function(){c.GLCore.onResize()},!1),q.resize_active=!0;return e};q.addResizeable=
function(a){c.GLCore.resizeList.push(a)};q.onResize=function(){var a=v.innerWidth,b=v.innerHeight;q.fixed_size!==null&&(a=c.GLCore.fixed_size[0],b=c.GLCore.fixed_size[1]);for(var h=0,e=c.GLCore.resizeList.length;h<e;h++)q.resizeElement(c.GLCore.resizeList[h],a,b)};q.setFixedAspect=function(a){c.GLCore.fixed_aspect=a};q.setFixedSize=function(a,b){c.GLCore.fixed_size=[a,b]};q.getCanvas=function(){return c.GLCore.canvas};q.resizeElement=function(a,b,h){var e=q.gl;if(q.fixed_aspect!==0){var t=b*(1/c.GLCore.fixed_aspect);
t>h&&(t=h,b=h*c.GLCore.fixed_aspect);h=t}if(a.getContext!==o){a.width=b;a.height=h;if(!c.GLCore.fixed_size)a.style.left=(v.innerWidth/2-b/2|0)+"px",a.style.top=(v.innerHeight/2-h/2|0)+"px",a.style.position="absolute";e.viewport(0,0,b,h)}else a.resize(b,h)};q.setDepthAlpha=function(a,c,b){q.depth_alpha=a;q.depth_alpha_near=c;q.depth_alpha_far=b};q.setDefaultFilter=function(a){q.default_filter=a};q.setSoftShadows=function(a){q.soft_shadow=a};q.setCanvasSizeFactor=function(a){q.canvasSizeFactor=a};q.setQuality=
function(a){if(a===L.quality.HIGH)A.features=I.high;else if(a===L.quality.MEDIUM)A.features=I.medium;else if(a===L.quality.LOW)A.features=I.low;A.quality=a;return A.features};q.getQuality=function(){return A.features};var u={GLCore:q,init:q.init,addResizeable:q.addResizeable,setFixedAspect:q.setFixedAspect,setFixedSize:q.setFixedSize,setCanvasSizeFactor:q.setCanvasSizeFactor,getCanvas:q.getCanvas,enums:L,IdentityMatrix:[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],Textures:A.Textures,Textures_obj:A.Textures_obj,
Images:A.Images,globalAmbient:[0.1,0.1,0.1],setGlobalAmbient:function(a){c.globalAmbient=a},setGlobalDepthAlpha:q.setDepthAlpha,setDefaultFilter:q.setDefaultFilter,setSoftShadows:q.setSoftShadows,setQuality:q.setQuality,getQuality:q.getQuality,RegisterModule:g,getScriptLocation:function(){return d}};g("Core",function(){return u})})(window,window.document,Math,function(){});
(function(){function v(){for(var d=0;d<r.length;d++)importScripts(CubicVR.getScriptLocation()+"/source/CubicVR."+r[d]+".js")}var x,r=["Math","Utility","Shader","MainLoop","Texture","Material","Mesh","UVMapper","Renderer","Light","Camera","Motion","Scene","PostProcess","Layout","Primitives","COLLADA","GML","Particles","Landscape","Octree","CVRXML","Worker","Polygon","ScenePhysics","CollisionMap"];try{if(typeof define==="function"&&define.amd){var n=[];for(x=0;x<r.length;x++)n.push("order!./source/CubicVR."+
r[x]);define(n,function(){})}else for(x=0;x<r.length;x++)document.write('<script type="text/javascript" src="'+CubicVR.getScriptLocation()+"/source/CubicVR."+r[x]+'.js"><\/script>')}catch(o){var g=function(d){var m=d.data.data+"";CubicVR.getScriptLocation=function(){return m};v();self.removeEventListener("message",g,!1);CubicVR.InitWorker()};self.addEventListener("message",g,!1)}})();CubicVR.RegisterModule("COLLADA",function(v){function x(m,a){function b(a){if(!a.color)return!1;return(a=a.color)?h.floatDelimArray(a.$," "):!1}function e(a){var I;if(!a["float"])return!1;return I=(a=a["float"])?parseFloat(a.$):0,a=I}var h=CubicVR.util;new CubicVR.Mesh;new CubicVR.Scene;var c,q,t,s;cl=typeof m=="object"?m:m.indexOf(".js")!=-1?h.getJSON(m):CubicVR.util.xml2badgerfish(h.getXML(m));var L,A,o,u,D,B,z,w,y,v,C,E=cl;cl=null;if(!E.COLLADA)throw Error(m+" does not appear to be a valid COLLADA file.");
var E=E.COLLADA,x={up_axis:1,images:[],effects:[],materials:[],meshes:[],scenes:[],lights:[],cameras:[],animations:[]};if(E.asset){var J=E.asset.up_axis.$;if(J==="X_UP")x.up_axis=0;else if(J==="Y_UP")x.up_axis=1;else if(J==="Z_UP")x.up_axis=2}J=x.up_axis;if(E.library_images){if(E.library_images.image&&!E.library_images.image.length)E.library_images.image=[E.library_images.image];if(E.library_images.image.length){q=E.library_images.image;c=0;for(w=q.length;c<w;c++){var H=q[c],F=H["@id"];u=H["@name"];
H=H.init_from;if(H.$)H=H.$,a!==r&&H.lastIndexOf("/")!==-1&&(H=H.substr(H.lastIndexOf("/")+1)),a!==r&&H.lastIndexOf("\\")!==-1&&(H=H.substr(H.lastIndexOf("\\")+1)),x.images[F]={source:H,id:F,name:u}}}}var G,O,K,T,X;if(E.library_effects){var M=E.library_effects.effect;M&&!M.length&&(M=[M]);H=0;for(G=M.length;H<G;H++){w=M[H];u=w["@id"];s={};s.id=u;s.surfaces=[];s.samplers=[];(F=w.profile_COMMON.newparam)&&!F.length&&(F=[F]);if(F){q=0;for(c=F.length;q<c;q++){var R=F[q],N=R["@sid"];if(R.surface){if(s.surfaces[N]=
{},R=R.surface.init_from.$,typeof x.images[R]==="object")s.surfaces[N].source=a+"/"+x.images[R].source}else if(R.sampler2D){s.samplers[N]={};s.samplers[N].source=R.sampler2D.source.$;if(R.sampler2D.minfilter)s.samplers[N].minfilter=R.sampler2D.minfilter.$;if(R.sampler2D.magfilter)s.samplers[N].magfiter=R.sampler2D.magfilter.$}}}(q=w.profile_COMMON.technique)&&!q.length&&(q=[q]);s.material={textures_ref:[]};w=0;for(F=q.length;w<F;w++){c=q[w].blinn;if(!c)c=q[w].phong;if(!c)c=q[w].lambert;if(c)for(z in c){var U=
c[z],N=b(U),R=e(U);U=U.texture?U.texture["@texture"]:!1;N!==!1&&N.length>3&&N.pop();if(z=="emission"){if(N!==!1)s.material.ambient=N}else if(z!="ambient")if(z=="diffuse"){if(N!==!1)s.material.color=N}else if(z=="specular"){if(N!==!1)s.material.specular=N}else if(z=="shininess"&&R!==!1)s.material.shininess=R;if(U!==!1)N=s.surfaces[s.samplers[U].source].source,z=="emission"?s.material.textures_ref.push({image:N,type:n.texture.map.AMBIENT}):z=="ambient"?s.material.textures_ref.push({image:N,type:n.texture.map.AMBIENT}):
z=="diffuse"?s.material.textures_ref.push({image:N,type:n.texture.map.COLOR}):z=="specular"?s.material.textures_ref.push({image:N,type:n.texture.map.SPECULAR}):z!="shininess"&&(z=="reflective"?s.material.textures_ref.push({image:N,type:n.texture.map.REFLECT}):z!="reflectivity"&&z=="transparent"&&s.material.textures_ref.push({image:N,type:n.texture.map.ALPHA}))}x.effects[u]=s}}}w=d.getAllOf(E,"instance_geometry");z=[];if(w.length){c=0;for(q=w.length;c<q;c++)if(F=w[c],u=d.getAllOf(F,"instance_material"),
u.length){C=0;for(B=u.length;C<B;C++)G=u[C],H=G["@symbol"],G=G["@target"].substr(1),z[F["@url"].substr(1)+":"+H]=G}}q=E.library_materials;if(q.material){(w=q.material)&&!w.length&&(w=[w]);q=0;for(c=w.length;q<c;q++)if(u=w[q],F=u["@id"],H=u["@name"],u=u.instance_effect)u=u["@url"].substr(1),x.materials.push({id:F,name:H,mat:x.effects[u].material})}q=E.library_geometries;var Z;if(q&&((u=q.geometry)&&!u.length&&(u=[u]),u.length)){H=0;for(G=u.length;H<G;H++){var M={id:r,points:[],parts:[]},$=u[H].mesh;
if($){Z=u[H]["@id"];s=u[H]["@name"];(c=$.source)&&!c.length&&(c=[c]);s=[];w=0;for(F=c.length;w<F;w++)if(N=c[w],q=N["@id"],R=N["@name"],(U=N.float_array)&&(s[q]={id:q,name:R,data:h.floatDelimArray(U.$?U.$:""," ")}),N=N.technique_common.accessor)if(s[q].count=N["@count"]|0,s[q].stride=N["@stride"]|0,s[q].count)s[q].data=h.repackArray(s[q].data,s[q].stride,s[q].count);q=$.vertices;var S=U=R=N=null,aa=null;if(q&&(R=q["@id"],(c=q.input)&&!c.length&&(c=[c]),c)){o=0;for(O=c.length;o<O;o++)K=c[o],K["@semantic"]===
"POSITION"&&(N=K["@source"].substr(1))}var V=$.triangles;V&&!V.length&&(V=[V]);if(V){w=0;for(F=V.length;w<F;w++){X={material:0,faces:[],normals:[],texcoords:[],colors:[]};q=parseInt(V[w]["@count"],10);(c=V[w].input)&&!c.length&&(c=[c]);T=[];if(c.length){o=0;for(O=c.length;o<O;o++)K=c[o],D=parseInt(K["@offset"],10),t=K["@source"].substr(1),K["@semantic"]==="VERTEX"?(t===R&&(t=N),T[D]=0):K["@semantic"]==="NORMAL"?(U=t,s[U].count&&(T[D]=1)):K["@semantic"]==="TEXCOORD"?(aa=t,s[aa].count&&(T[D]=2)):K["@semantic"]===
"COLOR"?(S=t,s[S].count&&(T[D]=3)):T[D]=4}o=T.length;c=Z+":"+V[w]["@material"];c===null?X.material=0:z[c]===r?(g("missing material ["+c+"]@"+Z+"?"),X.material=0):X.material=z[c];c=V[w].p;o=[];c&&(o=h.intDelimArray(c.$," "));if(o.length&&(c=o.length/T.length/3,c===q)){if(M.points.length===0)M.points=s[N].data;c=D=0;q=o.length;for(D=T.length;c<q;c+=D*3){L=[];A=[];t=[];K=[];for(C=0;C<D*3;C++)O=C%D,T[O]===0?A.push(o[c+C]):T[O]===1?L.push(o[c+C]):T[O]===2?t.push(o[c+C]):T[O]===3&&K.push(o[c+C]);A.length&&
(X.faces.push(A),L.length===3&&X.normals.push([d.fixuaxis(x.up_axis,s[U].data[L[0]]),d.fixuaxis(x.up_axis,s[U].data[L[1]]),d.fixuaxis(x.up_axis,s[U].data[L[2]])]),t.length===3&&X.texcoords.push([s[aa].data[t[0]],s[aa].data[t[1]],s[aa].data[t[2]]]),K.length===3&&X.colors.push([s[S].data[K[0]],s[S].data[K[1]],s[S].data[K[2]]]))}}M.parts.push(X)}}V=$.polylist;if(!V)V=$.polygons;V&&!V.length&&(V=[V]);if(V){w=0;for(F=V.length;w<F;w++){X={material:0,faces:[],normals:[],texcoords:[],colors:[]};C=parseInt(V[w]["@count"],
10);(c=V[w].input)&&!c.length&&(c=[c]);T=[];if(c.length){o=0;for(O=c.length;o<O;o++)K=c[o],q=K["@offset"],q===null&&(q=K["@idx"]),D=parseInt(q,10),t=K["@source"].substr(1),K["@semantic"]==="VERTEX"?(t===R&&(t=N),T[D]=0):K["@semantic"]==="NORMAL"?(U=t,T[D]=1):K["@semantic"]==="TEXCOORD"?(aa=t,T[D]=2):K["@semantic"]==="COLOR"?(S=t,T[D]=3):T[D]=4}q=V[w].vcount;$=[];q&&($=h.intDelimArray(q.$," "));c=Z+":"+V[w]["@material"];X.material=c===r?0:z[c];K=V[w].p;o=T.length;O=[];if(K.length>1&&!$.length){q=0;
for(c=K.length;q<c;q++)D=h.intDelimArray(K[q].$," "),$[q]=parseInt(D.length/o,10),O.splice(O.length,0,D)}else K&&(O=h.intDelimArray(K.$," "));if(O.length)if(c=$.length,c!==C)g("poly vcount data doesn't add up, skipping object load: "+c+" !== "+C);else{if(M.points.length===0)M.points=s[N].data;c=D=0;for(q=$.length;c<q;c++){L=[];A=[];t=[];K=[];C=0;for(B=$[c]*o;C<B;C++)T[C%o]===0?A.push(O[D]):T[C%o]===1?L.push(O[D]):T[C%o]===2?t.push(O[D]):T[C%o]===3&&K.push(O[D]),D++;if(A.length){X.faces.push(A);if(L.length){C=
[];B=0;for(A=L.length;B<A;B++)C.push(d.fixuaxis(x.up_axis,s[U].data[L[B]]));X.normals.push(C)}if(t.length){C=[];B=0;for(A=t.length;B<A;B++)C.push(s[aa].data[t[B]]);X.texcoords.push(C)}if(K.length){C=[];B=0;for(A=K.length;B<A;B++)C.push(s[S].data[K[B]]);X.colors.push(C)}}}}M.parts.push(X)}}if(J!==1){c=0;for(q=M.points.length;c<q;c++)M.points[c]=d.fixuaxis(x.up_axis,M.points[c])}M.id=Z;x.meshes.push(M)}}}if(q=E.library_cameras){(u=q.camera)&&!u.length&&(u=[u]);z=0;for(w=u.length;z<w;z++){q=u[z];H=q["@id"];
G=F=c=0;if(q.optics&&q.optics.technique_common&&q.optics.technique_common.perspective)c=q.optics.technique_common.perspective.yfov,F=q.optics.technique_common.perspective.znear,G=q.optics.technique_common.perspective.zfar;var W;if(!c&&!F&&!G){(F=q.param)&&!F.length&&(F=[F]);c=0;for(q=F.length;c<q;c++)G=F[c].$,M=F[c]["@name"],M=="YFOV"?W=parseFloat(G):M=="ZNEAR"?y=parseFloat(G):M=="ZFAR"&&(v=parseFloat(G))}else W=c?parseFloat(c.$):60,y=F?parseFloat(F.$):0.1,v=G?parseFloat(G.$):1E3;x.cameras.push({id:H,
targeted:!1,fov:parseFloat(W),nearclip:parseFloat(y),farclip:parseFloat(v)})}}if(W=E.library_lights)if((W=W.light)&&!W.length&&(W=[W]),W){y=0;for(v=W.length;y<v;y++)if(cl_light=W[y],c=(q=cl_light.technique_common.point)?q:null,q=cl_light["@id"],c!==null)z=(z=c.intensity)?parseFloat(z.$):1,w=(w=c.distance)?parseFloat(w.$):10,c=c.color,K=[1,1,1],c&&(K=h.floatDelimArray(c.$," ")),x.lights.push({id:q,name:q,type:n.light.type.POINT,method:n.light.method.STATIC,diffuse:K,specular:[0,0,0],distance:w,intensity:z})}if(y=
E.library_visual_scenes){W=null;(W=y.visual_scene)&&!W.length&&(W=[W]);y=0;for(v=W.length;y<v;y++){u=W[y];z={id:u["@id"],sceneObjects:[],cameras:[],lights:[],parentMap:[]};w=[];var F=[],Y;if(q=E.library_nodes){(G=q.node)&&!G.length&&(G=[G]);w=[];c=0;for(q=G.length;c<q;c++)H=G[c],mnodeId=H["@id"],w[Y]=H;for(H=[u];H.length;){G=H.pop();if(G.node&&((C=G.node)&&!C.length&&(C=[C]),C)){c=0;for(q=C.length;c<q;c++)H.push(C[c])}if(G.instance_node){(M=G.instance_node)&&!M.length&&(M=[M]);c=0;for(q=M.length;c<
q;c++)if(s=M[c]["@url"].substr(1),w[s]){if(G.node&&G.node.length)G.node=[G.node];G.node?G.node.push(w[s]):G.node=[w[s]]}}}}for(H=[u];H.length;)if(G=H.pop(),G.node&&((C=G.node)&&!C.length&&(C=[C]),C)){c=0;for(q=C.length;c<q;c++)C[c].parentNode=G,F.push(C[c]),H.push(C[c])}if(F.length){u=0;for(H=F.length;u<H;u++){N=F[u];R=N.instance_geometry;cl_light=F[u].instance_light;q=F[u].instance_camera;Y=N["@id"];G=N["@name"];M=d.cl_getInitalTransform(x.up_axis,N);if(J===2)M.rotation=d.quaternionFilterZYYZ(M.rotation,
q?[-90,0,0]:r);S=U=null;if(R){R&&!R.length&&(R=[R]);c=0;for(q=R.length;c<q;c++){cl_geom=R[c];s=cl_geom["@url"].substr(1);S={};S.name=(G?G:Y)+(c?c:"");S.id=(Y?Y:G)+(c?c:"");S.meshId=Z;S.meshName=s;if(!U)S.position=M.position,S.rotation=M.rotation,S.scale=M.scale,S.matrix=M.matrix;z.sceneObjects.push(S);w[S.id]=!0;N.parentNode&&((parentNodeId=N.parentNode["@id"])&&w[parentNodeId]?z.parentMap.push({parent:parentNodeId,child:S.id}):R.length>1&&(U?w[U.id]&&z.parentMap.push({parent:U.id,child:S.id}):(U=
S,S={})))}}else q?(q=q["@url"].substr(1),z.cameras.push({name:G?G:Y,id:G?G:Y,source:q,position:M.position,rotation:M.rotation})):cl_light?(q=cl_light["@url"].substr(1),z.lights.push({name:G?G:Y,id:G?G:Y,source:q,position:M.position})):(S={position:M.position,rotation:M.rotation,scale:M.scale,matrix:M.matrix},S.name=G?G:Y,S.id=Y?Y:G,z.sceneObjects.push(S),w[S.id]=!0,N.parentNode&&(parentNodeId=N.parentNode["@id"])&&w[parentNodeId]&&z.parentMap.push({parent:parentNodeId,child:S.id}))}}x.scenes.push(z)}}if(Z=
E.library_animations)if((Y=Z.animation)&&!Y.length&&(Y=[Y]),Y){J=0;for(W=Y.length;J<W;J++){z=Y[J];Z=z["@id"];x.animations[Z]={};x.animations[Z].sources=[];(w=z.source)&&!w.length&&(w=[w]);if(w.length){y=0;for(v=w.length;y<v;y++){c=w[y];q=c["@id"];M=c.technique_common;u=F=null;c.name_array?F=h.textDelimArray(c.name_array.$," "):c.Name_array?F=h.textDelimArray(c.Name_array.$," "):c.float_array&&(u=h.floatDelimArray(c.float_array.$," "));c=0;G="";H=1;if(M)c=M,M=c.accessor,c=parseInt(M["@count"],10),
G=M["@source"].substr(1),(M=M["@stride"])&&(H=parseInt(M,10));x.animations[Z].sources[q]={data:F?F:u,count:c,source:G,stride:H};if(H!==1)x.animations[Z].sources[q].data=h.repackArray(x.animations[Z].sources[q].data,H,c)}}(w=z.sampler)&&!w.length&&(w=[w]);if(w){x.animations[Z].samplers=[];y=0;for(v=w.length;y<v;y++)if(q=w[y],F=q["@id"],(c=q.input)&&!c.length&&(c=[c]),c){H=[];u=0;for(q=c.length;u<q;u++)K=c[u],H[K["@semantic"]]=K["@source"].substr(1);x.animations[Z].samplers[F]=H}}(y=z.channel)&&!y.length&&
(y=[y]);if(y){x.animations[Z].channels=[];z=0;for(w=y.length;z<w;z++)q=y[z],v=q["@source"].substr(1),q=q["@target"],F=q.split("/"),c=F[0],F=F[1].split("."),x.animations[Z].channels.push({source:v,target:q,targetName:c,paramName:F[0],typeName:F[1]})}}}if(E=E.scene)if(u=E.instance_visual_scene)E=u["@url"].substr(1),x.scene=E;return x}var r=v.undef,n=CubicVR.enums,o=v.GLCore,g=v.log,d={fixuaxis:function(d,a){if(d===0)return[a[1],a[0],a[2]];else if(d===1)return a;else if(d===2)return[a[0],a[2],-a[1]]},
fixscaleaxis:function(d,a){if(d===0)return[a[1],a[0],a[2]];else if(d===1)return a;else if(d===2)return[a[0],a[2],a[1]]},fixukaxis:function(d,a,b,e){if(a===n.motion.POS&&b===n.motion.Z&&d===n.motion.Z)return-e;return e},getAllOf:function(d,a){for(var b=[d],e=[],h,c,q,t;b.length;)for(c in h=b.pop(),h)if(h.hasOwnProperty(c)){if(c===a)if(h[c].length){q=0;for(t=h[c].length;q<t;q++)e.push(h[c][q])}else e.push(h[c]);if(typeof h[c]=="object")if(h[c].length){q=0;for(t=h[c].length;q<t;q++)b.push(h[c][q])}else b.push(h[c])}return e},
quaternionFilterZYYZ:function(d,a){var b=CubicVR.vec3,e=d,h=new CubicVR.Quaternion;a!==r&&(e=b.add(d,a));h.fromEuler(e[0],e[2],-e[1]);return h.toEuler()},cl_getInitalTransform:function(m,a){var b=CubicVR.util,e={position:[0,0,0],rotation:[0,0,0],scale:[1,1,1]},h=a.translate,c=a.rotate,q=a.scale;if(a.matrix&&!h&&!c&&!q)return e;if(h)e.position=d.fixuaxis(m,b.floatDelimArray(h.$," "));if(c)for(var h=0,t=c.length;h<t;h++){var s=c[h],g=s["@sid"],s=b.floatDelimArray(s.$," ");if(g=="rotateX"||g=="rotationX")e.rotation[0]=
s[3];else if(g=="rotateY"||g=="rotationY")e.rotation[1]=s[3];else if(g=="rotateZ"||g=="rotationZ")e.rotation[2]=s[3]}if(q)e.scale=d.fixscaleaxis(m,b.floatDelimArray(q.$," "));return e}};return{loadCollada:function(m,a,b){var a=x(m,a,b),e=a.up_axis,h=[],c,q,t,s,g,A,I,u;q=0;for(t=a.materials.length;q<t;q++){g=a.materials[q];I=new CubicVR.Material(g.mat);A=0;for(s=g.mat.textures_ref.length;A<s;A++){u=g.mat.textures_ref[A];var D=null,D=v.Textures_ref[u.image]===void 0?new CubicVR.Texture(u.image,o.default_filter,
b,m):v.Textures_obj[v.Textures_ref[u.image]];I.setTexture(D,u.type)}h[g.id]=I}A=[];q=0;for(t=a.meshes.length;q<t;q++){var D=a.meshes[q],B=new CubicVR.Mesh(D.id);B.points=D.points;var z=!1;I=0;for(u=D.parts.length;I<u;I++){var w=D.parts[I];w.material!==0&&B.setFaceMaterial(h[w.material]);var y=w.normals.length?!0:!1,P=w.texcoords.length?!0:!1,C=w.colors.length?!0:!1;if(C)h[w.material].color_map=!0;s=0;for(g=w.faces.length;s<g;s++){var E=B.addFace(w.faces[s]);if(y)B.faces[E].point_normals=w.normals[s];
if(P)B.faces[E].uvs=w.texcoords[s];if(C)B.faces[E].point_colors=w.colors[s]}z|=y}B.faces.length&&(b?b.addMesh(m,m+":"+meshId,B):(z||B.calcNormals(),B.triangulateQuads(),B.compile()),A[D.id]=B)}t=[];m=0;for(s=a.cameras.length;m<s;m++)t[a.cameras[m].id]=a.cameras[m];D=[];s=0;for(g=a.lights.length;s<g;s++)D[a.lights[s].id]=a.lights[s];b={};h={};q={};m={};I=0;for(u=a.scenes.length;I<u;I++){B=a.scenes[I];z=new CubicVR.Scene;s=0;for(g=B.sceneObjects.length;s<g;s++)w=B.sceneObjects[s],y=new CubicVR.SceneObject(w),
y.obj=(A[w.meshName]?A[w.meshName]:A[w.meshId])||null,w.matrix&&y.setMatrix(w.matrix),b[w.id]=y,z.bindSceneObject(y);s=0;for(g=B.lights.length;s<g;s++)w=B.lights[s],y=new CubicVR.Light(D[w.source]),y.position=w.position,h[w.id]=y,z.bindLight(y);if(B.cameras.length)s=B.cameras[0],g=new CubicVR.Camera(t[s.source]),g.position=s.position,g.rotation=s.rotation,q[s.id]=g,z.camera=g;s=0;for(g=B.parentMap.length;s<g;s++)w=B.parentMap[s],b[w.parent].bindChild(b[w.child]);m[B.id]=z}for(var Q in a.animations)if(a.animations.hasOwnProperty(Q)&&
(A=a.animations[Q],A.channels.length)){cCount=0;for(s=A.channels.length;cCount<s;cCount++){t=A.channels[cCount];w=A.samplers[t.source];g=A.sources[w.INPUT];I=A.sources[w.OUTPUT];u=A.sources[w.INTERPOLATION];var D=A.sources[w.IN_TANGENT],B=A.sources[w.OUT_TANGENT],z=w.IN_TANGENT!==r,w=w.OUT_TANGENT!==r,y=null,C=b[t.targetName],P=q[t.targetName],J=h[t.targetName];if(C){if(C.motion===null)C.motion=new CubicVR.Motion;y=C.motion}else if(P){if(P.motion===null)P.motion=new CubicVR.Motion;y=P.motion}else if(J){if(J.motion===
null)J.motion=new CubicVR.Motion;y=J.motion}if(y!==null){C=n.motion.POS;E=n.motion.X;if(e===2)y.yzflip=!0;c=t.paramName;if(c==="rotateX"||c==="rotationX")C=n.motion.ROT,E=n.motion.X;else if(c==="rotateY"||c==="rotationY")C=n.motion.ROT,E=n.motion.Y;else if(c==="rotateZ"||c==="rotationZ")C=n.motion.ROT,E=n.motion.Z;else if(c==="location"){C=n.motion.POS;if(t.typeName==="X")E=n.motion.X;if(t.typeName==="Y")E=n.motion.Y;if(t.typeName==="Z")E=n.motion.Z}else if(c==="translate"){C=n.motion.POS;if(t.typeName===
"X")E=n.motion.X;if(t.typeName==="Y")E=n.motion.Y;if(t.typeName==="Z")E=n.motion.Z}else if(c==="LENS")continue;else if(c==="FOV")C=n.motion.FOV,E=3;else if(c==="ZNEAR")C=n.motion.NEARCLIP,E=3;else if(c==="ZFAR")C=n.motion.FARCLIP,E=3;else if(c==="intensity")C=n.motion.INTENSITY,E=3;if(J&&C<3)J.method=n.light.method.DYNAMIC;mCount=0;for(t=g.data.length;mCount<t;mCount++)if(k=null,typeof I.data[mCount]==="object"){i=0;for(iMax=I.data[mCount].length;i<iMax;i++)if(J=i,e===2&&i===2?J=1:e===2&&i===1&&(J=
2),k=y.setKey(C,J,g.data[mCount],d.fixukaxis(a.up_axis,C,J,I.data[mCount][i])),u)if(c=u.data[mCount][i],c==="LINEAR")k.shape=n.envelope.shape.LINE;else if(c==="BEZIER")k.shape=!z&&!w?n.envelope.shape.LINEAR:n.envelope.shape.BEZI}else if(J=E,ofs=0,P&&C===n.motion.ROT&&e===2&&J===0&&(ofs=-90),C===n.motion.ROT?k=y.setKey(C,J,g.data[mCount],I.data[mCount]+ofs):(e===2&&E===2?J=1:e===2&&E===1&&(J=2),k=y.setKey(C,J,g.data[mCount],d.fixukaxis(a.up_axis,C,J,I.data[mCount]))),u)if(c=u.data[mCount],c==="LINEAR")k.shape=
n.envelope.shape.LINE;else if(c==="BEZIER")if(!z&&!w)k.shape=n.envelope.shape.LINEAR,k.continutity=1;else{k.shape=n.envelope.shape.BEZ2;c=D.data[mCount][0];var H,F=B.data[mCount][0];C===n.motion.ROT?(H=D.data[mCount][1],J=B.data[mCount][1],k.param[0]=c-k.time,k.param[1]=H-k.value+ofs,k.param[2]=F-k.time,k.param[3]=J-k.value+ofs):(H=d.fixukaxis(a.up_axis,C,J,D.data[mCount][1]),J=d.fixukaxis(a.up_axis,C,J,B.data[mCount][1]),k.param[0]=c-k.time,k.param[1]=H-k.value,k.param[2]=F-k.time,k.param[3]=J-k.value)}}}}Q=
null;return Q=a.scene?m[a.scene]:m.pop()},parseCollada:x}});CubicVR.RegisterModule("CVRXML",function(v){function x(a,h,c,q){var t=CubicVR.util,s=null,d=null;q.triangles&&(d=t.intDelimArray(b.getTextNode(q,"triangles")," "));if(d&&(q.segments&&(s=t.intDelimArray(b.getTextNode(q,"segments")," ")),s===null&&(s=[0,parseInt(d.length/3,10)]),q=0,a.setFaceMaterial(h),d.length)){p=0;for(pMax=s.length;p<pMax;p+=2){h=s[p+1]*3;a.setSegment(s[p]);j=q;for(jMax=q+h;j<jMax;j+=3)t=a.addFace([d[j],d[j+1],d[j+2]]),c&&a.faces[t].setUV([c[j],c[j+1],c[j+2]]);q+=h}}}function r(a){var h=
CubicVR.util,c=new CubicVR.UVMapper,q=null,t=null;if(a.type)switch(q=b.getTextNode(a,"type"),q){case "planar":c.projection_mode=m.uv.projection.PLANAR;break;case "cylindrical":c.projection_mode=m.uv.projection.CYLINDRICAL;break;case "spherical":c.projection_mode=m.uv.projection.SPHERICAL;break;case "cubic":c.projection_mode=m.uv.projection.CUBIC}if(!q)return null;q==="uv"&&a.uv&&(t=b.getPoints(a,"uv"));if(a.axis)switch(b.getTextNode(a,"axis")){case "x":c.projection_axis=m.uv.axis.X;break;case "y":c.projection_axis=
m.uv.axis.Y;break;case "z":c.projection_axis=m.uv.axis.Z}if(a.center)c.center=h.floatDelimArray(b.getTextNode(a,"center"));if(a.rotation)c.rotation=h.floatDelimArray(b.getTextNode(a,"rotation"));if(a.scale)c.scale=h.floatDelimArray(b.getTextNode(a,"scale"));if(a.wrap_w)c.wrap_w_count=parseFloat(b.getTextNode(a,"wrap_w"));if(a.wrap_h)c.wrap_h_count=parseFloat(b.getTextNode(a,"wrap_h"));return q!==""&&q!=="uv"?c:t}function n(e,h){if(a[e]!==d)return a[e];var c=CubicVR.util,q,t,s,g;q=null;q=typeof e==
"object"?e:e.indexOf(".js")!=-1?c.getJSON(e):CubicVR.util.xml2badgerfish(c.getXML(e));if(q.root)q=q.root;if(q.properties)q=q.properties;c=new CubicVR.Mesh;q.points&&(s=b.getPoints(q,"points"))&&c.addPoint(s);var A=q.material;A&&!A.length&&(A=[A]);var o=[];if(A){q=0;for(s=A.length;q<s;q++){var u=A[q],n;n=u;var B=h,z=new CubicVR.Material(n.name?n.name.$:null);if(n.shininess)z.shininess=b.getFloatNode(n,"shininess",z.shininess)/100;z.opacity=b.getFloatNode(n,"alpha",z.opacity);z.max_smooth=b.getFloatNode(n,
"max_smooth",z.max_smooth);z.color=b.getFloatDelimNode(n,"color",z.color);z.ambient=b.getFloatDelimNode(n,"ambient",z.ambient);z.diffuse=b.getFloatDelimNode(n,"diffuse",z.diffuse);z.specular=b.getFloatDelimNode(n,"specular",z.specular);t=void 0;if(t=b.getTextNode(n,"texture"))t=(B?B:"")+t,tex=v.Textures_ref[t]!==d?v.Textures_obj[v.Textures_ref[t]]:new CubicVR.Texture(t),z.setTexture(tex,m.texture.map.COLOR);if(t=b.getTextNode(n,"texture_luminosity"))t=(B?B:"")+t,tex=v.Textures_ref[t]!==d?v.Textures_obj[v.Textures_ref[t]]:
new CubicVR.Texture(t),z.setTexture(tex,m.texture.map.AMBIENT);if(t=b.getTextNode(n,"texture_normal"))t=(B?B:"")+t,tex=v.Textures_ref[t]!==d?v.Textures_obj[v.Textures_ref[t]]:new CubicVR.Texture(t),z.setTexture(tex,m.texture.map.NORMAL);if(t=b.getTextNode(n,"texture_specular"))t=(B?B:"")+t,tex=v.Textures_ref[t]!==d?v.Textures_obj[v.Textures_ref[t]]:new CubicVR.Texture(t),z.setTexture(tex,m.texture.map.SPECULAR);if(t=b.getTextNode(n,"texture_bump"))t=(B?B:"")+t,tex=v.Textures_ref[t]!==d?v.Textures_obj[v.Textures_ref[t]]:
new CubicVR.Texture(t),z.setTexture(tex,m.texture.map.BUMP);if(t=b.getTextNode(n,"texture_envsphere"))t=(B?B:"")+t,tex=v.Textures_ref[t]!==d?v.Textures_obj[v.Textures_ref[t]]:new CubicVR.Texture(t),z.setTexture(tex,m.texture.map.ENVSPHERE);if(t=b.getTextNode(n,"texture_alpha"))t=(B?B:"")+t,tex=v.Textures_ref[t]!==d?v.Textures_obj[v.Textures_ref[t]]:new CubicVR.Texture(t),z.setTexture(tex,m.texture.map.ALPHA);n=z;var w=null;t=B=null;u.uvmapper&&((B=r(u.uvmapper))&&!B.length?o.push([B,n]):t=B);(z=u.part)&&
!z.length&&(z=[z]);if(z&&z.length){var y=null,P=null;t=0;for(g=z.length;t<g;t++){var C=z[t],y=null;if(w=C.uvmapper)if(y=r(w),u.triangles)P=w=c.faces.length,y&&!y.length?(x(c,n,null,C),P=c.faces.length-1,c.calcFaceNormals(w,P),y.apply(c,n,d,w,P)):y&&y.length?x(c,n,y,C):B&&!B.length&&(x(c,n,null,C),P=c.faces.length-1,c.calcFaceNormals(w,P),B.apply(c,n,d,w,P));if(C.procedural){(w=C.uvmapper)&&(y=r(w));var P=C.transform?b.getTransform(C.transform):d,w=d,C=C.procedural,E=b.getTextNode(C,"type");P&&(w=
new CubicVR.Transform,w.translate(P.position),w.pushMatrix(),w.rotate(P.rotation),w.pushMatrix(),w.scale(P.scale));B||(B=d);y={material:n,uvmapper:B||y};if(E==="box"||E==="cube")y.size=b.getFloatNode(C,"size"),c.booleanAdd(CubicVR.primitives.box(y),w);else if(E==="sphere")y.radius=b.getFloatNode(C,"radius"),y.lat=b.getIntNode(C,"lat"),y.lon=b.getIntNode(C,"lon"),c.booleanAdd(CubicVR.primitives.sphere(y),w);else if(E==="cone")y.base=b.getFloatNode(C,"base"),y.height=b.getFloatNode(C,"height"),y.lon=
b.getIntNode(C,"lon"),c.booleanAdd(CubicVR.primitives.cone(y),w);else if(E==="plane")y.size=b.getFloatNode(C,"size"),c.booleanAdd(CubicVR.primitives.plane(y),w);else if(E==="cylinder")y.radius=b.getFloatNode(C,"radius"),y.height=b.getFloatNode(C,"height"),y.lon=b.getIntNode(C,"lon"),c.booleanAdd(CubicVR.primitives.cylinder(y),w);else if(E==="torus")y.innerRadius=b.getFloatNode(C,"innerRadius"),y.outerRadius=b.getFloatNode(C,"outerRadius"),y.lat=b.getIntNode(C,"lat"),y.lon=b.getIntNode(C,"lon"),c.booleanAdd(CubicVR.primitives.torus(y),
w);else if(E==="lathe")y.points=b.getPoints(C,"p"),y.lon=b.getIntNode(C,"lon"),c.booleanAdd(CubicVR.primitives.lathe(y),w);else if(E==="polygon"){P=b.getPoints(C,"p");P=new CubicVR.Polygon(P);(E=C.cut)&&!E.length&&(E=[E]);if(E.length){t=0;for(s=E.length;t<g;t++)P.cut(new CubicVR.Polygon(b.getPoints(E[t])))}y.front=0;y.back=0;y.frontShift=0;y.backShift=0;y.frontDepth=0;y.backDepth=0;if(C.extrude){C=C.extrude;y.front=b.getFloatNode(C,"front",0);y.back=b.getFloatNode(C,"back",0);y.frontShift=b.getFloatNode(C,
"frontBevelShift",0);y.backShift=b.getFloatNode(C,"backBevelShift",0);y.frontDepth=b.getFloatNode(C,"frontBevelDepth",0);y.backDepth=b.getFloatNode(C,"backBevelDepth",0);y.depth=b.getFloatNode(C,"depth",0);y.shift=b.getFloatNode(C,"shift",0);y.bevel=b.getFloatNode(C,"bevel",0);if(y.depth&&!y.backDepth&&!y.frontDepth)y.front=-y.depth/2,y.back=y.depth/2;if(y.shift&&!y.backShift&&!y.frontShift)y.frontShift=y.shift,y.backShift=y.shift;if(y.bevel&&!y.backDepth&&!y.frontDepth)y.frontDepth=y.bevel,y.backDepth=
y.bevel}C=P.toExtrudedBeveledMesh(new CubicVR.Mesh,y);C.setFaceMaterial(y.material);c.booleanAdd(C,w)}}}}else x(c,n,t,u)}}c.triangulateQuads();c.calcNormals();q=0;for(s=o.length;q<s;q++)o[q][0].apply(c,o[q][1]);c.compile();return a[e]=c}function o(a){if(a===null)return!1;return a.getElementsByTagName("x").length||a.getElementsByTagName("y").length||a.getElementsByTagName("z").length||a.getElementsByTagName("fov").length}function g(a,b,c){var q=CubicVR.util,t=[];t[0]=a.getElementsByTagName("x");t[1]=
a.getElementsByTagName("y");t[2]=a.getElementsByTagName("z");t[3]=a.getElementsByTagName("fov");var s,g,A,n,u,o;for(o in t)if(t.hasOwnProperty(o)&&t[o]!==d&&t[o].length){s=t[o][0].getElementsByTagName("time");g=t[o][0].getElementsByTagName("value");A=t[o][0].getElementsByTagName("in");n=t[o][0].getElementsByTagName("out");u=t[o][0].getElementsByTagName("tcb");var r=null,z=null,w=null,y=a=null;A.length&&(a=q.collectTextNode(A[0]));n.length&&(y=q.collectTextNode(n[0]));s.length&&(r=q.floatDelimArray(q.collectTextNode(s[0]),
" "));g.length&&(z=q.floatDelimArray(q.collectTextNode(g[0])," "));u.length&&(w=q.floatDelimArray(q.collectTextNode(u[0])," "));if(r!==null&&z!==null){s=0;for(g=r.length;s<g;s++)if(A=c.setKey(b,o,r[s],z[s]),w)A.tension=w[s*3],A.continuity=w[s*3+1],A.bias=w[s*3+2]}z=r=m.envelope.behavior.CONSTANT;if(a)switch(a){case "reset":r=m.envelope.behavior.RESET;break;case "constant":r=m.envelope.behavior.CONSTANT;break;case "repeat":r=m.envelope.behavior.REPEAT;break;case "oscillate":r=m.envelope.behavior.OSCILLATE;
break;case "offset":r=m.envelope.behavior.OFFSET;break;case "linear":r=m.envelope.behavior.LINEAR}if(y)switch(y){case "reset":z=m.envelope.behavior.RESET;break;case "constant":z=m.envelope.behavior.CONSTANT;break;case "repeat":z=m.envelope.behavior.REPEAT;break;case "oscillate":z=m.envelope.behavior.OSCILLATE;break;case "offset":z=m.envelope.behavior.OFFSET;break;case "linear":z=m.envelope.behavior.LINEAR}c.setBehavior(b,o,r,z)}}var d=v.undef,m=CubicVR.enums,a=[],b={getPoints:function(a,h,c){a=h?
b.getTextNode(a,h):a.$;if(!a)return d;a=a.split(" ");i=0;for(iMax=a.length;i<iMax;i++){a[i]=a[i].split(",");j=0;for(jMax=a[i].length;j<jMax;j++)a[i][j]=parseFloat(a[i][j]);c&&(a[i][2]=0)}return a},getTransform:function(a){var b=CubicVR.util;if(!a)return null;var c={position:[0,0,0],rotation:[0,0,0],scale:[1,1,1]},q;postition=a.position;q=a.rotation;a=a.scale;if(q)c.rotation=b.floatDelimArray(q.$);if(a)c.scale=b.floatDelimArray(a.$);if(q||a)return c;return null},getTextNode:function(a,b,c){a=a[b];
if(!a)return c;a.length&&(a=a[0]);if(a.$)return a.$;return c},getFloatNode:function(a,h,c){if(a=b.getTextNode(a,h)){a=parseFloat(a);if(a!=a)return c;return a}return c},getIntNode:function(a,h,c){if(a=b.getTextNode(a,h)){a=parseInt(a,10);if(a!=a)return c;return a}return c},getFloatDelimNode:function(a,h,c,q){var t=CubicVR.util;if(a=b.getTextNode(a,h))return t.floatDelimArray(a,q);return c},getIntDelimNode:function(a,h,c,q){var t=CubicVR.util;if(a=b.getTextNode(a,h))return t.intDelimArray(a,q);return c}};
return{loadMesh:n,loadScene:function(a,b,c){var q=CubicVR.util;b===d&&(b="");c===d&&(c="");for(var t=new CubicVR.Mesh,s=q.getXML(a),a=new CubicVR.Scene,L=[],A=s.getElementsByTagName("sceneobjects"),I,u,r,B=0,z=A[0].childNodes.length;B<z;B++){var w=A[0].childNodes[B];if(w.tagName==="sceneobject"){var y="unnamed",x="",C="",t=w.getElementsByTagName("name");t.length&&(y=q.collectTextNode(t[0]));t=w.getElementsByTagName("parent");t.length&&(x=q.collectTextNode(t[0]));t=w.getElementsByTagName("model");
t.length&&(C=q.collectTextNode(t[0]));r=u=I=null;t=w.getElementsByTagName("position");t.length&&(I=t[0]);t=w.getElementsByTagName("rotation");t.length&&(u=t[0]);t=w.getElementsByTagName("scale");t.length&&(r=t[0]);t=null;C!==""&&(t=n(b+C,c));t=new CubicVR.SceneObject(t,y);if(o(I)){if(!t.motion)t.motion=new CubicVR.Motion;g(I,m.motion.POS,t.motion)}else if(I)t.position=q.floatDelimArray(q.collectTextNode(I));if(o(u)){if(!t.motion)t.motion=new CubicVR.Motion;g(u,m.motion.ROT,t.motion)}else t.rotation=
q.floatDelimArray(q.collectTextNode(u));if(o(r)){if(!t.motion)t.motion=new CubicVR.Motion;g(r,m.motion.SCL,t.motion)}else t.scale=q.floatDelimArray(q.collectTextNode(r));a.bindSceneObject(t);x!==""&&L.push([t,x])}}for(var v in L)L.hasOwnProperty(v)&&a.getSceneObject(L[v][1]).bindChild(L[v][0]);b=s.getElementsByTagName("camera");if(b.length){u=I=null;c="";t=b[0].getElementsByTagName("name");v=a.camera;s=null;if(t.length)c=t[0].firstChild.nodeValue;t=b[0].getElementsByTagName("target");if(t.length)c=
t[0].firstChild.nodeValue;if(c!=="")v.targetSceneObject=a.getSceneObject(c);t=b[0].getElementsByTagName("position");t.length&&(I=t[0]);t=b[0].getElementsByTagName("rotation");t.length&&(u=t[0]);t=b[0].getElementsByTagName("fov");t.length&&(s=t[0]);if(o(I)){if(!v.motion)v.motion=new CubicVR.Motion;g(I,m.motion.POS,v.motion)}else if(I)v.position=q.floatDelimArray(I.firstChild.nodeValue);if(o(u)){if(!v.motion)v.motion=new CubicVR.Motion;g(u,m.motion.ROT,v.motion)}else if(u)v.rotation=q.floatDelimArray(u.firstChild.nodeValue);
if(o(s)){if(!v.motion)v.motion=new CubicVR.Motion;g(s,m.motion.FOV,v.motion)}else if(s)v.fov=parseFloat(s.firstChild.nodeValue)}return a}}});CubicVR.RegisterModule("Camera",function(v){function x(a,b,e,h,c){var q=CubicVR.mat4;this.frustum=new CubicVR.Frustum;typeof a=="object"?(this.position=a.position?a.position:[0,0,0],this.rotation=a.rotation?a.rotation:[0,0,0],this.target=a.target?a.target:[0,0,0],this.fov=a.fov?a.fov:60,this.nearclip=a.nearclip?a.nearclip:0.1,this.farclip=a.farclip?a.farclip:400,this.targeted=a.targeted?a.targeted:!0,this.calc_nmatrix=a.calcNormalMatrix?a.calcNormalMatrix:!0,this.name=a.name||"camera"+m,b=a.height?
a.height:o,a=a.width?a.width:o):(this.position=[0,0,0],this.rotation=[0,0,0],this.target=[0,0,0],this.fov=e!==o?e:60,this.nearclip=h!==o?h:0.1,this.farclip=c!==o?c:400,this.calc_nmatrix=this.targeted=!0,this.name="camera"+m);this.motion=this.targetSceneObject=null;this.transform=new CubicVR.Transform;this.manual=!1;this.setDimensions(a!==o?a:512,b!==o?b:512);this.mvMatrix=q.identity();this.pMatrix=null;this.calcProjection();this.ortho=!1;this.ortho_view={left:-1,right:1,bottom:-1,top:1};this.parent=
null;++m}function r(a){this.position=a!==o?a:[0,0,0]}function n(a,b,e){this.camPath=new CubicVR.Motion;this.targetPath=new CubicVR.Motion;this.start_position=a!==o?a:[8,8,8];this.target=b!==o?b:[0,0,0];this.bounds=e!==o?e:[[-15,3,-15],[15,20,15]];this.safe_bb=[];this.avoid_sphere=[];this.segment_time=3;this.buffer_time=20;this.path_length=this.path_time=this.current_time=this.start_time=0;this.min_distance=2;this.angle_min=this.max_distance=40;this.angle_max=180}var o=v.undef,g=CubicVR.enums,d=[1,
0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],m=0;x.prototype={setParent:function(a){this.parent=a},hasParent:function(){return!!this.parent},getParent:function(){return this.parent},getParentedPosition:function(){return this.parent!==null&&this.mvMatrix&&this.parent.tMatrix?CubicVR.mat4.vec3_multiply(this.position,this.parent.tMatrix):this.position},setOrtho:function(a,b,e,h){this.ortho=!0;this.ortho_view.left=a;this.ortho_view.right=b;this.ortho_view.bottom=e;this.ortho_view.top=h},control:function(a,b,e){a===
g.motion.ROT?this.rotation[b]=e:a===g.motion.POS?this.position[b]=e:a===g.motion.FOV?this.setFOV(e):a===g.motion.LENS?this.setLENS(e):a===g.motion.NEARCLIP?this.setClip(e,this.farclip):a===g.motion.FARCLIP&&this.setClip(this.nearclip,e)},makeFrustum:function(a,b,e,h,c,q){return[2*c/(b-a),0,0,0,0,2*c/(h-e),0,0,(b+a)/(b-a),(h+e)/(h-e),-(q+c)/(q-c),-1,0,0,-2*q*c/(q-c),0]},setTargeted:function(a){this.targeted=a},calcProjection:function(){var a=CubicVR.mat4,b=CubicVR.mat3;this.pMatrix=this.ortho?a.ortho(this.ortho_view.left,
this.ortho_view.right,this.ortho_view.bottom,this.ortho_view.top,this.nearclip,this.farclip):a.perspective(this.fov,this.aspect,this.nearclip,this.farclip);if(!this.targeted)a.identity(this.mvMatrix),a.rotate(-this.rotation[0],-this.rotation[1],-this.rotation[2],this.mvMatrix),a.translate(-this.position[0],-this.position[1],-this.position[2],this.mvMatrix),this.parent!==null&&a.multiply(this.mvMatrix.slice(0),a.inverse(this.parent.tMatrix),this.mvMatrix),this.calc_nmatrix?(this.nMatrix=a.inverse_mat3(this.mvMatrix),
b.transpose_inline(this.nMatrix)):a.identity(this.nMatrix);this.frustum.extract(this,this.mvMatrix,this.pMatrix)},setClip:function(a,b){this.nearclip=a;this.farclip=b;this.calcProjection()},setDimensions:function(a,b){this.width=a;this.height=b;this.aspect=a/b;this.calcProjection()},resize:function(a,b){this.setDimensions(a,b)},setFOV:function(a){this.fov=a;this.ortho=!1;this.calcProjection()},setLENS:function(a){this.setFOV(2*Math.atan(16/a)*(180/Math.PI))},lookat:function(a,b,e,h,c,q,t,s,m){var g=
CubicVR.mat4,o=CubicVR.mat3;if(typeof a=="object")this.lookat(this.position[0],this.position[1],this.position[2],a[0],a[1],a[2],0,1,0);else{this.mvMatrix=g.lookat(a,b,e,h,c,q,t,s,m);if(this.rotation[2])this.transform.clearStack(),this.transform.rotate(-this.rotation[2],0,0,1),this.transform.pushMatrix(this.mvMatrix),this.mvMatrix=this.transform.getResult();this.parent!==null&&g.multiply(this.mvMatrix.slice(0),g.inverse(this.parent.tMatrix),this.mvMatrix);this.calc_nmatrix?(this.nMatrix=g.inverse_mat3(this.mvMatrix),
o.transpose_inline(this.nMatrix)):this.nMatrix=d;this.frustum.extract(this,this.mvMatrix,this.pMatrix)}},unProject:function(a,b,e){var h=CubicVR.mat4,c=CubicVR.vec3,q=[0,0,this.width,this.height],a=h.vec4_multiply(h.vec4_multiply([(a-q[0])/q[2]*2-1,-((b-q[1])/q[3]*2-1),1,1],h.inverse(this.pMatrix)),h.inverse(this.mvMatrix)),a=[a[0]/a[3],a[1]/a[3],a[2]/a[3]];if(e!==o)return b=this.getParentedPosition(),c.add(b,c.multiply(c.normalize(c.subtract(a,b)),e));return a},project:function(a,b,e){var h=CubicVR.mat4,
a=h.vec4_multiply(h.vec4_multiply([a,b,e,1],this.mvMatrix),this.pMatrix);return[(a[0]/a[3]+1)/2*this.width,(-a[1]/a[3]+1)/2*this.height,a[2]/a[3]*(this.farclip-this.nearclip)+this.nearclip]}};r.prototype={control:function(a,b,e){a===g.motion.POS&&(this.position[b]=e)}};n.prototype={inBounds:function(a){var b=CubicVR.vec3;if(!(a[0]>this.bounds[0][0]&&a[1]>this.bounds[0][1]&&a[2]>this.bounds[0][2]&&a[0]<this.bounds[1][0]&&a[1]<this.bounds[1][1]&&a[2]<this.bounds[1][2]))return!1;for(var e=0,h=this.avoid_sphere.length;e<
h;e++)if(b.length(a,this.avoid_sphere[e][0])<this.avoid_sphere[e][1])return!1;return!0},findNextNode:function(a,b){var e=CubicVR.vec3,h=[0,0,0],c=[0,0,0],q=h=0,t=!1;do if(c[0]=Math.random()-0.5,c[1]=Math.random()-0.5,c[2]=Math.random()-0.5,c=e.normalize(c),h=Math.random()*(this.max_distance-this.min_distance)+this.min_distance,h=e.add(b.position,e.multiply(c,h)),t=this.inBounds(h),q++,q>30){h=b.position;break}while(!t);return h},run:function(a){this.current_time=a;if(this.path_time===0)this.path_time=
this.current_time,this.camPath.setKey(g.motion.POS,g.motion.X,this.path_time,this.start_position[0]),this.camPath.setKey(g.motion.POS,g.motion.Y,this.path_time,this.start_position[1]),this.camPath.setKey(g.motion.POS,g.motion.Z,this.path_time,this.start_position[2]);for(;this.path_time<this.current_time+this.buffer_time;){this.path_time+=this.segment_time;var b=new r,e=new r;this.path_length&&this.camPath.apply(this.path_time-this.segment_time*2,b);this.camPath.apply(this.path_time-this.segment_time,
e);b=this.findNextNode(b,e);this.camPath.setKey(g.motion.POS,g.motion.X,this.path_time,b[0]);this.camPath.setKey(g.motion.POS,g.motion.Y,this.path_time,b[1]);this.camPath.setKey(g.motion.POS,g.motion.Z,this.path_time,b[2]);this.path_length++}b=new r;this.camPath.apply(a,b);return b.position},addSafeBound:function(a,b){this.safe_bb.push([a,b])},addAvoidSphere:function(a,b){this.avoid_sphere.push([a,b])}};return{Camera:x,AutoCamera:n}});CubicVR.RegisterModule("CollisionMap",function(){CubicVR.enums.collision={shape:{BOX:0,SPHERE:1,CYLINDER:2,CONE:3,CAPSULE:4,MESH:5,HEIGHTFIELD:6}};var v=function(x){this.shapes=[];this.result=null;if(x){x&&!x.length&&(x=[x]);for(var r=0,n=x.length;r<n;r++)this.addShape(x[r])}};v.prototype={addShape:function(x){x.position=x.position||[0,0,0];x.rotation=x.rotation||[0,0,0];x.size=x.size||[1,1,1];x.radius=x.radius||1;x.height=x.height||1;x.margin=x.margin||0;x.mesh=x.mesh||null;this.shapes.push(x)},
getShapes:function(){return this.shapes},setResult:function(x){this.result=x},getResult:function(){return this.result}};return{CollisionMap:v}});CubicVR.RegisterModule("GML",function(v){function x(n){var o=CubicVR.util;this.strokes=[];this.bounds=[1,1,1];this.origin=[0,0,0];this.upvector=[0,1,0];this.viewvector=[0,0,1];this.manual_pos=0;if(n!==r){var n=o.getXML(n),g=n.getElementsByTagName("header");if(!g.length)return null;var d=g[0],g=n.getElementsByTagName("environment");if(!g.length)return null;this.name=null;d=d.getElementsByTagName("name");if(d.length)this.name=o.collectTextNode(d[0]);d=g[0].getElementsByTagName("screenBounds");if(d.length)this.bounds=
[parseFloat(o.collectTextNode(d[0].getElementsByTagName("x")[0])),parseFloat(o.collectTextNode(d[0].getElementsByTagName("y")[0])),parseFloat(o.collectTextNode(d[0].getElementsByTagName("z")[0]))];d=g[0].getElementsByTagName("origin");if(d.length)this.origin=[parseFloat(o.collectTextNode(d[0].getElementsByTagName("x")[0])),parseFloat(o.collectTextNode(d[0].getElementsByTagName("y")[0])),parseFloat(o.collectTextNode(d[0].getElementsByTagName("z")[0]))];g=g[0].getElementsByTagName("up");if(g.length)this.upvector=
[parseFloat(o.collectTextNode(g[0].getElementsByTagName("x")[0])),parseFloat(o.collectTextNode(g[0].getElementsByTagName("y")[0])),parseFloat(o.collectTextNode(g[0].getElementsByTagName("z")[0]))];n=n.getElementsByTagName("drawing");g=0;for(d=n.length;g<d;g++)for(var m=n[g].getElementsByTagName("stroke"),a=0,b=0,e=0,h=0,c=0,q=m.length;c<q;c++){for(var t=m[c].getElementsByTagName("pt"),s=t.length,L=Array(s),A,I,u,D=0,B=s;D<B;D++)u=t[D],s=parseFloat(o.collectTextNode(u.getElementsByTagName("x")[0])),
A=parseFloat(o.collectTextNode(u.getElementsByTagName("y")[0])),I=parseFloat(o.collectTextNode(u.getElementsByTagName("z")[0])),u=parseFloat(o.collectTextNode(u.getElementsByTagName("time")[0])),this.upvector[0]===1?L[D]=[A!==A?0:A,s!==s?0:-s,I!==I?0:I,u]:this.upvector[1]===1?L[D]=[s!==s?0:s,A!==A?0:A,I!==I?0:I,u]:this.upvector[2]===1&&(L[D]=[s!==s?0:s,I!==I?0:-I,A!==A?0:A,u]),a<s&&(a=s),b<A&&(b=A),e<I&&(e=I),h<u&&(h=u);if(e>h){t=0;for(D=L.length;t<D;t++)s=L[t][3],L[t][3]=L[t][2],L[t][2]=s/this.bounds[2]}this.strokes[c]=
L}}}var r=v.undef;x.prototype={addStroke:function(n,o){var g=[];o===r&&(o=0.1);for(var d=0,m=n.length;d<m;d++){var a=[n[d][0],n[d][1],n[d][2]];this.manual_pos+=o;a.push(this.manual_pos);g.push(a)}this.strokes.push(g)},recenter:function(){var n=CubicVR.vec3,o=[0,0,0],g=[this.strokes[0][0][0],this.strokes[0][0][1],this.strokes[0][0][2]],d,m,a,b;a=0;for(b=this.strokes.length;a<b;a++){d=0;for(m=this.strokes[a].length;d<m;d++)o[0]>this.strokes[a][d][0]&&(o[0]=this.strokes[a][d][0]),o[1]>this.strokes[a][d][1]&&
(o[1]=this.strokes[a][d][1]),o[2]>this.strokes[a][d][2]&&(o[2]=this.strokes[a][d][2]),g[0]<this.strokes[a][d][0]&&(g[0]=this.strokes[a][d][0]),g[1]<this.strokes[a][d][1]&&(g[1]=this.strokes[a][d][1]),g[2]<this.strokes[a][d][2]&&(g[2]=this.strokes[a][d][2])}n=n.multiply(n.subtract(g,o),0.5);a=0;for(b=this.strokes.length;a<b;a++){d=0;for(m=this.strokes[a].length;d<m;d++)this.strokes[a][d][0]-=n[0],this.strokes[a][d][1]-=this.upvector[1]?n[1]:-n[1],this.strokes[a][d][2]-=n[2]}},generateObject:function(n,
o,g,d,m){var a=CubicVR.vec3;n===r&&(n=0);o===r&&(o=0);m===r&&(m=!1);d===r&&(d=0.02);g===r&&(g=0.015);for(var b=o!==0,e=0,h=0,c=new CubicVR.Mesh(this.name),q,t,s,L,A,I,u=0,D=this.strokes.length;u<D;u++){I=new CubicVR.Envelope;var B=new CubicVR.Envelope,z=new CubicVR.Envelope,w=this.strokes[u].length,y=0,x=[],C=[],v=0,Q=this.strokes[u];for(A=0;A<w;A++){var J=Q[A],H=I.addKey(J[3],J[0]),F=B.addKey(J[3],J[1]),G;G=m?z.addKey(J[3],J[2]):z.addKey(J[3],0);H.tension=0.5;F.tension=0.5;G.tension=0.5;A!==0?(q=
J[0]-q,t=J[1]-t,s=J[2]-s,L=J[3]-L,s=Math.sqrt(q*q+t*t+s*s),y+=s,x[A-1]=s,C[A-1]=L):v=J[3];q=J[0];t=J[1];s=J[2];L=J[3]}y=v;w=c.points.length;for(A=0;A<x.length;A++){v=C[A];Q=y;J=y+v;for(H=v/Math.ceil(x[A]/d*3);Q<J-H;Q+=H){Q===y&&(q=I.evaluate(Q),t=B.evaluate(Q),s=z.evaluate(Q));var O,F=I.evaluate(Q+H);G=B.evaluate(Q+H);O=z.evaluate(Q+H);var K;K=a.multiply(a.normalize(a.cross(this.viewvector,a.normalize([F-q,G-t,O-s]))),g/2);c.addPoint([q-K[0],-(t-K[1]),s-K[2]+(b?o/2:0)]);c.addPoint([q+K[0],-(t+K[1]),
s+K[2]+(b?o/2:0)]);q=F;t=G;s=O}y+=v}B=c.points.length;if(b){A=w;for(I=B;A<I;A++)c.addPoint([c.points[A][0],c.points[A][1],c.points[A][2]-(b?o/2:0)])}A=0;for(I=B-w;A<=I-4;A+=2)e%n===0&&h++,c.setSegment(h),z=[w+A,w+A+1,w+A+3,w+A+2],c.addFace(z),b&&(z=[z[3]+B-w,z[2]+B-w,z[1]+B-w,z[0]+B-w],c.addFace(z),z=[w+A,w+A+2,w+A+2+B-w,w+A+B-w],c.addFace(z),z=[w+A+1+B-w,w+A+3+B-w,w+A+3,w+A+1],c.addFace(z),A===0&&(z=[w+A+B-w,w+A+1+B-w,w+A+1,w+A],c.addFace(z)),A===I-4&&(z=[w+A+2,w+A+3,w+A+3+B-w,w+A+2+B-w],c.addFace(z))),
e++}c.calcFaceNormals();c.triangulateQuads();c.calcNormals();c.compile();return c}};return{GML:x}});CubicVR.RegisterModule("Landscape",function(v){function x(g,d,m,a){this.doTransform=function(){};this.tMatrix=n;this.parent=null;this.position=[0,0,0];this.scale=[1,1,1];this.size=g;this.divisions_w=d;this.divisions_h=m;this.matRef=a;this.children=null;this.obj=new CubicVR.Mesh;this.divisions_w>this.divisions_h?(this.size_w=g,this.size_h=g/this.divisions_w*this.divisions_h):(this.size_w=this.divisions_h>this.divisions_w?g/this.divisions_h*this.divisions_w:g,this.size_h=g);for(d=-(this.size_h/2);d<
this.size_h/2;d+=this.size_h/this.divisions_h)for(g=-(this.size_w/2);g<this.size_w/2;g+=this.size_w/this.divisions_w)this.obj.addPoint([g+this.size_w/this.divisions_w/2,0,d+this.size_h/this.divisions_h/2]);this.obj.setFaceMaterial(this.matRef);for(d=0;d<this.divisions_h-1;d++)for(g=0;g<this.divisions_w-1;g++)this.obj.addFace([g+(d+1)*this.divisions_w,g+1+d*this.divisions_w,g+d*this.divisions_w]),this.obj.addFace([g+(d+1)*this.divisions_w,g+1+(d+1)*this.divisions_w,g+1+d*this.divisions_w])}var r=v.undef,
n=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],o=Math.PI/2;x.prototype={getMesh:function(){return this.obj},setIndexedHeight:function(g,d,m){obj.points[g+d*this.divisions_w][1]=m},mapGen:function(g,d,m,a,b){if(d!==r&&m!==r&&a!==r&&b!==r){if(!(d>=this.divisions_w)&&!(m>=this.divisions_h)&&(d+a>=this.divisions_w&&(a=this.divisions_w-1-d),m+b>=this.divisions_h&&(b=this.divisions_h-1-m),!(a<=0||b<=0)))for(var e=d,a=d+a;e<a;e++)for(var h=m,c=m+b;h<c;h++)d=this.obj.points[e+h*this.divisions_w],d[1]=g(d[0],d[2])}else{m=
0;for(b=this.obj.points.length;m<b;m++)d=this.obj.points[m],d[1]=g(d[0],d[2])}},getFaceAt:function(g,d){if(typeof g==="object")return this.getFaceAt(g[0],g[2]);var m=this.size_h/2-this.size_h/this.divisions_h/2,a=parseInt(Math.floor((g+(this.size_w/2-this.size_w/this.divisions_w/2))/this.size_w*this.divisions_w),10),m=parseInt(Math.floor((d+m)/this.size_h*this.divisions_h),10);if(a<0)return-1;if(a>=this.divisions_w-1)return-1;if(m<0)return-1;if(m>=this.divisions_h-1)return-1;var a=parseInt(a+m*(this.divisions_w-
1),10)*2,m=parseInt(a+1,10),b=this.obj.points[this.obj.faces[a].points[0]];return Math.abs(d-b[2])/Math.abs(g-b[0])>=1?a:m},getHeightValue:function(g,d){var m=CubicVR.triangle;if(typeof g==="object")return this.getHeightValue(g[0],g[2]);var a,b=this.getFaceAt(g,d);if(b===-1)return 0;a=this.obj.points[this.obj.faces[b].points[0]];var e=m.normal(this.obj.points[this.obj.faces[b].points[0]],this.obj.points[this.obj.faces[b].points[1]],this.obj.points[this.obj.faces[b].points[2]]),m=e[0],b=e[1],e=e[2];
return(m*g+e*d+(-(m*a[0])-b*a[1]-e*a[2]))/-b},orient:function(g,d,m,a,b,e){e===r&&(e=0);var h,c,q=[];h=m/2;var t=a/2;c=Math.sqrt(t*t+h*h);t=Math.atan2(t,h);b*=Math.PI/180;h=g+Math.sin(b)*e;e=d+Math.cos(b)*e;q[0]=this.getHeightValue([h+c*Math.cos(-t-o+b),0,e+c*-Math.sin(-t-o+b)]);q[1]=this.getHeightValue([h+c*Math.cos(t-o+b),0,e+c*-Math.sin(t-o+b)]);q[2]=this.getHeightValue([h+c*Math.cos(-t+o+b),0,e+c*-Math.sin(-t+o+b)]);q[3]=this.getHeightValue([h+c*Math.cos(t+o+b),0,e+c*-Math.sin(t+o+b)]);c=-Math.atan2(q[1]-
q[2],m);e=-Math.atan2(q[0]-q[1],a);c+=-Math.atan2(q[0]-q[3],m);e+=-Math.atan2(q[3]-q[2],a);c/=2;e/=2;return[[g,(q[2]+q[3]+q[1]+q[0])/4,d],[c*(180/Math.PI),b,e*(180/Math.PI)]]}};return{Landscape:x}});CubicVR.RegisterModule("Layout",function(){function v(r){this.texture=r.texture?r.texture:null;this.width=r.width?r.width:128;this.height=r.height?r.height:128;this.x=r.x?r.x:0;this.y=r.y?r.y:0;this.blend=r.blend?r.blend:!1;this.opacity=typeof r.opacity!=="undefined"?r.opacity:1;this.tint=r.tint?r.tint:[1,1,1];this.type="view";this.superView=null;this.childViews=[];this.panel=null}function x(r){this.texture=r.texture?r.texture:null;this.width=r.width?r.width:128;this.height=r.height?r.height:128;
this.x=r.x?r.x:0;this.y=r.y?r.y:0;this.blend=r.blend?r.blend:!1;this.opacity=typeof r.opacity!=="undefined"?r.opacity:1;this.tint=r.tint?r.tint:[1,1,1];this.type="root";this.superView=null;this.childViews=[];this.setupShader();this.panel=null;this.makePanel(this)}v.prototype={addSubview:function(r){this.childViews.push(r);r.superView=this},makePanel:function(r){return this.superView.makePanel(r)}};x.prototype={resize:function(r,n){this.width=r;this.height=n},setupShader:function(){this.shader=new CubicVR.PostProcessShader({shader_vertex:"attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nuniform vec3 screen;\nuniform vec3 position;\nuniform vec3 size;\nvoid main(void) {\nvTex = aTex;\nvec4 vPos = vec4(aVertex.xyz,1.0);\nvPos.x *= size.x/screen.x;\nvPos.y *= size.y/screen.y;\nvPos.x += (size.x/screen.x);\nvPos.y -= (size.y/screen.y);\nvPos.x += (position.x/screen.x)*2.0 - 1.0;\nvPos.y -= (position.y/screen.y)*2.0 - 1.0;\ngl_Position = vPos;\n}",
shader_fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D srcTex;\nuniform vec3 tint;\nvarying vec2 vTex;\nvoid main(void) {\nvec4 color = texture2D(srcTex, vTex)*vec4(tint,1.0);\ngl_FragColor = color;\n}",init:function(r){r.setInt("srcTex",0);r.addVector("screen");r.addVector("position");r.addVector("tint");r.addVector("size")}})},addSubview:function(r){this.childViews.push(r);r.superView=this},removeSubview:function(r){r=this.childViews.indexOf(r);r>-1&&this.childViews.splice(r,
1)},makePanel:function(r){var n=CubicVR.GLCore.gl,o={};o.vbo_points=new Float32Array([-1,-1,0,1,-1,0,1,1,0,-1,1,0,-1,-1,0,1,1,0]);o.vbo_uvs=new Float32Array([0,0,1,0,1,1,0,1,0,0,1,1]);o.gl_points=n.createBuffer();n.bindBuffer(n.ARRAY_BUFFER,o.gl_points);n.bufferData(n.ARRAY_BUFFER,o.vbo_points,n.STATIC_DRAW);o.gl_uvs=n.createBuffer();n.bindBuffer(n.ARRAY_BUFFER,o.gl_uvs);n.bufferData(n.ARRAY_BUFFER,o.vbo_uvs,n.STATIC_DRAW);r.panel=o},renderPanel:function(r){if(!r.texture)return!1;r.texture.use(CubicVR.GLCore.gl.TEXTURE0)},
renderView:function(r){if(r.texture){var n=CubicVR.GLCore.gl,o=r.offsetLeft,g=r.offsetTop;o||(o=0);g||(g=0);var d=this.shader.shader;d.use();d.setVector("screen",[this.width,this.height,0]);d.setVector("position",[r.x+o,r.y+g,0]);d.setVector("size",[r.width,r.height,0]);d.setVector("tint",r.tint);r.blend&&(n.enable(n.BLEND),n.blendFunc(n.SRC_ALPHA,n.ONE_MINUS_SRC_ALPHA));r.texture.use(n.TEXTURE0);n.drawArrays(n.TRIANGLES,0,6);r.blend&&(n.disable(n.BLEND),n.blendFunc(n.ONE,n.ZERO))}},render:function(){var r=
CubicVR.GLCore.gl;r.disable(r.DEPTH_TEST);this.texture&&this.renderView(this);var n=[];this.offsetTop=this.offsetLeft=0;n.push(this);shader=this.shader.shader;shader.use();r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,null);r.bindBuffer(r.ARRAY_BUFFER,this.panel.gl_points);r.vertexAttribPointer(shader.uniforms.aVertex,3,r.FLOAT,!1,0,0);r.enableVertexAttribArray(shader.uniforms.aVertex);r.bindBuffer(r.ARRAY_BUFFER,this.panel.gl_uvs);r.vertexAttribPointer(shader.uniforms.aTex,2,r.FLOAT,!1,0,0);r.enableVertexAttribArray(shader.uniforms.aTex);
for(r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,null);n.length;){var o=n.pop();this.renderView(o);if(o.childViews.length)for(var g=o.childViews.length-1;g>=0;g--)o.childViews[g].offsetLeft=o.x+o.offsetLeft,o.childViews[g].offsetTop=o.y+o.offsetTop,n.push(o.childViews[g])}r.disableVertexAttribArray(shader.uniforms.aTex);r.enable(r.DEPTH_TEST)}};return{Layout:x,View:v}});CubicVR.RegisterModule("Light",function(v){function x(d,m){var a=CubicVR.aabb;if(d===o)d=n.light.type.POINT;if(m===o)m=n.light.method.DYNAMIC;typeof d=="object"?(this.light_type=d.type!==o?d.type:n.light.type.POINT,this.diffuse=d.diffuse!==o?d.diffuse:[1,1,1],this.specular=d.specular!==o?d.specular:[1,1,1],this.intensity=d.intensity!==o?d.intensity:1,this.position=d.position!==o?d.position:[0,0,0],this.direction=d.direction!==o?d.direction:[0,0,0],this.distance=d.distance!==o?d.distance:this.light_type===
n.light.type.AREA?30:10,this.cutoff=d.cutoff!==o?d.cutoff:60,this.map_res=d.map_res!==o?d.map_res:this.light_type===n.light.type.AREA?2048:512,this.map_res=d.mapRes!==o?d.mapRes:this.map_res,this.method=d.method!==o?d.method:m,this.areaCam=d.areaCam!==o?d.areaCam:null,this.areaCeiling=d.areaCeiling!==o?d.areaCeiling:40,this.areaFloor=d.areaFloor!==o?d.areaFloor:-40,this.areaAxis=d.areaAxis!==o?d.areaAxis:[1,1,0],this.projectorTex=d.projector!==o?d.projector:null):(this.light_type=d,this.diffuse=[1,
1,1],this.specular=[1,1,1],this.intensity=1,this.position=[0,0,0],this.direction=[0,0,0],this.distance=this.light_type===n.light.type.AREA?30:10,this.cutoff=60,this.map_res=this.light_type===n.light.type.AREA?2048:512,this.method=m,this.areaCam=null,this.areaCeiling=40,this.areaFloor=-40,this.areaAxis=[1,1,0],this.projectorTex=null);this.setType(this.light_type);this.lposition=[0,0,0];this.dirty=!0;this.octree_leaves=[];this.octree_common_root=null;this.octree_aabb=[[0,0,0],[0,0,0]];this.ignore_octree=
!1;this.was_culled=this.culled=this.visible=!0;this.aabb=[[0,0,0],[0,0,0]];a.reset(this.aabb,this.position);this.adjust_octree=CubicVR.SceneObject.prototype.adjust_octree;this.motion=null;this.rotation=[0,0,0];(this.light_type===n.light.type.SPOT_SHADOW||this.light_type===n.light.type.SPOT_SHADOW_PROJECTOR||this.light_type===n.light.type.AREA&&v.features.lightShadows)&&this.setShadow(this.map_res);this.lDir=[0,0,0];this.lPos=[0,0,0];this.parent=null}var r=v.GLCore,n=CubicVR.enums,o=v.undef,g=[1,0,
0,0,0,1,0,0,0,0,1,0,0,0,0,1];n.light={type:{NULL:0,POINT:1,DIRECTIONAL:2,SPOT:3,AREA:4,DEPTH_PACK:5,SPOT_SHADOW:6,SPOT_SHADOW_PROJECTOR:7,MAX:8},method:{GLOBAL:0,STATIC:1,DYNAMIC:2}};x.prototype={setType:function(d){if(d===n.light.type.AREA&&!v.features.lightShadows)this.dummyCam=new CubicVR.Camera,this.areaCam=new CubicVR.Camera,this.updateAreaLight(),this.areaCam=this.dummyCam=null,d=n.light.type.DIRECTIONAL;else if((d===n.light.type.SPOT_SHADOW||d===n.light.type.SPOT_SHADOW_PROJECTOR)&&!v.features.lightShadows)d=
n.light.type.SPOT;this.light_type=d},setParent:function(d){this.parent=d},setMethod:function(d){this.method=d},setDiffuse:function(d){this.diffuse=d},setSpecular:function(d){this.specular=d},setIntensity:function(d){this.intensity=d},setPosition:function(d){this.position=d},setDistance:function(d){this.distance=d},setCutoff:function(d){this.cutoff=d},prepare:function(d){var m=CubicVR.mat4,a=CubicVR.mat3,b=this.light_type;if(this.parent)if(b===n.light.type.SPOT||b===n.light.type.SPOT_SHADOW||b===n.light.type.SPOT_SHADOW_PROJECTOR)b=
m.inverse_mat3(this.parent.tMatrix),a.transpose_inline(b),this.lDir=a.vec3_multiply(this.direction,b),this.lDir=a.vec3_multiply(this.lDir,d.nMatrix),this.lPos=m.vec3_multiply(this.position,m.multiply(d.mvMatrix,this.parent.tMatrix));else{if(b===n.light.type.POINT)this.lPos=m.vec3_multiply(this.position,m.multiply(d.mvMatrix,this.parent.tMatrix))}else if(b===n.light.type.DIRECTIONAL)this.lDir=a.vec3_multiply(this.direction,d.nMatrix);else if(b===n.light.type.SPOT||b===n.light.type.SPOT_SHADOW||b===
n.light.type.SPOT_SHADOW_PROJECTOR)this.lDir=a.vec3_multiply(this.direction,d.nMatrix),this.lPos=m.vec3_multiply(this.position,d.mvMatrix);else if(b===n.light.type.POINT)this.lPos=m.vec3_multiply(this.position,d.mvMatrix);else if(b===n.light.type.AREA)this.lDir=a.vec3_multiply(this.direction,d.nMatrix)},control:function(d,m,a){if(d===n.motion.POS)this.position[m]=a;else if(d===n.motion.INTENSITY)this.intensity=a},getAABB:function(){var d=CubicVR.vec3,m=CubicVR.aabb,a=[[0,0,0],[0,0,0]];m.engulf(a,
[this.distance,this.distance,this.distance]);m.engulf(a,[-this.distance,-this.distance,-this.distance]);a[0]=d.add(a[0],this.position);a[1]=d.add(a[1],this.position);return this.aabb=a},setDirection:function(d,m,a){var b=CubicVR.vec3;if(typeof d==="object")this.setDirection(d[0],d[1],d[2]);else return this.direction=b.normalize([d,m,a]),this},lookat:function(d,m,a){var b=CubicVR.vec3;if(typeof d==="object")this.lookat(d[0],d[1],d[2]);else return this.direction=b.normalize(b.subtract([d,m,a],this.position)),
this},setRotation:function(d,m,a){var b=CubicVR.mat4,e=CubicVR.vec3;if(typeof d==="object")this.setRotation(d[0],d[1],d[2]);else{var h=new CubicVR.Transform;h.rotate([-d,-m,-a]);h.pushMatrix();this.direction=e.normalize(b.vec3_multiply([1,0,0],h.getResult()));this.rotation=[d,m,a];return this}},setupShader:function(d,m){var a=r.gl;a.uniform3fv(d.lDiff[m],this.diffuse);a.uniform3fv(d.lSpec[m],this.specular);this.lPos&&a.uniform3fv(d.lPos[m],this.lPos);this.lDir&&a.uniform3fv(d.lDir[m],this.lDir);a.uniform1f(d.lInt[m],
this.intensity);a.uniform1f(d.lDist[m],this.distance);(this.light_type===n.light.type.SPOT_SHADOW||this.light_type===n.light.type.SPOT_SHADOW_PROJECTOR||this.light_type===n.light.type.SPOT)&&a.uniform1f(d.lCut[m],this.cutoff);if(this.light_type===n.light.type.SPOT_SHADOW||this.light_type===n.light.type.SPOT_SHADOW_PROJECTOR||this.light_type===n.light.type.AREA)this.light_type===n.light.type.SPOT_SHADOW_PROJECTOR?(this.shadowMapTex.texture.use(r.gl.TEXTURE0+m*2),a.uniform1i(d.lDepthTex[m],m*2),this.projectorTex.use(r.gl.TEXTURE0+
m*2+1),a.uniform1i(d.lProjTex[m],m*2+1)):(this.shadowMapTex.texture.use(r.gl.TEXTURE0+m),a.uniform1i(d.lDepthTex[m],m)),a.uniform3fv(d.lDepth[m],[this.dummyCam.nearclip,this.dummyCam.farclip,1/this.map_res]),a.uniformMatrix4fv(d.spMatrix[m],!1,this.spMatrix)},setShadow:function(d){if(v.features.lightShadows)this.map_res=d,this.shadowMapTex=new CubicVR.RenderBuffer(this.map_res,this.map_res,!0),this.shadowMapTex.texture.setFilter(n.texture.filter.NEAREST),this.dummyCam=new CubicVR.Camera(this.map_res,
this.map_res,80,0.1,this.distance),this.dummyCam.calc_nmatrix=!1,this.dummyCam.setTargeted(!0),this.has_shadow=!0},hasShadow:function(){return has_shadow},setProjector:function(d){this.projectorTex=d},hasProjector:function(){return this.projectorTex!==null?!0:!1},shadowBegin:function(){var d=r.gl,m=CubicVR.mat4,a=CubicVR.mat3;this.shadowMapTex.use();d.viewport(0,0,this.map_res,this.map_res);d.clear(d.DEPTH_BUFFER_BIT|d.COLOR_BUFFER_BIT);this.light_type!==n.light.type.AREA?(this.dummyCam.setClip(0.1,
this.distance),this.dummyCam.setFOV(this.cutoff)):this.dummyCam.calcProjection();if(this.parent){var b=m.inverse_mat3(this.parent.tMatrix);a.transpose_inline(b);a.vec3_multiply(this.direction,b);m.vec3_multiply(this.position,this.parent.tMatrix);this.dummyCam.lookat(this.position[0],this.position[1],this.position[2],this.position[0]+this.direction[0]*10,this.position[1]+this.direction[1]*10,this.position[2]+this.direction[2]*10,0,1,0);m.multiply(this.dummyCam.mvMatrix.slice(0),m.inverse(this.parent.tMatrix),
this.dummyCam.mvMatrix)}else this.dummyCam.lookat(this.position[0],this.position[1],this.position[2],this.position[0]+this.direction[0]*10,this.position[1]+this.direction[1]*10,this.position[2]+this.direction[2]*10,0,1,0);d.cullFace(d.FRONT)},shadowEnd:function(){var d=r.gl;d.bindFramebuffer(d.FRAMEBUFFER,null);d.cullFace(d.BACK);this.setupTexGen()},setupTexGen:function(){var d=CubicVR.mat4;this.spMatrix=d.multiply(g,[0.5,0,0,0,0,0.5,0,0,0,0,0.5,0,0.5,0.5,0.5,1]);this.spMatrix=d.multiply(this.spMatrix,
this.dummyCam.pMatrix);this.spMatrix=d.multiply(this.spMatrix,this.dummyCam.mvMatrix)},setAreaAxis:function(d){this.areaAxis=d},updateAreaLight:function(){var d=CubicVR.vec3,m=this.areaCeiling-this.areaFloor;this.dummyCam.ortho=!0;this.dummyCam.setClip(0.01,1);var a=0,a=Math.tan(this.areaCam.fov/2*(Math.PI/180)),b=d.subtract(this.areaCam.target,this.areaCam.position);b[1]=0;b=d.normalize(b);d.normalize(d.cross(b,[0,1,0]));var e=-Math.atan2(b[2],b[0]),a=this.distance/2*Math.abs(a)-this.distance/2;
a<this.distance/3/2&&(a=this.distance/3/2);b=d.multiply(b,a);a=[Math.tan(this.areaAxis[1]*(Math.PI/180)),0,Math.tan(this.areaAxis[0]*(Math.PI/180))];e-=Math.atan2(a[0],a[2]);this.position=d.add(d.add(this.areaCam.position,b),d.multiply(a,m));this.position[1]=this.areaCeiling;this.target=d.add(d.add(this.areaCam.position,b),d.multiply(a,-m));this.target[1]=this.areaFloor;this.direction=d.normalize(d.subtract(this.target,this.position));this.dummyCam.rotation[2]=e*(180/Math.PI);d=this.dummyCam.nearclip;
m=this.dummyCam.farclip*Math.abs(this.direction[1])*m;d=this.orthoBounds(this.position,this.distance,this.distance,this.dummyCam.pMatrix,this.dummyCam.mvMatrix,this.dummyCam.nearclip);d=this.orthoBounds(this.position,this.distance,this.distance,this.dummyCam.pMatrix,this.dummyCam.mvMatrix,this.dummyCam.farclip);d[1][1]>this.areaFloor&&(d=d[1][1]-this.areaFloor,m+=d/Math.abs(this.direction[1]));this.dummyCam.nearclip=0.01;this.dummyCam.farclip=m;this.dummyCam.setOrtho(-this.distance/2,this.distance/
2,-this.distance/2,this.distance/2)},orthoBounds:function(d,m,a,b,e,h){var b=CubicVR.vec3,c=b.normalize([e[0],e[4],e[8]]),q=b.normalize([e[1],e[5],e[9]]),e=b.normalize(b.cross(q,c)),t;t=a/2;a=[];m=b.multiply(c,m/2);c=b.multiply(q,t);h=b.multiply(e,h);a[0]=b.add(b.subtract(d,m),b.add(c,h));a[1]=b.add(b.add(d,m),b.add(c,h));a[2]=b.subtract(b.subtract(d,m),b.add(c,h));a[3]=b.subtract(b.add(d,m),b.add(c,h));aabb1=a[0];aabb2=a[0];for(d=1;d<4;d++)aabb1[0]>a[d][0]&&(aabb1[0]=a[d][0]),aabb1[1]>a[d][1]&&(aabb1[1]=
a[d][1]),aabb1[2]>a[d][2]&&(aabb1[2]=a[d][2]),aabb2[0]<a[d][0]&&(aabb2[0]=a[d][0]),aabb2[1]<a[d][1]&&(aabb2[1]=a[d][1]),aabb2[2]<a[d][2]&&(aabb2[2]=a[d][2]);return[aabb1,aabb2]}};return{Light:x}});CubicVR.RegisterModule("MainLoop",function(v){function x(){this.paused_state=this.offset=this.paused_time=this.last_update=this.end_time=this.start_time=this.system_milliseconds=this.time_elapsed=0}function r(){CubicVR.GLCore.mainloop!==null&&(window.requestAnimationFrame&&window.requestAnimationFrame(r),CubicVR.GLCore.mainloop.interval())}function n(m,a,b){if(window.requestAnimationFrame===g)window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||
window.msRequestAnimationFrame||null;if(CubicVR.GLCore.mainloop!==null)!window.requestAnimationFrame&&CubicVR.GLCore.mainloop&&clearInterval(CubicVR.GLCore.mainloop.interval),CubicVR.GLCore.mainloop=null;if(m===null)CubicVR.GLCore.mainloop=null;else{this.renderList=[];var e=this.renderStack=[{scenes:[],update:function(){},start:function(){},stop:function(){}}],h=new x;h.start();this.timer=h;this.func=m;this.doclear=a!==g?a:!0;CubicVR.GLCore.mainloop=this;if(d.resizeList.length&&!CubicVR.GLCore.resize_active)window.addEventListener("resize",
function(){CubicVR.GLCore.onResize()},!1),CubicVR.GLCore.resize_active=!0;a=function(){return function(){var a=CubicVR.GLCore.gl;h.update();CubicVR.GLCore.mainloop.doclear&&a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT);m(h,CubicVR.GLCore.gl);var b=e[e.length-1],t=b.scenes;b.update&&b.update(h,a);if(t){a=0;for(b=t.length;a<b;++a){var s=t[a];s.paused||(s.update&&s.update(h,CubicVR.GLCore.gl),s.render())}}}}();b?this.loopFunc=a:window.requestAnimationFrame?(this.interval=a,window.requestAnimationFrame(r)):
this.interval=setInterval(a,20)}}function o(d,a,b){this.canvas=d;this.camera=a;this.mpos=[0,0];this.mdown=!1;var e=this;this.mEvents={};this.keyState=[];this.onMouseDown=function(){return function(a){e.mdown=!0;e.mpos=[a.pageX-a.target.offsetLeft,a.pageY-a.target.offsetTop];e.mEvents.mouseDown&&e.mEvents.mouseDown(e,e.mpos,e.keyState)}}();this.onMouseUp=function(){return function(a){e.mdown=!1;e.mpos=[a.pageX-a.target.offsetLeft,a.pageY-a.target.offsetTop];e.mEvents.mouseUp&&e.mEvents.mouseUp(e,e.mpos,
e.keyState)}}();this.onMouseMove=function(){return function(a){var c=[],a=[a.pageX-a.target.offsetLeft,a.pageY-a.target.offsetTop];c[0]=a[0]-e.mpos[0];c[1]=a[1]-e.mpos[1];e.mpos=a;e.mEvents.mouseMove&&e.mEvents.mouseMove(e,e.mpos,c,e.keyState)}}();this.onMouseWheel=function(){return function(a){a=a.wheelDelta?a.wheelDelta:-a.detail*100;e.mEvents.mouseWheel&&e.mEvents.mouseWheel(e,e.mpos,a,e.keyState)}}();this.onKeyDown=function(){return function(){}}();this.onKeyUp=function(){return function(){}}();
this.eventDefaults={mouseMove:function(a,c,b){a.mdown&&a.orbitView(b)},mouseWheel:function(a,c,b){a.zoomView(b)},mouseDown:null,mouseUp:null,keyDown:null,keyUp:null};b!==!1&&this.setEvents(b===g?this.eventDefaults:b);this.bind()}var g=v.undef,d=v.GLCore;x.prototype={start:function(){this.update();this.num_updates=0;this.last_update=this.start_time=this.system_milliseconds;this.lock_state=this.paused_state=!1;this.offset=this.paused_time=this.lock_rate=0},stop:function(){this.end_time=this.system_milliseconds},
reset:function(){this.start()},lockFramerate:function(){this.lock_rate=1/this.f_rate;this.lock_state=!0},unlock:function(){var d=this.system_milliseconds;this.lock_state=!1;this.update();this.last_update=this.system_milliseconds-this.lock_rate;this.offset+=d-this.system_milliseconds;this.lock_rate=0},locked:function(){return this.lock_state},update:function(){this.num_updates++;this.last_update=this.system_milliseconds;this.lock_state?this.system_milliseconds+=lock_rate*1E3|0:this.system_milliseconds=
Date.now();this.paused_state&&(this.paused_time+=this.system_milliseconds-this.last_update);this.time_elapsed=this.system_milliseconds-this.start_time-this.paused_time+this.offset},getMilliseconds:function(){return this.time_elapsed},getSeconds:function(){return this.getMilliseconds()/1E3},setMilliseconds:function(d){this.offset-=this.system_milliseconds-this.start_time-this.paused_time+this.offset-d},setSeconds:function(d){this.setMilliseconds(d*1E3|0)},getLastUpdateSeconds:function(){return this.getLastUpdateMilliseconds()/
1E3},getLastUpdateMilliseconds:function(){return this.system_milliseconds-this.last_update},getTotalMilliseconds:function(){return this.system_milliseconds-this.start_time},getTotalSeconds:function(){return this.getTotalMilliseconds()/1E3},getNumUpdates:function(){return this.num_updates},setPaused:function(d){this.paused_state=d},getPaused:function(){return this.paused_state}};n.prototype={setPaused:function(d){this.timer.setPaused(d)},getPaused:function(){return this.timer.getPaused()},setTimerSeconds:function(d){this.timer.setSeconds(d)},
getTimerSeconds:function(){return this.timer.getSeconds()},resetTimer:function(){this.timer.reset()},addScene:function(d){this.renderStack[this.renderStack.length-1].scenes.push(d);return d},pushSceneGroup:function(d){d.scenes=d.scenes||[];this.renderStack.push(d);for(var a=0;a<d.scenes.length;++a)d.scenes[a].enable();d.start&&d.start()},popSceneGroup:function(){for(var d=this.renderStack[this.renderStack.length-1],a=0;a<d.scenes.length;++a)d.scenes[a].disable();this.renderStack.length>1&&this.renderStack.pop();
d.stop&&d.stop()},getScene:function(d){for(var a=renderStack[renderStack.length-1],b,e=0,h=a.scenes.length;e<h;++e)if(a.scenes[e].scene.name===d){b=a.scenes[e];break}return b},resumeScene:function(d){typeof d==="string"&&(d=this.getScene(d));d.enable();d.paused=!1},pauseScene:function(d){typeof d==="string"&&(d=this.getScene(d));d.paused=!0;d.disable()},removeScene:function(d){var a=renderStack[renderStack.length-1];typeof d==="string"&&(d=this.getScene(d));var b=a.scenes.indexOf(d);b>-1&&a.scenes.splice(b,
1);return d},runOnce:function(){this.loopFunc()}};o.prototype={setEvents:function(d){this.mEvents={};for(var a in d)this.bindEvent(a,d[a])},orbitView:function(d){var a=CubicVR.vec3,b=a.subtract(this.camera.target,this.camera.position),b=a.length(b);this.camera.position=a.moveViewRelative(this.camera.position,this.camera.target,-b*d[0]/300,0);this.camera.position[1]+=b*d[1]/300;this.camera.position=a.add(this.camera.target,a.multiply(a.normalize(a.subtract(this.camera.position,this.camera.target)),
b))},panView:function(d,a){var b=CubicVR.vec3;a||(a=!1);var e=b.subtract(this.camera.target,this.camera.position),e=b.length(e),h=this.camera.position;a?this.camera.position=b.moveViewRelative(this.camera.position,this.camera.target,-e*d[0]/300,-e*d[1]/300):(this.camera.position=b.moveViewRelative(this.camera.position,this.camera.target,-e*d[0]/300,0),this.camera.position[1]+=e*d[1]/300);e=b.subtract(this.camera.position,h);this.camera.target=b.add(this.camera.target,e)},zoomView:function(d,a,b){var e=
CubicVR.vec3,h=e.subtract(this.camera.target,this.camera.position),h=e.length(h);h-=d/1E3;a||(a=0.1);b||(b=1E3);h<a&&(h=a);h>b&&(h=b);this.camera.position=e.add(this.camera.target,e.multiply(e.normalize(e.subtract(this.camera.position,this.camera.target)),h))},bindEvent:function(d,a){this.mEvents[d]=a===g?this.eventDefaults[d]:a},unbindEvent:function(d){this.bindEvent(d,null)},bind:function(){this.canvas.addEventListener("mousemove",this.onMouseMove,!1);this.canvas.addEventListener("mousedown",this.onMouseDown,
!1);this.canvas.addEventListener("mouseup",this.onMouseUp,!1);this.canvas.addEventListener("mousewheel",this.onMouseWheel,!1);this.canvas.addEventListener("DOMMouseScroll",this.onMouseWheel,!1);this.canvas.addEventListener("keydown",this.onKeyDown,!1);this.canvas.addEventListener("keyup",this.onKeyUp,!1)},unbind:function(){this.canvas.removeEventListener("mousemove",this.onMouseMove,!1);this.canvas.removeEventListener("mousedown",this.onMouseDown,!1);this.canvas.removeEventListener("mouseup",this.onMouseUp,
!1);this.canvas.removeEventListener("mousewheel",this.onMouseWheel,!1);this.canvas.removeEventListener("DOMMouseScroll",this.onMouseWheel,!1);this.canvas.removeEventListener("keydown",this.onKeyDown,!1);this.canvas.removeEventListener("keyup",this.onKeyUp,!1)},setCamera:function(d){this.camera=d},getMousePosition:function(){return this.mpos}};return{Timer:x,MainLoop:n,MouseViewController:o,setMainLoop:function(d){CubicVR.GLCore.mainloop=d}}});CubicVR.RegisterModule("Texture",function(v){function x(a){var c=CubicVR.GLCore.gl;if(a.nodeName==="CANVAS"||a.nodeName==="IMG")this.canvasSource=a;else{this.canvasSource=document.createElement("CANVAS");if(a.width===void 0||a.height===void 0)throw Error("Width and height must be specified for generating a new CanvasTexture.");this.canvasSource.width=a.width;this.canvasSource.height=a.height;this.canvasContext=this.canvasSource.getContext("2d")}var b=this.canvasSource,e=b.width,b=b.height,d=!0;if(e===
1||b===1)d=!1;else{if(e!==1)for(;e%2===0;)e/=2;if(b!==1)for(;b%2===0;)b/=2;e>1&&(d=!1);b>1&&(d=!1)}this.updateFunction=a.update;this.texture=new CubicVR.Texture;this.setFilter=this.texture.setFilter;this.clear=this.texture.clear;this.use=this.texture.use;this.tex_id=this.texture.tex_id;this.filterType=this.texture.filterType;d?(this.setFilter(m.texture.filter.LINEAR_MIP),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.REPEAT),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.REPEAT)):(this.setFilter(m.texture.filter.LINEAR),
c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.CLAMP_TO_EDGE));a.nodeName==="IMG"&&this.update()}function r(a,c,b){var e=CubicVR.GLCore.gl;this.texture=new CubicVR.Texture;this.canvas=document.createElement("CANVAS");this.canvas.width=c;this.canvas.height=b;this.pjs=new Processing(this.canvas,CubicVR.util.getURL(a));this.pjs.noLoop();this.pjs.redraw();a=this.canvas.width;c=this.canvas.height;b=!0;if(a===1||c===1)b=!1;else{if(a!==1)for(;a%
2===0;)a/=2;if(c!==1)for(;c%2===0;)c/=2;a>1&&(b=!1);c>1&&(b=!1)}this.setFilter=this.texture.setFilter;this.clear=this.texture.clear;this.use=this.texture.use;this.tex_id=this.texture.tex_id;this.filterType=this.texture.filterType;b?this.setFilter(m.texture.filter.LINEAR_MIP):(this.setFilter(m.texture.filter.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE))}function n(a,c,b){var e=d.gl;this.width=c;this.height=b;this.srcTex=
a;this.outTex=new CubicVR.RenderBuffer(c,b);var a=c,s=b;if(!(a===1||s===1)){if(a!==1)for(;a%2===0;)a/=2;if(s!==1)for(;s%2===0;)s/=2}a=[1/c,1/b,0];this.outputBuffer=new CubicVR.RenderBuffer(c,b,!1);this.fsQuad=CubicVR.fsQuad.make(c,b);shaderNMap=new CubicVR.Shader("attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nvoid main(void)\n{\n  vTex = aTex;\n  vec4 vPos = vec4(aVertex.xyz,1.0);\n  gl_Position = vPos;\n}","#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D srcTex;\nvarying vec2 vTex;\nuniform vec3 texel;\nvoid main(void)\n{\n vec3 color;\n color.r = (texture2D(srcTex,vTex + vec2(texel.x,0)).r-texture2D(srcTex,vTex + vec2(-texel.x,0)).r)/2.0 + 0.5;\n color.g = (texture2D(srcTex,vTex + vec2(0,-texel.y)).r-texture2D(srcTex,vTex + vec2(0,texel.y)).r)/2.0 + 0.5;\n color.b = 1.0;\n gl_FragColor.rgb = color;\n gl_FragColor.a = 1.0;\n}");
shaderNMap.use();shaderNMap.addUVArray("aTex");shaderNMap.addVertexArray("aVertex");shaderNMap.addInt("srcTex",0);shaderNMap.addVector("texel");shaderNMap.setVector("texel",a);this.shaderNorm=shaderNMap;this.setFilter=this.outputBuffer.texture.setFilter;this.clear=this.outputBuffer.texture.clear;this.use=this.outputBuffer.texture.use;this.tex_id=this.outputBuffer.texture.tex_id;this.filterType=this.outputBuffer.texture.filterType;this.outTex.use(e.TEXTURE0);this.setFilter(m.texture.filter.LINEAR);
e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.REPEAT);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.REPEAT)}function o(a,c,b){var e=d.gl;this.width=a;this.height=c;this.outTex=new CubicVR.RenderBuffer(a,c,b);this.texture=this.outTex.texture;var s=a,g=c,A=!0;if(s===1||g===1)A=!1;else{if(s!==1)for(;s%2===0;)s/=2;if(g!==1)for(;g%2===0;)g/=2;s>1&&(A=!1);g>1&&(A=!1)}this.setFilter=this.outTex.texture.setFilter;this.clear=this.outTex.texture.clear;this.use=this.outTex.texture.use;this.tex_id=this.outTex.texture.tex_id;
this.filterType=this.outTex.texture.filterType;this.texture.use(e.TEXTURE0);A?(this.setFilter(m.texture.filter.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.REPEAT),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.REPEAT)):(this.setFilter(m.texture.filter.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE));this.dims=[a,c];this.depth=b?!0:!1}function g(a,c){this.scene=a;this.renderTex=new o(c?c.width:a.camera.width,
c?c.height:a.camera.height,!0);this.setFilter=this.renderTex.texture.setFilter;this.clear=this.renderTex.texture.clear;this.use=this.renderTex.texture.use;this.tex_id=this.renderTex.texture.tex_id;this.filterType=this.renderTex.texture.filterType}var d=v.GLCore,m=CubicVR.enums,a=v.undef;m.texture={map:{COLOR:0,ENVSPHERE:1,NORMAL:2,BUMP:3,REFLECT:4,SPECULAR:5,AMBIENT:6,ALPHA:7,MAX:8},filter:{LINEAR:0,LINEAR_MIP:1,NEAREST:2,NEAREST_MIP:3}};var b=function(a,c){this.img_path=a;this.filter_type=c};b.prototype=
{getTexture:function(a,c){return new e(this.img_path,this.filter_type,a,c)}};var e=function(b,c,q,e,s){var g=d.gl;this.tex_id=v.Textures.length;this.filterType=-1;this.onready=s;this.loaded=!1;v.Textures[this.tex_id]=g.createTexture();v.Textures_obj[this.tex_id]=this;if(b)typeof b==="string"?v.Images[this.tex_id]=new Image:typeof b==="object"&&b.nodeName==="IMG"&&(v.Images[this.tex_id]=b),v.Textures_ref[b]=this.tex_id;g.bindTexture(g.TEXTURE_2D,v.Textures[this.tex_id]);g.texParameteri(g.TEXTURE_2D,
g.TEXTURE_MAG_FILTER,g.LINEAR);g.texParameteri(g.TEXTURE_2D,g.TEXTURE_MIN_FILTER,g.LINEAR);if(b){var A=this.tex_id,o=c!==a?c:d.default_filter,u=this;v.Images[this.tex_id].onload=function(){g.bindTexture(g.TEXTURE_2D,v.Textures[A]);g.pixelStorei(g.UNPACK_FLIP_Y_WEBGL,!0);g.pixelStorei(g.UNPACK_COLORSPACE_CONVERSION_WEBGL,g.NONE);var a=v.Images[A];g.texImage2D(g.TEXTURE_2D,0,g.RGBA,g.RGBA,g.UNSIGNED_BYTE,a);var c=a.width,a=a.height,b=!0;if(c===1||a===1)b=!1;else{if(c!==1)for(;c%2===0;)c/=2;if(a!==1)for(;a%
2===0;)a/=2;c>1&&(b=!1);a>1&&(b=!1)}b||(g.texParameteri(g.TEXTURE_2D,g.TEXTURE_WRAP_S,g.CLAMP_TO_EDGE),g.texParameteri(g.TEXTURE_2D,g.TEXTURE_WRAP_T,g.CLAMP_TO_EDGE));if(v.Textures_obj[A].filterType===-1){if(!b&&o===m.texture.filter.LINEAR_MIP)o=m.texture.filter.LINEAR;v.Textures_obj[A].filterType===-1&&v.Textures_obj[A].setFilter(o)}else v.Textures_obj[A].setFilter(v.Textures_obj[A].filterType);g.bindTexture(g.TEXTURE_2D,null);if(u.onready)u.onready();u.loaded=!0};if(q)v.Images[this.tex_id].deferredSrc=
b,q.addImage(e,b,v.Images[this.tex_id]);else if(typeof b==="string")v.Images[this.tex_id].src=b}this.active_unit=-1};e.prototype={setFilter:function(a){var c=CubicVR.GLCore.gl;c.bindTexture(c.TEXTURE_2D,v.Textures[this.tex_id]);a===m.texture.filter.LINEAR?(c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.LINEAR),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.LINEAR)):a===m.texture.filter.LINEAR_MIP?(c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.LINEAR),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,
c.LINEAR_MIPMAP_NEAREST),c.generateMipmap(c.TEXTURE_2D)):a===m.texture.filter.NEAREST?(c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.NEAREST),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.NEAREST)):a===m.texture.filter.NEAREST_MIP&&(c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.NEAREST),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.NEAREST_MIPMAP_LINEAR),c.generateMipmap(c.TEXTURE_2D));this.filterType=a},use:function(a){d.gl.activeTexture(a);d.gl.bindTexture(d.gl.TEXTURE_2D,
v.Textures[this.tex_id]);this.active_unit=a},clear:function(){if(this.active_unit!==-1)d.gl.activeTexture(this.active_unit),d.gl.bindTexture(d.gl.TEXTURE_2D,null),this.active_unit=-1}};x.prototype={update:function(){this.updateFunction&&this.updateFunction(this.canvasSource,this.canvasContext);var a=CubicVR.GLCore.gl;a.bindTexture(a.TEXTURE_2D,v.Textures[this.texture.tex_id]);a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,this.canvasSource);this.filterType===
m.texture.filter.LINEAR_MIP&&a.generateMipmap(a.TEXTURE_2D);a.bindTexture(a.TEXTURE_2D,null)}};r.prototype={update:function(){var a=CubicVR.GLCore.gl;this.pjs.redraw();a.bindTexture(a.TEXTURE_2D,v.Textures[this.texture.tex_id]);a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,this.canvas);this.filterType===m.texture.filter.LINEAR_MIP&&a.generateMipmap(a.TEXTURE_2D);a.bindTexture(a.TEXTURE_2D,null)}};n.prototype={update:function(){var a=d.gl,c=a.getParameter(a.VIEWPORT);
this.outputBuffer.use();a.viewport(0,0,this.width,this.height);a.clearColor(0,0,0,1);a.clear(a.COLOR_BUFFER_BIT);this.srcTex.use(a.TEXTURE0);CubicVR.fsQuad.render(this.shaderNorm,this.fsQuad);a.bindFramebuffer(a.FRAMEBUFFER,null);a.viewport(c[0],c[1],c[2],c[3])}};o.prototype={begin:function(){var a=d.gl;this.dims=a.getParameter(a.VIEWPORT);this.outTex.use();a.viewport(0,0,this.width,this.height);this.depth?a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT):a.clear(a.COLOR_BUFFER_BIT)},end:function(){var a=
d.gl;a.bindFramebuffer(a.FRAMEBUFFER,null);a.viewport(this.dims[0],this.dims[1],this.dims[2],this.dims[3])}};g.prototype={update:function(){this.renderTex.begin();this.scene.updateShadows();this.scene.render();this.renderTex.end()}};return{Texture:e,DeferredLoadTexture:b,CanvasTexture:x,TextTexture:function(b,c){var q=c&&c.color||"#fff",e=c&&c.bgcolor,d=c&&c.font||"18pt Arial",g=c&&c.align||"start",m=c&&c.y||0,o=c&&c.width||a,u=c&&c.height||a,n,r=document.createElement("CANVAS"),z=r.getContext("2d"),
w=0,w=typeof b==="string"?1:b.length;z.font=d;var y=c&&c.lineHeight||z.measureText("OO").width,v;if(w===1)v=z.measureText(b).width;else for(n=v=0;n<w;++n){var C=z.measureText(b[n]).width;C>v&&(v=C)}r.width=o||v;r.height=u||y*w;if(e)z.fillStyle=e,z.fillRect(0,0,r.width,r.height);z.fillStyle=q;z.font=d;z.textAlign=g;z.textBaseline="top";if(w===1)q=c&&c.x||g==="center"?r.width/2:g==="right"?r.width:0,z.fillText(b,q,m);else for(n=0;n<w;++n)q=c&&c.x||g==="center"?r.width/2:g==="right"?r.width:0,z.fillText(b[n],
q,m+n*y);z.fill();this.use=x.prototype.use;this.clear=x.prototype.clear;this.update=x.prototype.update;x.apply(this,[r]);this.update();this.canvasSource=null},PJSTexture:r,NormalMapGen:n,RenderTexture:o,SceneRenderTexture:g}});CubicVR.RegisterModule("Material",function(v){function x(d){this.initialized=!1;this.textures=[];this.shader=[];this.customShader=null;typeof d==="object"?(this.diffuse=d.diffuse===r?[1,1,1]:d.diffuse,this.specular=d.specular===r?[0.1,0.1,0.1]:d.specular,this.color=d.color===r?[1,1,1]:d.color,this.ambient=d.ambient===r?[0,0,0]:d.ambient,this.opacity=d.opacity===r?1:d.opacity,this.shininess=d.shininess===r?1:d.shininess,this.max_smooth=d.max_smooth===r?60:d.max_smooth,this.env_amount=d.env_amount===
r?0.75:d.env_amount,this.morph=d.morph===r?!1:d.morph,this.color_map=d.colorMap===r?!1:d.colorMap,this.name=d.name===r?r:d.name,typeof d.textures==="object"&&(d.textures.color!==r&&this.setTexture(d.textures.color,o.texture.map.COLOR),d.textures.envsphere!==r&&this.setTexture(d.textures.envsphere,o.texture.map.ENVSPHERE),d.textures.normal!==r&&this.setTexture(d.textures.normal,o.texture.map.NORMAL),d.textures.bump!==r&&this.setTexture(d.textures.bump,o.texture.map.BUMP),d.textures.reflect!==r&&this.setTexture(d.textures.reflect,
o.texture.map.REFLECT),d.textures.specular!==r&&this.setTexture(d.textures.specular,o.texture.map.SPECULAR),d.textures.ambient!==r&&this.setTexture(d.textures.ambient,o.texture.map.AMBIENT),d.textures.alpha!==r&&this.setTexture(d.textures.alpha,o.texture.map.ALPHA))):(this.diffuse=[1,1,1],this.specular=[0.1,0.1,0.1],this.color=[1,1,1],this.ambient=[0,0,0],this.shininess=this.opacity=1,this.max_smooth=60,this.name=d,this.color_map=this.morph=!1)}var r=v.undef,n=v.GLCore,o=CubicVR.enums,g=[o.texture.map.REFLECT,
o.texture.map.SPECULAR,o.texture.map.NORMAL,o.texture.map.BUMP];x.prototype={clone:function(){var d=new CubicVR.Material({diffuse:this.diffuse,specular:this.specular,color:this.color,ambient:this.ambient,opacity:this.opacity,shininess:this.shininess,max_smooth:this.max_smooth,env_amount:this.env_amount,morph:this.morph,colorMap:this.color_map,name:this.name}),g;for(g in this.textures)d.setTexture(this.textures[g],g);return d},setTexture:function(d,m){m===r&&(m=0);if(v.features.texturePerPixel||g.indexOf(m)===
-1)this.textures[m]=d},calcShaderMask:function(){var d=0;d+=typeof this.textures[o.texture.map.COLOR]==="object"?o.shader.map.COLOR:0;d+=typeof this.textures[o.texture.map.SPECULAR]==="object"?o.shader.map.SPECULAR:0;d+=typeof this.textures[o.texture.map.NORMAL]==="object"?o.shader.map.NORMAL:0;d+=typeof this.textures[o.texture.map.BUMP]==="object"?o.shader.map.BUMP:0;d+=typeof this.textures[o.texture.map.REFLECT]==="object"?o.shader.map.REFLECT:0;d+=typeof this.textures[o.texture.map.ENVSPHERE]===
"object"?o.shader.map.ENVSPHERE:0;d+=typeof this.textures[o.texture.map.AMBIENT]==="object"?o.shader.map.AMBIENT:0;d+=typeof this.textures[o.texture.map.ALPHA]==="object"?o.shader.map.ALPHA:0;d+=this.opacity!==1?o.shader.map.ALPHA:0;return d},getShaderHeader:function(d,g){return(g!==r?"#define loopCount "+g+"\n":"")+"#define hasColorMap "+(typeof this.textures[o.texture.map.COLOR]==="object"?1:0)+"\n#define hasSpecularMap "+(typeof this.textures[o.texture.map.SPECULAR]==="object"?1:0)+"\n#define hasNormalMap "+
(typeof this.textures[o.texture.map.NORMAL]==="object"?1:0)+"\n#define hasBumpMap "+(typeof this.textures[o.texture.map.BUMP]==="object"?1:0)+"\n#define hasReflectMap "+(typeof this.textures[o.texture.map.REFLECT]==="object"?1:0)+"\n#define hasEnvSphereMap "+(typeof this.textures[o.texture.map.ENVSPHERE]==="object"?1:0)+"\n#define hasAmbientMap "+(typeof this.textures[o.texture.map.AMBIENT]==="object"?1:0)+"\n#define hasAlphaMap "+(typeof this.textures[o.texture.map.ALPHA]==="object"?1:0)+"\n#define hasAlpha "+
(this.opacity!==1?1:0)+"\n#define lightPoint "+(d===o.light.type.POINT?1:0)+"\n#define lightDirectional "+(d===o.light.type.DIRECTIONAL?1:0)+"\n#define lightSpot "+(d===o.light.type.SPOT||d===o.light.type.SPOT_SHADOW||d===o.light.type.SPOT_SHADOW_PROJECTOR?1:0)+"\n#define hasShadow "+(d===o.light.type.SPOT_SHADOW||d===o.light.type.SPOT_SHADOW_PROJECTOR||d===o.light.type.AREA?1:0)+"\n#define hasProjector "+(d===o.light.type.SPOT_SHADOW_PROJECTOR?1:0)+"\n#define softShadow "+(n.soft_shadow?1:0)+"\n#define lightArea "+
(d===o.light.type.AREA?1:0)+"\n#define depthPack "+(d===o.light.type.DEPTH_PACK?1:0)+"\n#define alphaDepth "+(n.depth_alpha?1:0)+"\n#define hasMorph "+(this.morph?1:0)+"\n#define hasVertexColorMap "+(this.color_map?1:0)+"\n#define perPixel "+(v.features.lightPerPixel?1:0)+"\n\n"},bindObject:function(d,g){var a=n.gl,b=g.aVertexPosition,e=g.aTextureCoord,h=g.aNormal,c=g.aColor;a.bindBuffer(a.ARRAY_BUFFER,d.compiled.gl_points);a.vertexAttribPointer(b,3,a.FLOAT,!1,0,0);a.enableVertexAttribArray(b);e!==
null&&d.compiled.gl_uvs!==null&&e!==-1&&(a.bindBuffer(a.ARRAY_BUFFER,d.compiled.gl_uvs),a.vertexAttribPointer(e,2,a.FLOAT,!1,0,0),a.enableVertexAttribArray(e));h!==null&&d.compiled.gl_normals!==null&&h!==-1&&(a.bindBuffer(a.ARRAY_BUFFER,d.compiled.gl_normals),a.vertexAttribPointer(h,3,a.FLOAT,!1,0,0),a.enableVertexAttribArray(h));c!==null&&d.compiled.gl_colors!==null&&c!==-1&&(a.bindBuffer(a.ARRAY_BUFFER,d.compiled.gl_colors),a.vertexAttribPointer(c,3,a.FLOAT,!1,0,0),a.enableVertexAttribArray(c));
if(d.morphTarget)b=g.amVertexPosition,h=g.amNormal,a.bindBuffer(a.ARRAY_BUFFER,d.morphTarget.gl_points),a.vertexAttribPointer(b,3,a.FLOAT,!1,0,0),a.enableVertexAttribArray(b),h!==null&&d.morphTarget.gl_normals!==null&&h!==-1&&(a.bindBuffer(a.ARRAY_BUFFER,d.morphTarget.gl_normals),a.vertexAttribPointer(h,3,a.FLOAT,!1,0,0),a.enableVertexAttribArray(h)),a.uniform1f(g.morphWeight,d.morphWeight);a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,d.compiled.gl_elements)},clearObject:function(d,g){var a=n.gl,b=g.aTextureCoord,
e=g.aNormal,h=g.aColor;b!==null&&d.compiled.gl_uvs!==null&&b!==-1&&a.disableVertexAttribArray(b);e!==null&&d.compiled.gl_normals!==null&&e!==-1&&a.disableVertexAttribArray(e);h!==null&&d.compiled.gl_colors!==null&&h!==-1&&a.disableVertexAttribArray(h);if(d.morphTarget)up=g.amVertexPosition,a.disableVertexAttribArray(up),e=g.amNormal,e!==null&&d.compiled.gl_normals!==null&&e!==-1&&a.disableVertexAttribArray(e)},use:function(d,g){g===r&&(g=0);if(this.customShader!==null)this.customShader.use();else{d===
r&&(d=0);var a,b=this.textures;this.shader[d]===r&&(this.shader[d]=[]);if(this.shader[d][g]===r){var e=this.calcShaderMask(d);v.ShaderPool[d][e]===r&&(v.ShaderPool[d][e]=[]);if(v.ShaderPool[d][e][g]===r){a=this.getShaderHeader(d,g);var h=new CubicVR.Shader(a+n.CoreShader_vs,a+n.CoreShader_fs);v.ShaderPool[d][e][g]=h;a=0;if(d!==o.light.type.DEPTH_PACK){if(d===o.light.type.SPOT_SHADOW||d===o.light.type.SPOT_SHADOW_PROJECTOR||d===o.light.type.AREA)a+=g,d===o.light.type.SPOT_SHADOW_PROJECTOR&&(a+=g);
typeof b[o.texture.map.COLOR]==="object"&&h.addInt("colorMap",a++);typeof b[o.texture.map.ENVSPHERE]==="object"&&h.addInt("envSphereMap",a++);typeof b[o.texture.map.NORMAL]==="object"&&h.addInt("normalMap",a++);typeof b[o.texture.map.BUMP]==="object"&&h.addInt("bumpMap",a++);typeof b[o.texture.map.REFLECT]==="object"&&h.addInt("reflectMap",a++);typeof b[o.texture.map.SPECULAR]==="object"&&h.addInt("specularMap",a++);typeof b[o.texture.map.AMBIENT]==="object"&&h.addInt("ambientMap",a++)}typeof b[o.texture.map.ALPHA]===
"object"&&h.addInt("alphaMap",a++);h.addMatrix("uMVMatrix");h.addMatrix("uPMatrix");h.addMatrix("uOMatrix");h.addMatrix("uNMatrix");h.addVertexArray("aVertexPosition");h.addVertexArray("aNormal");this.color_map&&h.addVertexArray("aColor");this.morph&&(h.addVertexArray("amVertexPosition"),h.addVertexArray("amNormal"),h.addFloat("morphWeight",0));for(a=0;a<g;a++)if(h.addVector("lDiff["+a+"]"),h.addVector("lSpec["+a+"]"),h.addFloat("lInt["+a+"]"),h.addFloat("lDist["+a+"]"),h.addVector("lPos["+a+"]"),
h.addVector("lDir["+a+"]"),(d===o.light.type.SPOT_SHADOW||d===o.light.type.SPOT_SHADOW_PROJECTOR||d===o.light.type.SPOT)&&h.addFloat("lCut["+a+"]"),d===o.light.type.SPOT_SHADOW||d===o.light.type.SPOT_SHADOW_PROJECTOR||d===o.light.type.AREA)h.addInt("lDepthTex["+a+"]"),d===o.light.type.SPOT_SHADOW_PROJECTOR&&h.addInt("lProjTex["+a+"]"),h.addVector("lDepth["+a+"]"),h.addMatrix("spMatrix["+a+"]");d!==o.light.type.DEPTH_PACK&&(h.addVector("lAmb"),h.addVector("mDiff"),h.addVector("mColor"),h.addVector("mAmb"),
h.addVector("mSpec"),h.addFloat("mShine"),h.addFloat("envAmount"));h.addFloat("mAlpha");(n.depth_alpha||d===o.light.type.DEPTH_PACK||d===o.light.type.SPOT_SHADOW||d===o.light.type.SPOT_SHADOW_PROJECTOR||d===o.light.type.AREA)&&h.addVector("depthInfo");h.addUVArray("aTextureCoord")}this.shader[d][g]=v.ShaderPool[d][e][g]}e=this.shader[d][g];h=n.gl;e.use();a=0;var c;if(d!==o.light.type.DEPTH_PACK){if(d===o.light.type.SPOT_SHADOW||d===o.light.type.SPOT_SHADOW_PROJECTOR||d===o.light.type.AREA)a+=g,d===
o.light.type.SPOT_SHADOW_PROJECTOR&&(a+=g);if(c=b[o.texture.map.COLOR])c.use(n.gl.TEXTURE0+a),a++;if(c=b[o.texture.map.ENVSPHERE])c.use(n.gl.TEXTURE0+a),a++,h.uniform1f(e.envAmount,this.env_amount);if(c=b[o.texture.map.NORMAL])c.use(n.gl.TEXTURE0+a),a++;if(c=b[o.texture.map.BUMP])c.use(n.gl.TEXTURE0+a),a++;if(c=b[o.texture.map.REFLECT])c.use(n.gl.TEXTURE0+a),a++;if(c=b[o.texture.map.SPECULAR])c.use(n.gl.TEXTURE0+a),a++;if(c=b[o.texture.map.AMBIENT])c.use(n.gl.TEXTURE0+a),a++}(c=b[o.texture.map.ALPHA])&&
c.use(n.gl.TEXTURE0+a);d!==o.light.type.DEPTH_PACK?(h.uniform3fv(e.mColor,this.color),h.uniform3fv(e.mDiff,this.diffuse),h.uniform3fv(e.mAmb,this.ambient),h.uniform3fv(e.mSpec,this.specular),h.uniform1f(e.mShine,this.shininess*128),h.uniform3fv(e.lAmb,CubicVR.globalAmbient),(n.depth_alpha||d===o.light.type.SPOT_SHADOW||d===o.light.type.SPOT_SHADOW_PROJECTOR||d===o.light.type.AREA)&&h.uniform3fv(e.depthInfo,[n.depth_alpha_near,n.depth_alpha_far,0])):h.uniform3fv(e.depthInfo,[n.shadow_near,n.shadow_far,
0]);this.opacity!==1&&h.uniform1f(e.mAlpha,this.opacity)}}};return{Material:x}});CubicVR.RegisterModule("Math",function(v){function x(a){return this.clearStack(a)}function r(){if(arguments.length===1)this.x=arguments[0][0],this.y=arguments[0][1],this.z=arguments[0][2],this.w=arguments[0][3];if(arguments.length===4)this.x=arguments[0],this.y=arguments[1],this.z=arguments[2],this.w=arguments[3]}var n=v.undef,o=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],g=Math.PI/2,d={length:function(a){return Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2])},normalize:function(a){var b=Math.sqrt(a[0]*a[0]+a[1]*
a[1]+a[2]*a[2]);if(b===0)return[0,0,0];return[a[0]/b,a[1]/b,a[2]/b]},dot:function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},angle:function(a,b){return Math.acos((a[0]*b[0]+a[1]*b[1]+a[2]*b[2])/(Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2])*Math.sqrt(b[0]*b[0]+b[1]*b[1]+b[2]*b[2])))},cross:function(a,b){return[a[1]*b[2]-b[1]*a[2],a[2]*b[0]-b[2]*a[0],a[0]*b[1]-b[0]*a[1]]},multiply:function(a,b){return[a[0]*b,a[1]*b,a[2]*b]},add:function(a,b){return[a[0]+b[0],a[1]+b[1],a[2]+b[2]]},subtract:function(a,b){return[a[0]-
b[0],a[1]-b[1],a[2]-b[2]]},equal:function(a,b,e){e===n&&(e=1.0E-7);if(a===n&&b===n)return!0;if(a===n||b===n)return!1;return Math.abs(a[0]-b[0])<e&&Math.abs(a[1]-b[1])<e&&Math.abs(a[2]-b[2])<e},moveViewRelative:function(a,b,e,h,c){var q=Math.sqrt(e*e+h*h),b=Math.atan2(b[2]-a[2],b[0]-a[0])+Math.atan2(h,e)+g;if(typeof c==="object")return[c[0]+q*Math.cos(b),c[1],c[2]+q*Math.sin(b)];return[a[0]+q*Math.cos(b),a[1],a[2]+q*Math.sin(b)]},trackTarget:function(a,b,e,h){var b=d.subtract(b,a),c=d.length(b),q;
q=d.normalize(b);q=d.multiply(q,e*(1/(1/(c-h))));c>h?a=d.add(a,q):c<h?(q=d.normalize(b),q=d.multiply(q,e*(1/(1/Math.abs(c-h)))),a=d.subtract(a,q)):a=[a[0],a[1]+q[2],a[2]];return a},getClosestTo:function(a,b,e){b=d.subtract(b,a);e=d.subtract(e,a);return d.add(d.multiply(b,d.dot(b,e)/d.dot(b,b)),a)},linePlaneIntersect:function(a,b,e,h){var c=-a[0]*b[0]-a[1]*b[1]-a[2]*b[2],b=a[0]*(h[0]-e[0])+a[1]*(h[1]-e[1])+a[2]*(h[2]-e[2]);if(Math.abs(b)<0.0010)return!1;a=-(c+a[0]*e[0]+a[1]*e[1]+a[2]*e[2])/b;return[e[0]+
a*(h[0]-e[0]),e[1]+a*(h[1]-e[1]),e[2]+a*(h[2]-e[2])]}},m={lookat:function(a,b,e,h,c,q,t,s,g){var m=[],o=[],u=[],o=[];m[0]=h-a;m[1]=c-b;m[2]=q-e;u[0]=t;u[1]=s;u[2]=g;m=d.normalize(m);o=d.cross(m,u);o=d.normalize(o);u=d.cross(o,m);o=[o[0],u[0],-m[0],0,o[1],u[1],-m[1],0,o[2],u[2],-m[2],0,0,0,0,1];h=new CubicVR.Transform(o);h.translate([-a,-b,-e]);return h.getResult()},multiply:function(a,b,e){e===n&&(e=[]);e[0]=a[0]*b[0]+a[4]*b[1]+a[8]*b[2]+a[12]*b[3];e[1]=a[1]*b[0]+a[5]*b[1]+a[9]*b[2]+a[13]*b[3];e[2]=
a[2]*b[0]+a[6]*b[1]+a[10]*b[2]+a[14]*b[3];e[3]=a[3]*b[0]+a[7]*b[1]+a[11]*b[2]+a[15]*b[3];e[4]=a[0]*b[4]+a[4]*b[5]+a[8]*b[6]+a[12]*b[7];e[5]=a[1]*b[4]+a[5]*b[5]+a[9]*b[6]+a[13]*b[7];e[6]=a[2]*b[4]+a[6]*b[5]+a[10]*b[6]+a[14]*b[7];e[7]=a[3]*b[4]+a[7]*b[5]+a[11]*b[6]+a[15]*b[7];e[8]=a[0]*b[8]+a[4]*b[9]+a[8]*b[10]+a[12]*b[11];e[9]=a[1]*b[8]+a[5]*b[9]+a[9]*b[10]+a[13]*b[11];e[10]=a[2]*b[8]+a[6]*b[9]+a[10]*b[10]+a[14]*b[11];e[11]=a[3]*b[8]+a[7]*b[9]+a[11]*b[10]+a[15]*b[11];e[12]=a[0]*b[12]+a[4]*b[13]+a[8]*
b[14]+a[12]*b[15];e[13]=a[1]*b[12]+a[5]*b[13]+a[9]*b[14]+a[13]*b[15];e[14]=a[2]*b[12]+a[6]*b[13]+a[10]*b[14]+a[14]*b[15];e[15]=a[3]*b[12]+a[7]*b[13]+a[11]*b[14]+a[15]*b[15];return e},vec4_multiply:function(a,b,e){e===n&&(e=[]);e[0]=b[0]*a[0]+b[4]*a[1]+b[8]*a[2]+b[12]*a[3];e[1]=b[1]*a[0]+b[5]*a[1]+b[9]*a[2]+b[13]*a[3];e[2]=b[2]*a[0]+b[6]*a[1]+b[10]*a[2]+b[14]*a[3];e[3]=b[3]*a[0]+b[7]*a[1]+b[11]*a[2]+b[15]*a[3];return e},vec3_multiply:function(a,b,e){e===n&&(e=[]);e[0]=b[0]*a[0]+b[4]*a[1]+b[8]*a[2]+
b[12];e[1]=b[1]*a[0]+b[5]*a[1]+b[9]*a[2]+b[13];e[2]=b[2]*a[0]+b[6]*a[1]+b[10]*a[2]+b[14];return e},perspective:function(a,b,e,h){a=Math.tan(a*Math.PI/360);return[1/(a*b),0,0,0,0,1/a,0,0,0,0,-(h+e)/(h-e),-1,0,0,-(2*h*e)/(h-e),0]},ortho:function(a,b,e,h,c,q){return[2/(b-a),0,0,0,0,2/(h-e),0,0,0,0,-2/(q-c),0,-(a+b)/(b-a),-(h+e)/(h-e),-(q+c)/(q-c),1]},determinant:function(a){return(a[0]*a[5]-a[1]*a[4])*(a[10]*a[15]-a[11]*a[14])-(a[0]*a[6]-a[2]*a[4])*(a[9]*a[15]-a[11]*a[13])+(a[0]*a[7]-a[3]*a[4])*(a[9]*
a[14]-a[10]*a[13])+(a[1]*a[6]-a[2]*a[5])*(a[8]*a[15]-a[11]*a[12])-(a[1]*a[7]-a[3]*a[5])*(a[8]*a[14]-a[10]*a[12])+(a[2]*a[7]-a[3]*a[6])*(a[8]*a[13]-a[9]*a[12])},coFactor:function(){},transpose:function(a){return[a[0],a[4],a[8],a[12],a[1],a[5],a[9],a[13],a[2],a[6],a[10],a[14],a[3],a[7],a[11],a[15]]},inverse_mat3:function(a){var b=[],e=a[0],h=a[1],c=a[2],q=a[4],d=a[5],s=a[6],g=a[8],m=a[9],a=a[10],o=a*d-s*m,u=-a*q+s*g,n=m*q-d*g,r=e*o+h*u+c*n;if(!r)return null;r=1/r;b[0]=o*r;b[1]=(-a*h+c*m)*r;b[2]=(s*
h-c*d)*r;b[3]=u*r;b[4]=(a*e-c*g)*r;b[5]=(-s*e+c*q)*r;b[6]=n*r;b[7]=(-m*e+h*g)*r;b[8]=(d*e-h*q)*r;return b},inverse:function(a,b){var e=a[0]*a[5]-a[1]*a[4],h=a[0]*a[6]-a[2]*a[4],c=a[0]*a[7]-a[3]*a[4],q=a[1]*a[6]-a[2]*a[5],d=a[1]*a[7]-a[3]*a[5],s=a[2]*a[7]-a[3]*a[6],g=a[8]*a[13]-a[9]*a[12],m=a[8]*a[14]-a[10]*a[12],o=a[8]*a[15]-a[11]*a[12],u=a[9]*a[14]-a[10]*a[13],r=a[9]*a[15]-a[11]*a[13],B=a[10]*a[15]-a[11]*a[14],z=e*B-h*r+c*u+q*o-d*m+s*g;if(z!==0)return b===n&&(b=[]),b[0]=0+a[5]*B-a[6]*r+a[7]*u,b[4]=
0-a[4]*B+a[6]*o-a[7]*m,b[8]=0+a[4]*r-a[5]*o+a[7]*g,b[12]=0-a[4]*u+a[5]*m-a[6]*g,b[1]=0-a[1]*B+a[2]*r-a[3]*u,b[5]=0+a[0]*B-a[2]*o+a[3]*m,b[9]=0-a[0]*r+a[1]*o-a[3]*g,b[13]=0+a[0]*u-a[1]*m+a[2]*g,b[2]=0+a[13]*s-a[14]*d+a[15]*q,b[6]=0-a[12]*s+a[14]*c-a[15]*h,b[10]=0+a[12]*d-a[13]*c+a[15]*e,b[14]=0-a[12]*q+a[13]*h-a[14]*e,b[3]=0-a[9]*s+a[10]*d-a[11]*q,b[7]=0+a[8]*s-a[10]*c+a[11]*h,b[11]=0-a[8]*d+a[9]*c-a[11]*e,b[15]=0+a[8]*q-a[9]*h+a[10]*e,e=1/z,b[0]*=e,b[1]*=e,b[2]*=e,b[3]*=e,b[4]*=e,b[5]*=e,b[6]*=e,
b[7]*=e,b[8]*=e,b[9]*=e,b[10]*=e,b[11]*=e,b[12]*=e,b[13]*=e,b[14]*=e,b[15]*=e,b;return null},identity:function(a){if(a==n)return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=1;a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=1;a[11]=0;a[12]=0;a[13]=0;a[14]=0;a[15]=1},translate:function(a,b,e,h){a=[1,0,0,0,0,1,0,0,0,0,1,0,a,b,e,1];if(h===n)return a;m.multiply(h.slice(0),a,h)},rotateAxis:function(a,b,e,h,c){var q=Math.sin(a*(Math.PI/180)),a=Math.cos(a*(Math.PI/180)),b=[a+b*b*(1-a),b*e*
(1-a)-h*q,b*h*(1-a)+e*q,0,e*b*(1-a)+h*q,a+e*e*(1-a),e*h*(1-a)-b*q,0,h*b*(1-a)-e*q,h*e*(1-a)+b*q,a+h*h*(1-a),0,0,0,0,1];if(c===n)return b;m.multiply(c.slice(0),b,c)},rotate:function(a,b,e,h){var c;h===n&&(h=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);e!==0&&(c=Math.sin(e*(Math.PI/180)),e=Math.cos(e*(Math.PI/180)),m.multiply(h.slice(0),[e,c,0,0,-c,e,0,0,0,0,1,0,0,0,0,1],h));b!==0&&(c=Math.sin(b*(Math.PI/180)),e=Math.cos(b*(Math.PI/180)),m.multiply(h.slice(0),[e,0,-c,0,0,1,0,0,c,0,e,0,0,0,0,1],h));a!==0&&(c=
Math.sin(a*(Math.PI/180)),e=Math.cos(a*(Math.PI/180)),m.multiply(h.slice(0),[1,0,0,0,0,e,c,0,0,-c,e,0,0,0,0,1],h));return h},scale:function(a,b,e,h){if(h===n)return[a,0,0,0,0,b,0,0,0,0,e,0,0,0,0,1];m.multiply(h.slice(0),[a,0,0,0,0,b,0,0,0,0,e,0,0,0,0,1],h)}};x.prototype={setIdentity:function(){this.m_stack[this.c_stack]=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];this.valid===this.c_stack&&this.c_stack&&this.valid--;return this},getIdentity:function(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]},invalidate:function(){this.valid=
0;this.result=null;return this},getResult:function(){var a=CubicVR.mat4;if(!this.c_stack)return this.m_stack[0];var b=o;if(this.valid>this.c_stack-1)this.valid=this.c_stack-1;for(var e=this.valid;e<this.c_stack+1;e++)b=a.multiply(b,this.m_stack[e]),this.m_cache[e]=b;this.valid=this.c_stack-1;return this.result=this.m_cache[this.c_stack]},pushMatrix:function(a){this.c_stack++;this.m_stack[this.c_stack]=a?a:o;return this},popMatrix:function(){if(this.c_stack!==0)return this.c_stack--,this},clearStack:function(a){this.m_stack=
[];this.m_cache=[];this.valid=this.c_stack=0;this.result=null;a!==n?this.m_stack[0]=a:this.setIdentity();return this},translate:function(a,b,e){var h=CubicVR.mat4;if(typeof a==="object")return this.translate(a[0],a[1],a[2]);var c=this.getIdentity();c[12]=a;c[13]=b;c[14]=e;this.m_stack[this.c_stack]=h.multiply(this.m_stack[this.c_stack],c);this.valid===this.c_stack&&this.c_stack&&this.valid--;return this},scale:function(a,b,e){var h=CubicVR.mat4;if(typeof a==="object")return this.scale(a[0],a[1],a[2]);
var c=this.getIdentity();c[0]=a;c[5]=b;c[10]=e;this.m_stack[this.c_stack]=h.multiply(this.m_stack[this.c_stack],c);this.valid===this.c_stack&&this.c_stack&&this.valid--;return this},rotate:function(a,b,e,h){var c=CubicVR.mat4;if(typeof a==="object")return this.rotate(a[0],1,0,0),this.rotate(a[1],0,1,0),this.rotate(a[2],0,0,1),this;var q,d;if(b||e||h)q=Math.sin(-a*(Math.PI/180)),d=Math.cos(-a*(Math.PI/180));b&&(a=this.getIdentity(),a[5]=d*b,a[9]=q*b,a[6]=-q*b,a[10]=d*b,this.m_stack[this.c_stack]=c.multiply(a,
this.m_stack[this.c_stack]));e&&(b=this.getIdentity(),b[0]=d*e,b[8]=-q*e,b[2]=q*e,b[10]=d*e,this.m_stack[this.c_stack]=c.multiply(b,this.m_stack[this.c_stack]));h&&(e=this.getIdentity(),e[0]=d*h,e[4]=q*h,e[1]=-q*h,e[5]=d*h,this.m_stack[this.c_stack]=c.multiply(e,this.m_stack[this.c_stack]));this.valid===this.c_stack&&this.c_stack&&this.valid--;return this}};r.prototype={length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},normalize:function(){var a=Math.sqrt(this.length());
this.x/=a;this.y/=a;this.z/=a;this.w/=a},fromMatrix:function(a){var b=1+a[0]+a[5]+a[10],e,h,c;b>1.0E-8?(e=Math.sqrt(b)*2,b=(a[9]-a[6])/e,h=(a[2]-a[8])/e,c=(a[4]-a[1])/e,a=0.25*e):a[0]>a[5]&&a[0]>a[10]?(e=Math.sqrt(1+a[0]-a[5]-a[10])*2,b=0.25*e,h=(a[4]+a[1])/e,c=(a[2]+a[8])/e,a=(a[9]-a[6])/e):a[5]>a[10]?(e=Math.sqrt(1+a[5]-a[0]-a[10])*2,b=(a[4]+a[1])/e,h=0.25*e,c=(a[9]+a[6])/e,a=(a[2]-a[8])/e):(e=Math.sqrt(1+a[10]-a[0]-a[5])*2,b=(a[2]+a[8])/e,h=(a[9]+a[6])/e,c=0.25*e,a=(a[4]-a[1])/e);this.x=b;this.y=
h;this.z=c;this.w=a},fromEuler:function(a,b,e){var h=Math.cos(Math.PI/180*b/2),b=Math.sin(Math.PI/180*b/2),c=Math.cos(Math.PI/180*e/2),e=Math.sin(Math.PI/180*e/2),q=Math.cos(Math.PI/180*a/2),a=Math.sin(Math.PI/180*a/2),d=h*c,s=b*e;this.w=d*q-s*a;this.x=d*a+s*q;this.y=b*c*q+h*e*a;this.z=h*e*q-b*c*a},toEuler:function(){var a=this.w*this.w,b=this.x*this.x,e=this.y*this.y,h=this.z*this.z;return[180/Math.PI*Math.atan2(2*(this.y*this.z+this.x*this.w),-b-e+h+a),180/Math.PI*Math.asin(-2*(this.x*this.z-this.y*
this.w)),180/Math.PI*Math.atan2(2*(this.x*this.y+this.z*this.w),b-e-h+a)]},multiply:function(a,b){b===n&&(b=a,a=this);return new r(a.x*b.w+a.w*b.x+a.y*b.z-a.z*b.y,a.y*b.w+a.w*b.y+a.z*b.x-a.x*b.z,a.z*b.w+a.w*b.z+a.x*b.y-a.y*b.x,a.w*b.w-a.x*b.x-a.y*b.y-a.z*b.z)}};return{vec2:{equal:function(a,b,e){e===n&&(e=1.0E-8);if(a===n&&b===n)return!0;if(a===n||b===n)return!1;return Math.abs(a[0]-b[0])<e&&Math.abs(a[1]-b[1])<e}},vec3:d,mat3:{transpose_inline:function(a){var b=a[1],e=a[2],h=a[5];a[1]=a[3];a[2]=
a[6];a[3]=b;a[5]=a[7];a[6]=e;a[7]=h},vec3_multiply:function(a,b,e){e===n&&(e=[]);e[0]=b[0]*a[0]+b[3]*a[1]+b[6]*a[2];e[1]=b[1]*a[0]+b[4]*a[1]+b[7]*a[2];e[2]=b[2]*a[0]+b[5]*a[1]+b[8]*a[2];return e}},mat4:m,aabb:{engulf:function(a,b){a[0][0]>b[0]&&(a[0][0]=b[0]);a[0][1]>b[1]&&(a[0][1]=b[1]);a[0][2]>b[2]&&(a[0][2]=b[2]);a[1][0]<b[0]&&(a[1][0]=b[0]);a[1][1]<b[1]&&(a[1][1]=b[1]);a[1][2]<b[2]&&(a[1][2]=b[2])},reset:function(a,b){b===void 0&&(b=[0,0,0]);a[0][0]=b[0];a[0][1]=b[1];a[0][2]=b[2];a[1][0]=b[0];
a[1][1]=b[1];a[1][2]=b[2]},size:function(a){return[a[0][0]<a[1][0]?a[1][0]-a[0][0]:a[0][0]-a[1][0],a[0][1]<a[1][1]?a[1][1]-a[0][1]:a[0][1]-a[1][1],a[0][2]<a[1][2]?a[1][2]-a[0][2]:a[0][2]-a[1][2]]}},plane:{classifyPoint:function(a,b){var e=a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3];if(e<0)return-1;else if(e>0)return 1;return 0},normalize:function(a){var b=Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]);a[0]/=b;a[1]/=b;a[2]/=b;a[3]/=b}},sphere:{intersects:function(a,b){var e=CubicVR.vec3.subtract([a[0],a[1],a[2]],
[b[0],b[1],b[2]]),e=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]),h=a[3]+b[3];if(e*e<h*h)return!0;return!1}},triangle:{normal:function(a,b,e,h){h===n&&(h=[]);var c=a[0]-b[0],q=a[1]-b[1],a=a[2]-b[2],d=b[0]-e[0],s=b[1]-e[1],b=b[2]-e[2];h[0]=q*b-a*s;h[1]=a*d-c*b;h[2]=c*s-q*d;return h}},Transform:x,Quaternion:r}});CubicVR.RegisterModule("Mesh",function(v){function x(){this.points=[];this.point_normals=[];this.point_colors=[];this.uvs=[];this.normal=[0,0,0];this.segment=this.material=0}function r(g){this.points=[];this.faces=[];this.currentFace=-1;this.currentSegment=this.currentMaterial=0;this.bb=this.originBuffer=this.compiled=null;this.name=g?g:null;this.materials=[];this.morphTarget=this.morphTargets=this.bb=null;this.morphWeight=0;this.morphTargetIndex=this.morphSourceIndex=-1;this.instanceMaterials=null}
var n=v.undef,o=v.GLCore;x.prototype={setUV:function(g,d){d!==n?this.uvs[d]=g:g.length!==2?this.uvs=g:this.uvs.push(g)},setColor:function(g,d){d!==n?this.point_colors[d]=g:typeof colors[0]!=="number"?this.point_colors=g:this.point_colors.push(g)},flip:function(){for(var g=0,d=this.point_normals.length;g<d;g++)this.point_normals[g]=[-this.point_normals[g][0],-this.point_normals[g][1],-this.point_normals[g][2]];this.points.reverse();this.point_normals.reverse();this.uvs.reverse();this.normal=[-this.normal[0],
-this.normal[1],-this.normal[2]]}};r.prototype={showAllSegments:function(){for(var g in this.segment_state)this.segment_state.hasOwnProperty(g)&&(this.segment_state[g]=!0)},hideAllSegments:function(){for(var g in this.segment_state)this.segment_state.hasOwnProperty(g)&&(this.segment_state[g]=!1)},setSegment:function(g,d){d!==n?this.segment_state[g]=d:this.currentSegment=g},addPoint:function(g){if(g.length!==3||typeof g[0]==="object")for(var d=0,m=g.length;d<m;d++)this.points.push(g[d]);else this.points.push(g);
return this.points.length-1},getMaterialIndex:function(g){return this.materials.indexOf(g)},setFaceMaterial:function(g,d){typeof g=="number"?mat_id=g:(mat_id=this.materials.indexOf(g),mat_id===-1&&(this.materials.push(g),mat_id=this.materials.length-1));if(d!==n){if(this.faces[d]!==n)this.faces[d].material=mat_id}else this.currentMaterial=mat_id;return this},addFace:function(g,d,m,a){if(typeof g[0]!=="number"){d=0;for(m=g.length;d<m;d++)this.addFace(g[d])}else{d===n?(this.currentFace=this.faces.length,
this.faces.push(new x)):(this.faces[d]===n&&(this.faces[d]=new x),this.currentFace=d);if(typeof g==="object")this.faces[this.currentFace].points=g;m!==n?this.setFaceMaterial(m,this.currentFace):this.faces[this.currentFace].material=this.currentMaterial;this.faces[this.currentFace].segment=a!==n?a:this.currentSegment;return this.currentFace}},flipFaces:function(){for(var g=0,d=this.faces.length;g<d;g++)this.faces[g].flip()},triangulateQuads:function(){for(var g=0,d=this.faces.length;g<d;g++)if(this.faces[g].points.length===
4){var m=this.faces.length;this.addFace([this.faces[g].points[2],this.faces[g].points[3],this.faces[g].points[0]],this.faces.length,this.faces[g].material,this.faces[g].segment);this.faces[g].points.pop();this.faces[m].normal=this.faces[g].normal;this.faces[g].uvs!==n&&this.faces[g].uvs.length===4&&(this.faces[m].setUV(this.faces[g].uvs[2],0),this.faces[m].setUV(this.faces[g].uvs[3],1),this.faces[m].setUV(this.faces[g].uvs[0],2),this.faces[g].uvs.pop());this.faces[g].point_normals.length===4&&(this.faces[m].point_normals[0]=
this.faces[g].point_normals[2],this.faces[m].point_normals[1]=this.faces[g].point_normals[3],this.faces[m].point_normals[2]=this.faces[g].point_normals[0],this.faces[g].point_normals.pop())}return this},booleanAdd:function(g,d){var m=CubicVR.mat4,a=this.points.length,b,e,h,c;if(d!==n){e=d.getResult();b=0;for(h=g.points.length;b<h;b++)this.addPoint(m.vec3_multiply(g.points[b],e))}else{b=0;for(h=g.points.length;b<h;b++)this.addPoint([g.points[b][0],g.points[b][1],g.points[b][2]])}m=[];b=0;for(h=g.materials.length;b<
h;b++)e=this.materials.indexOf(g.materials[b]),e===-1?(this.materials.push(g.materials[b]),m[b]=this.materials.length-1):m[b]=e;b=0;for(h=g.faces.length;b<h;b++){var q=[];e=0;for(c=g.faces[b].points.length;e<c;e++)q.push(g.faces[b].points[e]+a);q=this.faces[this.addFace(q)];q.segment=g.faces[b].segment;q.material=m[g.faces[b].material];if(q.material===n)q.material=0;e=0;for(c=g.faces[b].uvs.length;e<c;e++)q.uvs[e]=[g.faces[b].uvs[e][0],g.faces[b].uvs[e][1]];e=0;for(c=g.faces[b].point_normals.length;e<
c;e++)q.point_normals[e]=[g.faces[b].point_normals[e][0],g.faces[b].point_normals[e][1],g.faces[b].point_normals[e][2]]}return this},calcFaceNormals:function(g,d){var m=CubicVR.vec3,a=CubicVR.triangle,b=0,e=this.faces.length;g&&(b=g);for(d&&(e=d+1);b<e;b++)this.faces[b].normal=this.faces[b].points.length<3?[0,0,0]:m.normalize(a.normal(this.points[this.faces[b].points[0]],this.points[this.faces[b].points[1]],this.points[this.faces[b].points[2]]));return this},getMaterial:function(g){for(var d=0,m=
this.materials.length;d<m;d++)if(this.materials[d].name===g)return this.materials[d];return null},bindInstanceMaterials:function(g){this.instanceMaterials=g},calcNormals:function(g){var d=CubicVR.vec3,m=!1;g!==n&&(m=!0);this.calcFaceNormals();var a,b,e,h,c=Array(this.points.length);a=0;for(h=c.length;a<h;a++)c[a]=[];e=this.faces.length;for(a=0;a<e;a++){h=this.faces[a].points.length;for(b=0;b<h;b++)c[this.faces[a].points[b]].push([a,b])}a=0;for(h=this.points.length;a<h;a++){var q=c[a].length;for(b=
0;b<q;b++){var t=1,s=c[a][b][0],o=c[a][b][1],A=this.materials.length?this.materials[this.faces[s].material].max_smooth:60,r=this.faces[s];m&&(g[s]===n&&(g[s]=[]),g[s][o]===n&&(g[s][o]=[]));var u=Array(3);u[0]=r.normal[0];u[1]=r.normal[1];u[2]=r.normal[2];if(A!==0)for(e=0;e<q;e++)if(b!==e){var D=c[a][e][0],B=this.faces[D],z=d.angle(B.normal,r.normal);if(z!==z||z*(180/Math.PI)<=A)m&&g[s][o].push(D),u[0]+=B.normal[0],u[1]+=B.normal[1],u[2]+=B.normal[2],t++}u[0]/=t;u[1]/=t;u[2]/=t;this.faces[s].point_normals[o]=
d.normalize(u)}}return this},recalcNormals:function(g){this.calcFaceNormals();for(var d=0,m=this.faces.length;d<m;d++)for(var a=this.faces[d],b=0,e=a.points.length;b<e;b++){var h=g[d][b],c=a.point_normals[b];c[0]=a.normal[0];c[1]=a.normal[1];c[2]=a.normal[2];for(var q=h.length,t=0;t<q;t++){var s=this.faces[h[t]];c[0]+=s.normal[0];c[1]+=s.normal[1];c[2]+=s.normal[2]}q!==0&&(c[0]/=q+1,c[1]/=q+1,c[2]/=q+1,h=Math.sqrt(c[0]*c[0]+c[1]*c[1]+c[2]*c[2]),c[0]/=h,c[1]/=h,c[2]/=h)}return this},removeDoubles:function(){var g=
[],d=[],m,a,b,e;m=0;for(a=this.points.length;m<a;m++){var h=-1,c=this.points[m];b=0;for(e=g.length;b<e;b++)if(CubicVR.vec3.equal(c,g[b])){h=b;break}h!=-1?d[m]=h:(d[m]=g.length,g.push(this.points[m]))}this.points=g;m=0;for(a=this.faces.length;m<a;m++){g=this.faces[m];b=0;for(e=g.points.length;b<e;b++)g.points[b]=d[g.points[b]]}},prepare:function(g){g===n&&(g=!0);this.calcNormals().triangulateQuads().compile();g&&this.clean();return this},clean:function(){var g,d;g=0;for(d=this.points.length;g<d;g++)delete this.points[g],
this.points[g]=null;this.points=[];g=0;for(d=this.faces.length;g<d;g++)delete this.faces[g].points,delete this.faces[g].point_normals,delete this.faces[g].uvs,delete this.faces[g].normal,delete this.faces[g],this.faces[g]=null;this.faces=[];return this},compileMap:function(g){var d=CubicVR.vec3,m=CubicVR.vec2;g===n&&(g=1.0E-5);var a={segments:[],bounds:[]},b=[],e,h,c,q,t,s,o,A;this.materials.length||this.materials.push(new CubicVR.Material);e=0;for(s=this.materials.length;e<s;e++)b[e]=[];e=0;for(s=
this.faces.length;e<s;e++)if(this.faces[e].points.length===3)c=this.faces[e].material,q=this.faces[e].segment,b[c][q]===n&&(b[c][q]=[],a.segments.push(q)),b[c][q].push(e);var r=[],u=0,D=!1,B=!1,z=!1,w;e=0;for(s=b.length;e<s;e++)for(h in b[e])if(b[e].hasOwnProperty(h))for(c=0;c<b[e][h].length;c++)w=b[e][h][c],D=D||this.faces[w].uvs.length!==0,B=B||this.faces[w].point_normals.length!==0,z=z||this.faces[w].point_colors.length!==0;if(D)for(e=0;e<this.faces.length;e++)if(!this.faces[e].uvs.length)for(h=
0;h<this.faces[e].points.length;h++)this.faces[e].uvs.push([0,0]);if(B)for(e=0;e<this.faces.length;e++)if(!this.faces[e].point_normals.length)for(h=0;h<this.faces[e].points.length;h++)this.faces[e].point_normals.push([0,0,0]);if(z)for(e=0;e<this.faces.length;e++)if(!this.faces[e].point_colors.length)for(h=0;h<this.faces[e].points.length;h++)this.faces[e].point_colors.push([0,0,0]);e=0;for(s=b.length;e<s;e++)for(h in b[e])if(b[e].hasOwnProperty(h)){c=0;for(o=b[e][h].length;c<o;c++){w=b[e][h][c];for(q=
0;q<3;q++){var y=this.faces[w].points[q],v=-1;if(r[y]!==n){t=0;for(A=r[y].length;t<A;t++){var C=r[y][t][0],x=r[y][t][1],v=r[y][t][2];B&&(v=d.equal(this.faces[C].point_normals[x],this.faces[w].point_normals[q],g)?v:-1);D&&(v=m.equal(this.faces[C].uvs[x],this.faces[w].uvs[q],g)?v:-1);z&&(v=d.equal(this.faces[C].point_colors[x],this.faces[w].point_colors[q],g)?v:-1)}}if(v!==-1){if(a.elements===n)a.elements=[];a.elements[e]===n&&(a.elements[e]=[]);a.elements[e][h]===n&&(a.elements[e][h]=[]);a.elements[e][h].push(v)}else{if(a.points===
n)a.points=[];a.points.push(y);a.bounds.length===0?(a.bounds[0]=[this.points[y][0],this.points[y][1],this.points[y][2]],a.bounds[1]=[this.points[y][0],this.points[y][1],this.points[y][2]]):(this.points[y][0]<a.bounds[0][0]&&(a.bounds[0][0]=this.points[y][0]),this.points[y][1]<a.bounds[0][1]&&(a.bounds[0][1]=this.points[y][1]),this.points[y][2]<a.bounds[0][2]&&(a.bounds[0][2]=this.points[y][2]),this.points[y][0]>a.bounds[1][0]&&(a.bounds[1][0]=this.points[y][0]),this.points[y][1]>a.bounds[1][1]&&(a.bounds[1][1]=
this.points[y][1]),this.points[y][2]>a.bounds[1][2]&&(a.bounds[1][2]=this.points[y][2]));if(B){if(a.normals===n)a.normals=[];a.normals.push([w,q])}if(z){if(a.colors===n)a.colors=[];a.colors.push([w,q])}if(D){if(a.uvs===n)a.uvs=[];a.uvs.push([w,q])}if(a.elements===n)a.elements=[];a.elements[e]===n&&(a.elements[e]=[]);a.elements[e][h]===n&&(a.elements[e][h]=[]);a.elements[e][h].push(u);r[y]===n&&(r[y]=[]);r[y].push([w,q,u]);u++}}}}a.elements||console.log(this);return a},compileVBO:function(g,d,m,a,
b,e){typeof d=="object"?(d=d.element!==n?d.element:!0,m=d.vertex!==n?d.vertex:!0,e=d.color!==n?d.color:!0,a=d.normal!==n?d.normal:!0,b=d.uv!==n?d.uv:!0):(d===n&&(d=!0),m===n&&(m=!0),e===n&&(e=!0),a===n&&(a=!0),b===n&&(b=!0));var h={},c,q,t;if(g.points&&m){c=g.points.length;h.vbo_points=new Float32Array(c*3);for(m=q=0;m<c;m++)t=g.points[m],h.vbo_points[q++]=this.points[t][0],h.vbo_points[q++]=this.points[t][1],h.vbo_points[q++]=this.points[t][2]}if(g.normals&&a){c=g.normals.length;h.vbo_normals=new Float32Array(c*
3);for(m=q=0;m<c;m++)t=g.normals[m],h.vbo_normals[q++]=this.faces[t[0]].point_normals[t[1]][0],h.vbo_normals[q++]=this.faces[t[0]].point_normals[t[1]][1],h.vbo_normals[q++]=this.faces[t[0]].point_normals[t[1]][2]}if(g.colors&&e){c=g.colors.length;h.vbo_colors=new Float32Array(c*3);for(m=q=0;m<c;m++)t=g.colors[m],h.vbo_colors[q++]=this.faces[t[0]].point_colors[t[1]][0],h.vbo_colors[q++]=this.faces[t[0]].point_colors[t[1]][1],h.vbo_colors[q++]=this.faces[t[0]].point_colors[t[1]][2]}if(g.uvs&&b){c=g.uvs.length;
h.vbo_uvs=new Float32Array(c*2);for(m=q=0;m<c;m++)t=g.uvs[m],h.vbo_uvs[q++]=this.faces[t[0]].uvs[t[1]][0],h.vbo_uvs[q++]=this.faces[t[0]].uvs[t[1]][1]}if(d){h.elements_ref=[];h.vbo_elements=[];m=0;for(c=g.elements.length;m<c;m++){h.elements_ref[m]=[];var d=0,s;for(s in g.elements[m])if(g.elements[m].hasOwnProperty(s)){a=g.elements[m][s];k=0;for(kMax=a.length;k<kMax;k++)h.vbo_elements.push(a[k]);h.elements_ref[m][d]=[s|0,a.length|0];d++}}h.vbo_elements=new Uint16Array(h.vbo_elements)}h.segments=g.segments;
h.bounds=g.bounds;return h},bufferVBO:function(g,d){var m=o.gl,a={};d===n&&(d={});a.gl_points=m.createBuffer();m.bindBuffer(m.ARRAY_BUFFER,a.gl_points);m.bufferData(m.ARRAY_BUFFER,g.vbo_points,m.STATIC_DRAW);g.vbo_normals?(a.gl_normals=m.createBuffer(),m.bindBuffer(m.ARRAY_BUFFER,a.gl_normals),m.bufferData(m.ARRAY_BUFFER,g.vbo_normals,m.STATIC_DRAW)):a.gl_normals=d.gl_normals?d.gl_normals:null;g.vbo_uvs?(a.gl_uvs=m.createBuffer(),m.bindBuffer(m.ARRAY_BUFFER,a.gl_uvs),m.bufferData(m.ARRAY_BUFFER,g.vbo_uvs,
m.STATIC_DRAW)):a.gl_uvs=d.gl_uvs?d.gl_uvs:null;g.vbo_colors?(a.gl_colors=m.createBuffer(),m.bindBuffer(m.ARRAY_BUFFER,a.gl_colors),m.bufferData(m.ARRAY_BUFFER,g.vbo_colors,m.STATIC_DRAW)):a.gl_colors=d.gl_colors?d.gl_colors:null;!g.vbo_elements&&d.gl_elements?(a.gl_elements=d.gl_elements,a.elements_ref=d.elements_ref):(a.gl_elements=m.createBuffer(),m.bindBuffer(m.ELEMENT_ARRAY_BUFFER,a.gl_elements),m.bufferData(m.ELEMENT_ARRAY_BUFFER,g.vbo_elements,m.STATIC_DRAW),a.elements_ref=g.elements_ref);
a.segments=g.segments;a.bounds=g.bounds;d.elements_ref&&!g.elements_ref&&m.bindBuffer(m.ELEMENT_ARRAY_BUFFER,null);return a},bindBuffer:function(g){if(this.originBuffer===null)this.originBuffer=g;this.compiled=g;this.segment_state=[];for(var d=0,m=g.segments.length;d<m;d++)this.segment_state[g.segments[d]]=!0;this.bb=g.bounds},compile:function(g){this.bindBuffer(this.bufferVBO(this.compileVBO(this.compileMap(g))));return this},addMorphTarget:function(g){if(this.morphTargets===null)this.morphTargets=
[];this.morphTargets.push(g)},setMorphSource:function(g){if(this.morphSourceIndex!==g)this.morphSourceIndex=g,this.bindBuffer(this.morphTargets[g])},setMorphTarget:function(g){if(this.morphTargetIndex!==g)this.morphTargetIndex=g,this.morphTarget=this.morphTargets[g]},setMorphWeight:function(g){this.morphWeight=g},morphTargetCount:function(){return this.morphTargets!==null?this.morphTargets.length:0}};return{Mesh:r,Face:x}});CubicVR.RegisterModule("Motion",function(v){function x(){this.time=this.value=0;this.shape=g.envelope.shape.TCB;this.bias=this.continuity=this.tension=0;this.next=this.prev=null;this.param=[0,0,0,0]}function r(a){this.nKeys=0;this.lastKey=this.firstKey=this.keys=null;a?(this.in_behavior=a.in_behavior?a.in_behavior:g.envelope.behavior.CONSTANT,this.out_behavior=a.out_behavior?a.out_behavior:g.envelope.behavior.CONSTANT):this.out_behavior=this.in_behavior=g.envelope.behavior.CONSTANT}function n(a,c){this.env_init=
a;this.key_init=c;this.controllers=[];this.yzflip=!1}var o=v.undef,g=CubicVR.enums;g.motion={POS:0,ROT:1,SCL:2,FOV:3,LENS:4,NEARCLIP:5,FARCLIP:6,INTENSITY:7,X:0,Y:1,Z:2,V:3};g.envelope={shape:{TCB:0,HERM:1,BEZI:2,LINE:3,STEP:4,BEZ2:5},behavior:{RESET:0,CONSTANT:1,REPEAT:2,OSCILLATE:3,OFFSET:4,LINEAR:5}};var d=function(a,c,b){var e=0,e=b-c;if(e===0)return[c,0];c=a-e*Math.floor((a-c)/e);e=-parseInt((c-a)/e+(c>a?0.5:-0.5),10);return[c,e]},m=function(a,c,b,e,d){var g,m;m=d*d;g=3*(c-a);c=3*(b-c)-g;return(e-
a-g-c)*m*d+c*m+g*d+a},a=function(b,c,q,e,d,g,o){var n,u;u=g+(o-g)*0.5;n=m(b,c,q,e,u);return Math.abs(d-n)>1.0E-4?(n>d?o=u:g=u,a(b,c,q,e,d,g,o)):u},b=function(a,c){var b,e,d,m;a.shape===g.envelope.shape.TCB?(b=(1-a.tension)*(1+a.continuity)*(1+a.bias),e=(1-a.tension)*(1-a.continuity)*(1-a.bias),d=c.value-a.value,a.prev?(m=(c.time-a.time)/(c.time-a.prev.time),b=m*(b*(a.value-a.prev.value)+e*d)):b=e*d):a.shape===g.envelope.shape.LINE?(d=c.value-a.value,a.prev?(m=(c.time-a.time)/(c.time-a.prev.time),
b=m*(a.value-a.prev.value+d)):b=d):a.shape===g.envelope.shape.BEZI||a.shape===g.envelope.shape.HERM?(b=a.param[1],a.prev&&(b*=(c.time-a.time)/(c.time-a.prev.time))):a.shape===g.envelope.shape.BEZ2?(b=a.param[3]*(c.time-a.time),Math.abs(a.param[2])>1.0E-5?b/=a.param[2]:b*=1E5):b=0;return b},e=function(a,c){var b,e,d,m;c.shape===g.envelope.shape.LINE?(d=c.value-a.value,c.next?(m=(c.time-a.time)/(c.next.time-a.time),b=m*(c.next.value-c.value+d)):b=d):c.shape===g.envelope.shape.TCB?(b=(1-c.tension)*(1-
c.continuity)*(1+c.bias),e=(1-c.tension)*(1+c.continuity)*(1-c.bias),d=c.value-a.value,c.next?(m=(c.time-a.time)/(c.next.time-a.time),b=m*(e*(c.next.value-c.value)+b*d)):b*=d):c.shape===g.envelope.shape.HERM||c.shape===g.envelope.shape.BEZI?(b=c.param[0],c.next&&(b*=(c.time-a.time)/(c.next.time-a.time))):c.shape===g.envelope.shape.BEZ2?(b=c.param[1]*(c.time-a.time),Math.abs(c.param[0])>1.0E-5?b/=c.param[0]:b*=1E5):b=0;return b};r.prototype={setBehavior:function(a,c){this.in_behavior=a;this.out_behavior=
c},empty:function(){return this.nKeys===0},addKey:function(a,c,b){var e=typeof a=="object"?a:b;c||(c=0);a||(a=0);e?(e=a,a=e.time,b=this.insertKey(a),b.value=e.value?e.value:c,b.time=e.time?e.time:a,b.shape=e.shape?e.shape:g.envelope.shape.TCB,b.tension=e.tension?e.tension:0,b.continuity=e.continuity?e.continuity:0,b.bias=e.bias?e.bias:0,b.param=e.param?e.param:[0,0,0,0]):(b=this.insertKey(a),b.value=c);return b},insertKey:function(a){var c=new x;c.time=a;if(!this.nKeys)return this.lastKey=this.firstKey=
this.keys=c,this.nKeys++,c;for(var b=this.keys;b;){if(this.firstKey.time>a)this.firstKey=c;else if(this.lastKey.time<a)this.lastKey=c;if(b.time>c.time){c.prev=b.prev;if(c.prev)c.prev.next=c;c.next=b;c.next.prev=c;this.nKeys++;return c}else if(!b.next)return c.prev=b,b.next=c,this.nKeys++,c;b=b.next}return null},evaluate:function(h){var c,q,t,s,o,A=0;if(this.nKeys===0)return 0;if(this.nKeys===1)return this.keys.value;q=this.firstKey;c=this.lastKey;if(h<q.time)if(s=this.in_behavior,s===g.envelope.behavior.RESET)return 0;
else if(s===g.envelope.behavior.CONSTANT)return q.value;else if(s===g.envelope.behavior.REPEAT)s=d(h,q.time,c.time),h=s[0];else if(s===g.envelope.behavior.OCILLATE)s=d(h,q.time,c.time),h=s[0],s=s[1],s%2&&(h=c.time-q.time-h);else if(s===g.envelope.behavior.OFFSET)s=d(h,q.time,c.time),h=s[0],s=s[1],A=s*(c.value-q.value);else{if(s===g.envelope.behavior.LINEAR)return o=b(q,q.next)/(q.next.time-q.time),o*(h-q.time)+q.value}else if(h>c.time)if(s=this.out_behavior,s===g.envelope.behavior.RESET)return 0;
else if(s===g.envelope.behavior.CONSTANT)return c.value;else if(s===g.envelope.behavior.REPEAT)s=d(h,q.time,c.time),h=s[0];else if(s===g.envelope.behavior.OCILLATE)s=d(h,q.time,c.time),h=s[0],s=s[1],s%2&&(h=c.time-q.time-h);else if(s===g.envelope.behavior.OFFSET)s=d(h,q.time,c.time),h=s[0],s=s[1],A=s*(c.value-q.value);else if(s===g.envelope.behavior.LINEAR)return s=e(c.prev,c)/(c.time-c.prev.time),s*(h-c.time)+c.value;if(this.lastKey0)if(h>this.lastKey0.time)c=this.lastKey0;else if(h<this.lastKey0.time)for(c=
this.lastKey;h<c.time&&c.prev;)c=c.prev;else c=this.keys;else c=this.keys;for(;h>c.next.time;)c=c.next;q=c.next;this.lastKey0=c;if(h===c.time)return c.value+A;else if(h===q.time)return q.value+A;t=(h-c.time)/(q.time-c.time);s=q.shape;if(s===g.envelope.shape.TCB||s===g.envelope.shape.BEZI||s===g.envelope.shape.HERM){o=b(c,q);s=e(c,q);var n,u;u=t*t;n=t*u;h=3*u-n-n;n-=u;h=[1-h,h,n-u+t,n];return h[0]*c.value+h[1]*q.value+h[2]*o+h[3]*s+A}else return s===g.envelope.shape.BEZ2?(h=a(c.time,c.shape===g.envelope.shape.BEZ2?
c.time+c.param[2]:c.time+(q.time-c.time)/3,q.time+q.param[0],q.time,h,0,1),A=m(c.value,c.shape===g.envelope.shape.BEZ2?c.value+c.param[3]:c.value+c.param[1]/3,q.param[1]+q.value,q.value,h)+A):A=s===g.envelope.shape.LINE?c.value+t*(q.value-c.value)+A:s===g.envelope.shape.STEP?c.value+A:A,A}};n.prototype={envelope:function(a,c){this.controllers[a]===o&&(this.controllers[a]=[]);this.controllers[a][c]===o&&(this.controllers[a][c]=new r(this.env_init));return this.controllers[a][c]},evaluate:function(a){var c=
[],b;for(b in this.controllers)if(this.controllers.hasOwnProperty(b)){c[b]=[];for(var e in this.controllers[b])this.controllers[b].hasOwnProperty(e)&&(c[b][e]=this.controllers[b][e].evaluate(a))}return c},apply:function(a,c){for(var b in this.controllers)if(this.controllers.hasOwnProperty(b)){var e=parseInt(b,10);if(this.yzflip&&e===g.motion.ROT){if(!this.q)this.q=new CubicVR.Quaternion;var d=this.q,m=this.controllers[b][0].evaluate(a),o=this.controllers[b][1].evaluate(a),n=this.controllers[b][2].evaluate(a);
d.fromEuler(m,n,-o);d=d.toEuler();c.control(e,0,d[0]);c.control(e,1,d[1]);c.control(e,2,d[2])}else for(var u in this.controllers[b])this.controllers[b].hasOwnProperty(u)&&c.control(e,parseInt(u,10),this.controllers[b][u].evaluate(a))}},setKey:function(a,c,b,e,d){return this.envelope(a,c).addKey(b,e,d?d:this.key_init)},setArray:function(a,c,b,e){var d=[],g;for(g in b)if(b.hasOwnProperty(g)){var m=this.envelope(a,g);d[g]=m.addKey(c,b[g],e?e:this.key_init)}return d},setBehavior:function(a,c,b,e){this.envelope(a,
c).setBehavior(b,e)},setBehaviorArray:function(a,c,b){for(var e in this.controllers[a])this.controllers[a].hasOwnProperty(e)&&this.envelope(a,e).setBehavior(c,b)}};return{Motion:n,Envelope:r,EnvelopeKey:x}});CubicVR.RegisterModule("Octree",function(v){function x(a,b,e,h,c){var q=this._children=[];this._dirty=!1;q[0]=null;q[1]=null;q[2]=null;q[3]=null;q[4]=null;q[5]=null;q[6]=null;q[7]=null;this._child_index=c||-1;this._root=e||null;this._max_depth=b||0;a=this._size=a||0;h=this._position=h||[0,0,0];this._nodes=[];this._lights=[];this._static_lights=[];this._sphere=[h[0],h[1],h[2],Math.sqrt(3*(this._size/2*this._size/2))];b=this._bbox=[[0,0,0],[0,0,0]];e=CubicVR.aabb;e.reset(b,h);a/=2;e.engulf(b,[h[0]+
a,h[1]+a,h[2]+a]);e.engulf(b,[h[0]-a,h[1]-a,h[2]-a]);this._debug_visible=!1}function r(){this.position=[0,0,0];this.visible=!1;this._object=null}function n(){this.last_in=[];this._planes=[];this.sphere=null;for(var a=0;a<6;++a)this._planes[a]=[0,0,0,0]}var o=v.undef,g=CubicVR.plane,d=CubicVR.sphere,m=CubicVR.enums;m.frustum={plane:{LEFT:0,RIGHT:1,TOP:2,BOTTOM:3,NEAR:4,FAR:5}};m.octree={TOP_NW:0,TOP_NE:1,TOP_SE:2,TOP_SW:3,BOTTOM_NW:4,BOTTOM_NE:5,BOTTOM_SE:6,BOTTOM_SW:7};Array_remove=function(a,b,e){e=
a.slice((e||b)+1||a.length);a.length=b<0?a.length+b:b;return a.push.apply(a,e)};x.prototype.destroy=function(){var a,b,e;a=0;for(b=this._static_lights.length;a<b;++a)e=this._static_lights[a],e.octree_leaves=null,e.octree_common_root=null,e.octree_aabb=null;a=0;for(b=this._lights.length;a<b;++a)e=this._lights[a],e.octree_leaves=null,e.octree_common_root=null,e.octree_aabb=null;this._lights=this._static_lights=null;a=0;for(b=this._children.length;a<b;++a)this._children[a]!==null&&this._children[a].destroy();
a=0;for(b=this._nodes.length;a<b;++a)e=this._nodes[a],e.octree_leaves=null,e.octree_common_root=null,e.octree_aabb=null,e.dynamic_lights=[],e.static_lights=[];this._children[0]=null;this._children[1]=null;this._children[2]=null;this._children[3]=null;this._children[4]=null;this._children[5]=null;this._children[6]=null;this._bbox=this._sphere=this._static_lights=this._lights=this._nodes=this._position=this._root=this._children=this._children[7]=null};x.prototype.toString=function(){return"[Octree: @"+
this._position+", depth: "+this._max_depth+", size: "+this._size+", nodes: "+this._nodes.length+", measured size:"+[this._bbox[1][0]-this._bbox[0][0],this._bbox[1][2]-this._bbox[0][2]]+"]"};x.prototype.remove=function(a){var b=!1,e=this._nodes.length,h;h=e-1;for(e=this._nodes.length;h>=0;--h)if(a===this._nodes[h]){Array_remove(this._nodes,h);this.dirty_lineage();b=!0;break}if(!b)for(h=e-1;h>=0;--h)if(a===this._lights[h]){Array_remove(this._lights,h);this.dirty_lineage();break}};x.prototype.dirty_lineage=
function(){this._dirty=!0;this._root!==null&&this._root.dirty_lineage()};x.prototype.cleanup=function(){for(var a=this._children.length,b=0,e=0;e<a;++e){var h=this._children[e];if(h!==null){var c=!0;h._dirty===!0&&(c=h.cleanup());c?++b:this._children[e]=null}}if(this._nodes.length===0&&this._static_lights.length===0&&this._lights.length===0&&(b===0||a===0))return!1;return!0};x.prototype.insert_light=function(a){this.insert(a,!0)};x.prototype.propagate_static_light=function(a){var b,e;b=0;for(e=this._nodes.length;b<
e;++b)this._nodes[b].static_lights.indexOf(a)===-1&&this._nodes[b].static_lights.push(a);for(b=0;b<8;++b)this._children[b]!==null&&this._children[b].propagate_static_light(a)};x.prototype.collect_static_lights=function(a){var b,e;b=0;for(e=this._static_lights.length;b<e;++b)a.static_lights.indexOf(this._static_lights[b])===-1&&a.static_lights.push(this._static_lights[b]);for(b=0;b<8;++b)this._children[b]!==null&&this._children[b].collect_static_lights(a)};x.prototype.insert=function(a,b){function e(a,
c,b,q){var e,h;if(b)if(c.method===m.light.method.STATIC){a._static_lights.indexOf(c)===-1&&a._static_lights.push(c);b=0;for(e=a._nodes.length;b<e;++b)a._nodes[b].static_lights.indexOf(c)===-1&&a._nodes[b].static_lights.push(c);for(h=a._root;h!==null;){b=0;for(l=h._nodes.length;b<l;++b)e=h._nodes[b],e.static_lights.indexOf(c)===-1&&e.static_lights.push(c);h=h._root}}else a._lights.indexOf(c)===-1&&a._lights.push(c);else{a._nodes.push(c);b=0;for(e=a._static_lights.length;b<e;++b)c.static_lights.indexOf(a._static_lights[b])===
-1&&c.static_lights.push(a._static_lights[b]);for(h=a._root;h!==null;){b=0;for(e=h._static_lights.length;b<e;++b){var d=h._static_lights[b];c.static_lights.indexOf(d)===-1&&c.static_lights.push(d)}h=h._root}}c.octree_leaves.push(a);c.octree_common_root=q;q=CubicVR.aabb;q.engulf(c.octree_aabb,a._bbox[0]);q.engulf(c.octree_aabb,a._bbox[1])}b===o&&(b=!1);if(this._root===null)a.octree_leaves=[],a.octree_common_root=null;if(this._max_depth===0)e(this,a,b,this._root);else{var h=this._position,c,q,d,s,g,
n,r;q=a.getAABB();r=[q[0][0],q[0][1],q[0][2]];var u=[q[1][0],q[1][1],q[1][2]];c=r[0]<h[0]&&r[1]<h[1]&&r[2]<h[2];q=u[0]>h[0]&&r[1]<h[1]&&r[2]<h[2];g=r[0]<h[0]&&u[1]>h[1]&&r[2]<h[2];n=u[0]>h[0]&&u[1]>h[1]&&r[2]<h[2];d=r[0]<h[0]&&r[1]<h[1]&&u[2]>h[2];s=u[0]>h[0]&&r[1]<h[1]&&u[2]>h[2];r=r[0]<h[0]&&u[1]>h[1]&&u[2]>h[2];h=u[0]>h[0]&&u[1]>h[1]&&u[2]>h[2];if(c&&q&&g&&n&&d&&s&&r&&h)e(this,a,b,this),b?a.method==m.light.method.STATIC&&this.propagate_static_light(a):this.collect_static_lights(a);else{for(var u=
0,D=this._static_lights.length;u<D;++u){if(a.static_lights===o)a.static_lights=[];a.static_lights.indexOf(this._static_lights[u])===-1&&a.static_lights.push(this._static_lights[u])}var u=this._size/2,D=this._size/4,B=0,z=this._position[0],w=this._position[1],y=this._position[2];c&&(c=[z-D,w-D,y-D],this._children[m.octree.TOP_NW]===null&&(this._children[m.octree.TOP_NW]=new x(u,this._max_depth-1,this,c,m.octree.TOP_NW)),this._children[m.octree.TOP_NW].insert(a,b),++B);q&&(c=[z+D,w-D,y-D],this._children[m.octree.TOP_NE]===
null&&(this._children[m.octree.TOP_NE]=new x(u,this._max_depth-1,this,c,m.octree.TOP_NE)),this._children[m.octree.TOP_NE].insert(a,b),++B);g&&(c=[z-D,w+D,y-D],this._children[m.octree.BOTTOM_NW]===null&&(this._children[m.octree.BOTTOM_NW]=new x(u,this._max_depth-1,this,c,m.octree.BOTTOM_NW)),this._children[m.octree.BOTTOM_NW].insert(a,b),++B);n&&(c=[z+D,w+D,y-D],this._children[m.octree.BOTTOM_NE]===null&&(this._children[m.octree.BOTTOM_NE]=new x(u,this._max_depth-1,this,c,m.octree.BOTTOM_NE)),this._children[m.octree.BOTTOM_NE].insert(a,
b),++B);d&&(c=[z-D,w-D,y+D],this._children[m.octree.TOP_SW]===null&&(this._children[m.octree.TOP_SW]=new x(u,this._max_depth-1,this,c,m.octree.TOP_SW)),this._children[m.octree.TOP_SW].insert(a,b),++B);s&&(c=[z+D,w-D,y+D],this._children[m.octree.TOP_SE]===null&&(this._children[m.octree.TOP_SE]=new x(u,this._max_depth-1,this,c,m.octree.TOP_SE)),this._children[m.octree.TOP_SE].insert(a,b),++B);r&&(c=[z-D,w+D,y+D],this._children[m.octree.BOTTOM_SW]===null&&(this._children[m.octree.BOTTOM_SW]=new x(u,
this._max_depth-1,this,c,m.octree.BOTTOM_SW)),this._children[m.octree.BOTTOM_SW].insert(a,b),++B);h&&(c=[z+D,w+D,y+D],this._children[m.octree.BOTTOM_SE]===null&&(this._children[m.octree.BOTTOM_SE]=new x(u,this._max_depth-1,this,c,m.octree.BOTTOM_SE)),this._children[m.octree.BOTTOM_SE].insert(a,b),++B);if(B>1||a.octree_common_root===null)a.octree_common_root=this}}};x.prototype.draw_on_map=function(a,b,e){function h(a,e,h,d,s){var g=a<h?a:h,t=e<d?e:d,a=a<h?h-a:a-h,e=e<d?d-e:e-d;b.save();if(s!==void 0)b.fillStyle=
s,b.fillRect(c+g,q+t,a,e);b.strokeRect(c+g,q+t,a,e);b.restore()}var c=a.width/2,q=a.height/2,d,s,g,m,n,u,r;if(e===o||e==="map")b.save(),this._debug_visible!==!1?(b.fillStyle="rgba(0,0,0,0)",b.strokeStyle="#FF0000"):(b.fillStyle="rgba(0,0,0,0)",b.strokeStyle="rgba(0,0,0,0)"),b.beginPath(),n=this._size/2,d=this._position[0],s=this._position[2],b.moveTo(c+d-n,c+s-n),b.lineTo(c+d-n,c+s+n),b.lineTo(c+d+n,c+s+n),b.lineTo(c+d+n,c+s-n),b.stroke(),b.fill(),b.restore();if(e===o||e==="objects"){b.save();n=0;
for(r=this._nodes.length;n<r;++n)u=this._nodes[n],b.fillStyle="#5500FF",b.strokeStyle=u.visible===!0&&u.culled===!1?"#FFFFFF":"#000000",b.beginPath(),d=u.aabb[0][0],s=u.aabb[0][2],g=u.aabb[1][0]-d,m=u.aabb[1][2]-s,b.rect(c+d,q+s,g,m),b.stroke();b.restore()}if(e===o||e==="lights"){n=0;for(r=this._lights.length;n<r;++n)m=this._lights[n],b.fillStyle=m.culled===!1&&m.visible===!0?"rgba(255, 255, 255, 0.1)":"rgba(255, 255, 255, 0.0)",b.strokeStyle="#FFFF00",b.beginPath(),u=m.distance,d=m.position[0],s=
m.position[2],b.arc(c+d,q+s,u,0,Math.PI*2,!0),b.closePath(),b.stroke(),b.fill(),b.beginPath(),d=m.aabb[0][0],s=m.aabb[0][2],g=m.aabb[1][0]-d,m=m.aabb[1][2]-s,b.rect(c+d,q+s,g,m),b.closePath(),b.stroke();n=0;for(r=this._static_lights.length;n<r;++n)m=this._static_lights[n],b.fillStyle=m.culled===!1&&m.visible===!0?"rgba(255, 255, 255, 0.01)":"rgba(255, 255, 255, 0.0)",b.strokeStyle="#FF66BB",b.beginPath(),u=m.distance,d=m.position[0],s=m.position[2],b.arc(c+d,q+s,u,0,Math.PI*2,!0),b.closePath(),b.stroke(),
b.fill(),b.beginPath(),d=m.aabb[0][0],s=m.aabb[0][2],g=m.aabb[1][0]-d,m=m.aabb[1][2]-s,b.rect(c+d,q+s,g,m),b.closePath(),b.stroke()}if(e!="lights"&&e!="objects"&&e!="map"){b.save();d=this._nodes;n=0;for(m=d.length;n<m;++n)if(u=d[n],u.name==e){b.strokeStyle="#FFFF00";b.lineWidth=3;b.beginPath();d=u.aabb[0][0];s=u.aabb[0][2];g=u.aabb[1][0]-d;m=u.aabb[1][2]-s;b.rect(c+d,q+s,g,m);b.closePath();b.stroke();d=u.octree_aabb;b.strokeStyle="#0000FF";h(d[0][0],d[0][2],d[1][0],d[1][2]);b.lineWidth=1;if(u.common_root!==
null)b.strokeStyle="#00FF00";break}b.lineWidth=1;b.strokeStyle="#FFFF00";h(this._bbox[0][0],this._bbox[0][2],this._bbox[1][0],this._bbox[1][2],"#444444");b.fill();b.restore()}n=0;for(r=this._children.length;n<r;++n)this._children[n]!==null&&this._children[n].draw_on_map(a,b,e)};x.prototype.contains_point=function(a){return a[0]<=this._position[0]+this._size/2&&a[1]<=this._position[1]+this._size/2&&a[2]<=this._position[2]+this._size/2&&a[0]>=this._position[0]-this._size/2&&a[1]>=this._position[1]-
this._size/2&&a[2]>=this._position[2]-this._size/2};x.prototype.get_frustum_hits=function(a,b){var e={objects:[],lights:[]};if((b===o||b===!0)&&!this.contains_point(a.position)){if(d.intersects(a.frustum.sphere,this._sphere)===!1)return e;var h=a.frustum.contains_sphere(this._sphere);if(h===-1)return this._debug_visible=!1,e;else if(h===1)this._debug_visible=2,b=!1;else if(h===0)if(this._debug_visible=!0,h=a.frustum.contains_box(this._bbox),h===-1)return this._debug_visible=!1,e;else if(h===1)this._debug_visible=
3,b=!1}var c,q,h=0;for(c=this._nodes.length;h<c;++h)q=this._nodes[h],e.objects.push(q),q.dynamic_lights=[].concat(this._lights),q.was_culled=q.culled,q.culled=!1,q.drawn_this_frame=!1;this._debug_visible=this._lights.length>0?4:this._debug_visible;h=0;for(c=this._lights.length;h<c;++h)if(q=this._lights[h],q.visible===!0)e.lights.push(q),q.was_culled=q.culled,q.culled=!1;h=0;for(c=this._static_lights.length;h<c;++h)if(q=this._static_lights[h],q.visible===!0)q.culled=!1;for(h=0;h<8;++h)if(this._children[h]!==
null){c=this._children[h].get_frustum_hits(a,b);var g;q=0;for(g=c.objects.length;q<g;++q){e.objects.push(c.objects[q]);for(var s=c.objects[q].dynamic_lights,m=0,n=this._lights.length;m<n;++m)s.indexOf(this._lights[m])<0&&s.push(this._lights[m])}q=0;for(g=c.lights.length;q<g;++q)e.lights.indexOf(c.lights[q])<0&&e.lights.push(c.lights[q])}return e};x.prototype.reset_node_visibility=function(){this._debug_visible=!1;var a,b;a=0;for(b=this._nodes.length;a<b;++a)this._nodes[a].culled=!0;a=0;for(b=this._lights.length;a<
b;++a)this._lights[a].culled=!0;a=0;for(b=this._static_lights.length;a<b;++a)this._static_lights[a].culled=!0;a=0;for(b=this._children.length;a<b;++a)this._children[a]!==null&&this._children[a].reset_node_visibility()};r.prototype.toString=function(){return"[OctreeNode "+this.position+"]"};r.prototype.attach=function(a){this._object=a};n.prototype.extract=function(a,b,e){var h=CubicVR.vec3;if(!(b===o||e===o)){var c=CubicVR.mat4.multiply(e,b),b=this._planes;b[m.frustum.plane.LEFT][0]=c[3]+c[0];b[m.frustum.plane.LEFT][1]=
c[7]+c[4];b[m.frustum.plane.LEFT][2]=c[11]+c[8];b[m.frustum.plane.LEFT][3]=c[15]+c[12];b[m.frustum.plane.RIGHT][0]=c[3]-c[0];b[m.frustum.plane.RIGHT][1]=c[7]-c[4];b[m.frustum.plane.RIGHT][2]=c[11]-c[8];b[m.frustum.plane.RIGHT][3]=c[15]-c[12];b[m.frustum.plane.TOP][0]=c[3]-c[1];b[m.frustum.plane.TOP][1]=c[7]-c[5];b[m.frustum.plane.TOP][2]=c[11]-c[9];b[m.frustum.plane.TOP][3]=c[15]-c[13];b[m.frustum.plane.BOTTOM][0]=c[3]+c[1];b[m.frustum.plane.BOTTOM][1]=c[7]+c[5];b[m.frustum.plane.BOTTOM][2]=c[11]+
c[9];b[m.frustum.plane.BOTTOM][3]=c[15]+c[13];b[m.frustum.plane.NEAR][0]=c[3]+c[2];b[m.frustum.plane.NEAR][1]=c[7]+c[6];b[m.frustum.plane.NEAR][2]=c[11]+c[10];b[m.frustum.plane.NEAR][3]=c[15]+c[14];b[m.frustum.plane.FAR][0]=c[3]-c[2];b[m.frustum.plane.FAR][1]=c[7]-c[6];b[m.frustum.plane.FAR][2]=c[11]-c[10];b[m.frustum.plane.FAR][3]=c[15]-c[14];for(var q=0;q<6;++q)g.normalize(b[q]);q=-b[m.frustum.plane.NEAR][3];b=b[m.frustum.plane.FAR][3]-q;e=b*(1/e[5]);e=h.subtract([0,0,q+b*0.5],[e,e,q+b]);e=h.length(e);
c=[c[3],c[9],c[10]];q=h.length(c);c=h.multiply(c,1/q);a=[a.position[0],a.position[1],a.position[2]];a=h.add(a,h.multiply(c,b*0.5));a=h.add(a,h.multiply(c,1));this.sphere=[a[0],a[1],a[2],e]}};n.prototype.contains_sphere=function(a){for(var b=CubicVR.vec3,e=this._planes,h=0;h<6;++h){var c=e[h],c=b.dot([c[0],c[1],c[2]],[a[0],a[1],a[2]])+c.d;this.last_in[h]=1;if(c<-a[3])return-1;if(Math.abs(c)<a[3])return 0}return 1};n.prototype.draw_on_map=function(a,b){var e=a.width/2,h=a.height/2;b.save();for(var c=
this._planes,q=[0,1,4,5],d=0,g=q.length;d<g;++d){var m=c[q[d]];b.strokeStyle="#FF00FF";if(d<this.last_in.length&&this.last_in[d])b.strokeStyle="#FFFF00";var n=-e,o=e,u=(-m[3]-m[0]*o)/m[2];b.moveTo(e+n,h+(-m[3]-m[0]*n)/m[2]);b.lineTo(e+o,h+u);b.stroke()}b.strokeStyle="#0000FF";b.beginPath();b.arc(e+this.sphere[0],h+this.sphere[2],this.sphere[3],0,Math.PI*2,!1);b.closePath();b.stroke();b.restore()};n.prototype.contains_box=function(a){var b=0,e=[];e[0]=a[0];e[1]=[a[0][0],a[0][1],a[1][2]];e[2]=[a[0][0],
a[1][1],a[0][2]];e[3]=[a[0][0],a[1][1],a[1][2]];e[4]=[a[1][0],a[0][1],a[0][2]];e[5]=[a[1][0],a[0][1],a[1][2]];e[6]=[a[1][0],a[1][1],a[0][2]];e[7]=a[1];for(var a=this._planes,h=0;h<6;++h){for(var c=8,q=1,d=0;d<8;++d)g.classifyPoint(a[h],e[d])===-1&&(q=0,--c);this.last_in[h]=q;if(c===0)return-1;b+=q}if(b===6)return 1;return 0};return{Frustum:n,Octree:x}});CubicVR.RegisterModule("Particles",function(v){function x(n,g,d,m,a,b,e){if(n){this.last_particle=this.particles=null;this.pTex=d!==r?d:null;this.vWidth=m;this.vHeight=a;this.alpha=b!==r?b:!1;this.alphaCut=e!==r?e:0;this.pfunc=function(a,c){var b=c-a.start_time;if(b<0)return 0;if(b>a.life_time&&a.life_time)return-1;a.pos[0]=a.startpos[0]+b*a.velocity[0]+b*b*a.accel[0];a.pos[1]=a.startpos[1]+b*a.velocity[1]+b*b*a.accel[1];a.pos[2]=a.startpos[2]+b*a.velocity[2]+b*b*a.accel[2];this.pgov!==null&&this.pgov(a,
c);return 1};this.pgov=null;this.hasColor=g===r?!1:g;d=this.pTex!==null;this.vs=["#ifdef GL_ES\nprecision highp float;\n#endif\nattribute vec3 aVertexPosition;",this.hasColor?"attribute vec3 aColor;":"","uniform mat4 uMVMatrix;\nuniform mat4 uPMatrix;\nvarying vec4 color;\nvarying vec2 screenPos;",d?"varying float pSize;":"","void main(void) {\nvec4 position = uPMatrix * uMVMatrix * vec4(aVertexPosition,1.0);",d?"screenPos=vec2(position.x/position.w,position.y/position.w);":"","gl_Position = position;",
this.hasColor?"color = vec4(aColor.r,aColor.g,aColor.b,1.0);":"color = vec4(1.0,1.0,1.0,1.0);",d?"pSize=200.0/position.z;":"float pSize=200.0/position.z;","gl_PointSize = pSize;\n}"].join("\n");this.fs=["#ifdef GL_ES\nprecision highp float;\n#endif",d?"uniform sampler2D pMap;":"","varying vec4 color;",d?"varying vec2 screenPos;":"",d?"uniform vec3 screenDim;":"",d?"varying float pSize;":"","void main(void) {\nvec4 c = color;",d?"vec2 screen=vec2((gl_FragCoord.x/screenDim.x-0.5)*2.0,(gl_FragCoord.y/screenDim.y-0.5)*2.0);":
"",d?"vec2 pointCoord=vec2( ((screen.x-screenPos.x)/(pSize/screenDim.x))/2.0+0.5,((screen.y-screenPos.y)/(pSize/screenDim.y))/2.0+0.5);":"",d?"vec4 tc = texture2D(pMap,pointCoord); gl_FragColor = vec4(c.rgb*tc.rgb,1.0);":"gl_FragColor = c;","}"].join("\n");this.maxPoints=n;this.numParticles=0;this.arPoints=new Float32Array(n*3);this.glPoints=null;if(g)this.arColor=new Float32Array(n*3),this.glColor=null;this.shader_particle=new CubicVR.Shader(this.vs,this.fs);this.shader_particle.use();this.shader_particle.addVertexArray("aVertexPosition");
this.hasColor&&this.shader_particle.addVertexArray("aColor");this.shader_particle.addMatrix("uMVMatrix");this.shader_particle.addMatrix("uPMatrix");this.pTex!==null&&(this.shader_particle.addInt("pMap",0),this.shader_particle.addVector("screenDim"),this.shader_particle.setVector("screenDim",[m,a,0]));this.genBuffer()}}var r=v.undef,n=v.GLCore;x.prototype={resizeView:function(n,g){this.vWidth=n;this.vHeight=g;this.pTex!==null&&(this.shader_particle.addVector("screenDim"),this.shader_particle.setVector("screenDim",
[n,g,0]))},addParticle:function(n){this.last_particle===null?this.particles=n:this.last_particle.nextParticle=n;this.last_particle=n},genBuffer:function(){var o=n.gl;this.glPoints=o.createBuffer();o.bindBuffer(o.ARRAY_BUFFER,this.glPoints);o.bufferData(o.ARRAY_BUFFER,this.arPoints,o.DYNAMIC_DRAW);if(this.hasColor)this.glColor=o.createBuffer(),o.bindBuffer(o.ARRAY_BUFFER,this.glColor),o.bufferData(o.ARRAY_BUFFER,this.arColor,o.DYNAMIC_DRAW)},updatePoints:function(){var o=n.gl;o.bindBuffer(o.ARRAY_BUFFER,
this.glPoints);o.bufferData(o.ARRAY_BUFFER,this.arPoints,o.DYNAMIC_DRAW)},updateColors:function(){var o=n.gl;this.hasColor&&(o.bindBuffer(o.ARRAY_BUFFER,this.glColor),o.bufferData(o.ARRAY_BUFFER,this.arColor,o.DYNAMIC_DRAW))},draw:function(o,g,d){var m=n.gl;this.shader_particle.use();this.pTex!==null&&this.pTex.use(m.TEXTURE0);this.shader_particle.setMatrix("uMVMatrix",o);this.shader_particle.setMatrix("uPMatrix",g);m.bindBuffer(m.ELEMENT_ARRAY_BUFFER,null);m.bindBuffer(m.ARRAY_BUFFER,this.glPoints);
m.vertexAttribPointer(this.shader_particle.uniforms.aVertexPosition,3,m.FLOAT,!1,0,0);m.enableVertexAttribArray(this.shader_particle.uniforms.aVertexPosition);this.hasColor&&(m.bindBuffer(m.ARRAY_BUFFER,this.glColor),m.vertexAttribPointer(this.shader_particle.uniforms.aColor,3,m.FLOAT,!1,0,0),m.enableVertexAttribArray(this.shader_particle.uniforms.aColor));d===r&&(d=0);if(this.particles===null)m.disable(m.BLEND);else{for(var o=this.particles,g=null,a=this.numParticles=0;o!==null;){var b=this.numParticles*
3,e=this.pfunc(o,d);if(e===1){if(this.arPoints[b]=o.pos[0],this.arPoints[b+1]=o.pos[1],this.arPoints[b+2]=o.pos[2],o.color!==null&&this.arColor!==r&&(this.arColor[b]=o.color[0],this.arColor[b+1]=o.color[1],this.arColor[b+2]=o.color[2]),this.numParticles++,a++,this.numParticles===this.maxPoints)break}else if(e===-1){if(g!==null)g.nextParticle=o.nextParticle}else e===0&&a++;g=o;o=o.nextParticle}if(!a)this.last_particle=this.particles=null;this.updatePoints();this.hasColor&&this.updateColors();this.alpha&&
(m.enable(m.BLEND),m.enable(m.DEPTH_TEST),m.depthMask(0),m.blendFunc(m.ONE,m.ONE_MINUS_SRC_COLOR));m.drawArrays(m.POINTS,0,this.numParticles);this.alpha&&(m.disable(m.BLEND),m.depthMask(1),m.blendFunc(m.ONE,m.ONE));this.hasColor&&m.disableVertexAttribArray(this.shader_particle.uniforms.aColor)}}};return{ParticleSystem:x,Particle:function(n,g,d,m,a){this.startpos=new Float32Array(n);this.pos=new Float32Array(n);this.velocity=new Float32Array(m!==r?m:[0,0,0]);this.accel=new Float32Array(a!==r?a:[0,
0,0]);this.start_time=g!==r?g:0;this.life_time=d!==r?d:0;this.nextParticle=this.color=null}}});CubicVR.RegisterModule("PostProcess",function(v){function x(a){if(a.shader_vertex===o)return null;if(a.shader_fragment===o)return null;this.outputMode=a.outputMode===o?d.post.output.REPLACE:a.outputMode;this.onresize=a.onresize===o?null:a.onresize;this.onupdate=a.onupdate===o?null:a.onupdate;this.init=a.init===o?null:a.init;this.enabled=a.enabled===o?!0:a.enabled;this.outputDivisor=a.outputDivisor===o?1:a.outputDivisor;this.shader=new CubicVR.Shader(a.shader_vertex,a.shader_fragment);this.shader.use();
this.shader.addUVArray("aTex");this.shader.addVertexArray("aVertex");this.shader.addInt("srcTex",0);this.shader.addInt("captureTex",1);this.shader.addVector("texel");this.init!==null&&this.init(this.shader)}function r(a,e,d){var c=g.gl;this.width=a;this.height=e;this.accum=d===o?!1:!0;this.vTexel=[1/this.width,1/this.height,0];this.captureBuffer=new CubicVR.RenderBuffer(a,e,!0);this.bufferA=new CubicVR.RenderBuffer(a,e,!1);this.bufferB=new CubicVR.RenderBuffer(a,e,!1);this.bufferC=new CubicVR.RenderBuffer(a,
e,!1);this.accumOpacity=1;this.accumIntensity=0.3;if(this.accum)this.accumBuffer=new CubicVR.RenderBuffer(a,e,!1),this.accumBuffer.use(),c.clearColor(0,0,0,1),c.clear(c.COLOR_BUFFER_BIT),this.blur_shader=new x({shader_vertex:"attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nvoid main(void)\n{\nvTex = aTex;\nvec4 vPos = vec4(aVertex.xyz,1.0);\ngl_Position = vPos;\n}",shader_fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D srcTex;\nvarying vec2 vTex;\nuniform float opacity;\nvoid main(void)\n{ gl_FragColor = vec4(texture2D(srcTex, vTex).rgb, opacity);\n}",
init:function(a){a.addFloat("opacity");a.setFloat("opacity",1)}});this.bufferA.use();c.clearColor(0,0,0,1);c.clear(c.COLOR_BUFFER_BIT);this.bufferB.use();c.clearColor(0,0,0,1);c.clear(c.COLOR_BUFFER_BIT);this.end();this.fsQuad=this.makeFSQuad(this.width,this.height);this.shaders=[];this.copy_shader=new x({shader_vertex:"attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nvoid main(void) {\nvTex = aTex;\nvec4 vPos = vec4(aVertex.xyz,1.0);\ngl_Position = vPos;\n}",shader_fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D srcTex;\nvarying vec2 vTex;\nvoid main(void) {\ngl_FragColor = texture2D(srcTex, vTex);\n}"});
this.resize(a,e)}function n(a,e,d){this.createBuffer(a,e,d)}var o=v.undef,g=v.GLCore,d=CubicVR.enums;d.post={output:{REPLACE:0,BLEND:1,ADD:2,ALPHACUT:3}};var m=[],a=[];r.prototype={setBlurOpacity:function(a){this.accumOpacity=a},setBlurIntensity:function(a){this.accumIntensity=a},makeFSQuad:function(a,e){var d=g.gl,c=[],q=a/a,m=e/e;c.vbo_points=new Float32Array([-1,-1,0,1,-1,0,1,1,0,-1,1,0,-1,-1,0,1,1,0]);c.vbo_uvs=new Float32Array([0,0,q,0,q,m,0,m,0,0,q,m]);c.gl_points=d.createBuffer();d.bindBuffer(d.ARRAY_BUFFER,
c.gl_points);d.bufferData(d.ARRAY_BUFFER,c.vbo_points,d.STATIC_DRAW);c.gl_uvs=d.createBuffer();d.bindBuffer(d.ARRAY_BUFFER,c.gl_uvs);d.bufferData(d.ARRAY_BUFFER,c.vbo_uvs,d.STATIC_DRAW);return c},destroyFSQuad:function(a){var e=g.gl;e.deleteBuffer(a.gl_points);e.deleteBuffer(a.gl_uvs)},renderFSQuad:function(a,e){var d=g.gl;a.use();d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,null);d.bindBuffer(d.ARRAY_BUFFER,e.gl_points);d.vertexAttribPointer(a.aVertex,3,d.FLOAT,!1,0,0);d.enableVertexAttribArray(a.aVertex);
d.bindBuffer(d.ARRAY_BUFFER,e.gl_uvs);d.vertexAttribPointer(a.aTex,2,d.FLOAT,!1,0,0);d.enableVertexAttribArray(a.aTex);d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,null);d.drawArrays(d.TRIANGLES,0,6)},addShader:function(b){this.shaders[this.shaders.length]=b;b.shader.use();b.shader.setVector("texel",this.vTexel);if(b.outputDivisor&&b.outputDivisor!=1&&m[b.outputDivisor]===o){var e=this.width/b.outputDivisor|0,d=this.height/b.outputDivisor|0;m[b.outputDivisor]=new CubicVR.RenderBuffer(e,d,!1);a[b.outputDivisor]=
this.makeFSQuad(e,d)}},resize:function(b,e){var d=g.gl;this.width=b;this.height=e;this.vTexel=[1/this.width,1/this.height,0];this.captureBuffer.destroyBuffer();this.captureBuffer.createBuffer(this.width,this.height,!0);this.bufferA.destroyBuffer();this.bufferA.createBuffer(this.width,this.height,!1);this.bufferB.destroyBuffer();this.bufferB.createBuffer(this.width,this.height,!1);this.bufferC.destroyBuffer();this.bufferC.createBuffer(this.width,this.height,!1);this.accum&&(this.accumBuffer.destroyBuffer(),
this.accumBuffer.createBuffer(this.width,this.height,!1),this.accumBuffer.use(),d.clearColor(0,0,0,1),d.clear(d.COLOR_BUFFER_BIT));for(var c in m){var d=this.width/c|0,q=this.height/c|0;m[c].destroyBuffer();m[c].createBuffer(d,q,!1);this.destroyFSQuad(a[c]);a[c]=this.makeFSQuad(d,q)}this.inputBuffer=this.bufferA;this.outputBuffer=this.bufferB;c=0;for(d=this.shaders.length;c<d;c++)if(this.shaders[c].shader.use(),this.shaders[c].shader.setVector("texel",this.vTexel),this.shaders[c].onresize!==null)this.shaders[c].onresize(this.shaders[c].shader,
this.width,this.height);this.destroyFSQuad(this.fsQuad);this.fsQuad=this.makeFSQuad(this.width,this.height)},swap:function(){var a=this.inputBuffer;this.inputBuffer=this.outputBuffer;this.outputBuffer=a},begin:function(){this.captureBuffer.use()},end:function(){var a=g.gl;a.bindFramebuffer(a.FRAMEBUFFER,null)},render:function(){var b=g.gl;this.captureBuffer.texture.use(b.TEXTURE1);this.outputBuffer.use();this.captureBuffer.texture.use(b.TEXTURE0);b.clearColor(0,0,0,1);b.clear(b.COLOR_BUFFER_BIT);
this.renderFSQuad(this.copy_shader.shader,this.fsQuad);this.end();for(var e=0,h=0,c=this.shaders.length;h<c;h++){var q=this.shaders[h];if(q.enabled){this.swap();this.inputBuffer.texture.use(b.TEXTURE0);var t=q.outputMode;if(t===d.post.output.REPLACE)q.outputDivisor!==1?m[q.outputDivisor].use():this.outputBuffer.use(),b.clearColor(0,0,0,1),b.clear(b.COLOR_BUFFER_BIT);else if(t===d.post.output.ADD||t===d.post.output.BLEND)q.outputDivisor!==1?m[q.outputDivisor].use():this.bufferC.use(),b.clearColor(0,
0,0,1),b.clear(b.COLOR_BUFFER_BIT);q.onupdate!==null&&(q.shader.use(),q.onupdate(q.shader));q.outputDivisor!==1?(b.viewport(0,0,m[q.outputDivisor].width,m[q.outputDivisor].height),this.renderFSQuad(q.shader,a[q.outputDivisor]),q.outputMode===d.post.output.REPLACE?(this.outputBuffer.use(),m[q.outputDivisor].texture.use(b.TEXTURE0),b.viewport(0,0,this.width,this.height),this.renderFSQuad(this.copy_shader.shader,this.fsQuad)):b.viewport(0,0,this.width,this.height)):this.renderFSQuad(q.shader,this.fsQuad);
t===d.post.output.BLEND?(this.swap(),this.outputBuffer.use(),b.enable(b.BLEND),b.blendFunc(b.ONE,b.ONE_MINUS_SRC_ALPHA),this.inputBuffer.texture.use(b.TEXTURE0),q.outputDivisor!==1?m[q.outputDivisor].texture.use(b.TEXTURE0):this.bufferC.texture.use(b.TEXTURE0),this.renderFSQuad(this.copy_shader.shader,this.fsQuad),b.disable(b.BLEND)):t===d.post.output.ADD&&(this.swap(),this.outputBuffer.use(),b.enable(b.BLEND),b.blendFunc(b.ONE,b.ONE),q.outputDivisor!==1?m[q.outputDivisor].texture.use(b.TEXTURE0):
this.bufferC.texture.use(b.TEXTURE0),this.renderFSQuad(this.copy_shader.shader,this.fsQuad),b.disable(b.BLEND));this.end();e++}}e===0?this.captureBuffer.texture.use(b.TEXTURE0):this.outputBuffer.texture.use(b.TEXTURE0);this.accum&&this.accumOpacity!==1?(this.blur_shader.shader.use(),this.blur_shader.shader.setFloat("opacity",this.accumOpacity),this.accumBuffer.use(),b.enable(b.BLEND),b.blendFunc(b.SRC_ALPHA,b.ONE_MINUS_SRC_ALPHA),this.renderFSQuad(this.blur_shader.shader,this.fsQuad),this.end(),b.disable(b.BLEND),
this.renderFSQuad(this.copy_shader.shader,this.fsQuad),b.enable(b.BLEND),b.blendFunc(b.SRC_ALPHA,b.ONE_MINUS_SRC_ALPHA),this.blur_shader.shader.use(),this.blur_shader.shader.setFloat("opacity",this.accumIntensity),this.accumBuffer.texture.use(b.TEXTURE0),this.renderFSQuad(this.blur_shader.shader,this.fsQuad),b.disable(b.BLEND)):this.renderFSQuad(this.copy_shader.shader,this.fsQuad)}};n.prototype={createBuffer:function(a,d,h){this.texture=this.depth=this.fbo=null;this.width=parseInt(a,10);this.height=
parseInt(d,10);var a=this.sizeParam(a),d=this.sizeParam(d),c=g.gl;this.fbo=c.createFramebuffer();if(h)this.depth=c.createRenderbuffer();c.bindFramebuffer(c.FRAMEBUFFER,this.fbo);h&&(c.bindRenderbuffer(c.RENDERBUFFER,this.depth),navigator.appVersion.indexOf("Windows")!==-1?(c.renderbufferStorage(c.RENDERBUFFER,c.DEPTH_COMPONENT16,a,d),c.framebufferRenderbuffer(c.FRAMEBUFFER,c.DEPTH_ATTACHMENT,c.RENDERBUFFER,this.depth)):(c.renderbufferStorage(c.RENDERBUFFER,c.DEPTH_STENCIL,a,d),c.framebufferRenderbuffer(c.FRAMEBUFFER,
c.DEPTH_STENCIL_ATTACHMENT,c.RENDERBUFFER,this.depth)));this.texture=new CubicVR.Texture;c.bindTexture(c.TEXTURE_2D,v.Textures[this.texture.tex_id]);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.LINEAR);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.NEAREST);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.CLAMP_TO_EDGE);c.texImage2D(c.TEXTURE_2D,0,c.RGBA,a,d,0,c.RGBA,c.UNSIGNED_BYTE,null);c.framebufferTexture2D(c.FRAMEBUFFER,
c.COLOR_ATTACHMENT0,c.TEXTURE_2D,v.Textures[this.texture.tex_id],0);c.bindFramebuffer(c.FRAMEBUFFER,null)},destroyBuffer:function(){var a=g.gl;a.bindFramebuffer(a.FRAMEBUFFER,null);a.deleteRenderbuffer(this.depth);a.deleteFramebuffer(this.fbo);a.deleteTexture(v.Textures[this.texture.tex_id]);v.Textures[this.texture.tex_id]=null},sizeParam:function(a){return a},use:function(){var a=g.gl;a.bindFramebuffer(a.FRAMEBUFFER,this.fbo)}};return{RenderBuffer:n,PostProcessShader:x,PostProcessChain:r,fsQuad:{make:r.prototype.makeFSQuad,
destroy:r.prototype.destroyFSQuad,render:r.prototype.renderFSQuad}}});CubicVR.RegisterModule("Polygon",function(v){function x(a){var b=[],d=a.length;if(d<3)return null;var e=[],g;g=a.length;for(var m=0,n=g-1,o=0;o<g;n=o++)m+=a[n][0]*a[o][1]-a[o][0]*a[n][1];if(0<m*0.5)for(g=0;g<d;g++)e[g]=g;else for(g=0;g<d;g++)e[g]=d-1-g;o=2*d;m=0;for(g=d-1;d>2;){if(0>=o--)return null;var r=g;d<=r&&(r=0);g=r+1;d<=g&&(g=0);n=g+1;d<=n&&(n=0);var B;a:{B=a;var z=r,w=g,y=n,v=d,x=e,E=void 0,Q=void 0,J=void 0,H=void 0,F=void 0,G=void 0,O=void 0,K=void 0,T=void 0,Q=B[x[z]][0],J=B[x[z]][1],
H=B[x[w]][0],F=B[x[w]][1],G=B[x[y]][0],O=B[x[y]][1];if(h>(H-Q)*(O-J)-(F-J)*(G-Q))B=!1;else{for(E=0;E<v;E++)if(!(E==z||E==w||E==y)){var K=B[x[E]][0],T=B[x[E]][1],X=void 0,M=void 0,R=void 0,N=void 0,U=void 0,Z=void 0,$=void 0,S=void 0,aa=void 0,V=void 0,W=void 0,Y=void 0,X=R=U=void 0,X=G-H,M=O-F,R=Q-G,N=J-O,U=H-Q,Z=F-J,$=K-Q,S=T-J,aa=K-H,V=T-F,W=K-G,Y=T-O,X=X*V-M*aa,U=U*S-Z*$,R=R*Y-N*W;if(X>=0&&R>=0&&U>=0){B=!1;break a}}B=!0}}if(B){o=e[r];r=e[g];n=e[n];b.push(o);b.push(r);b.push(n);m++;n=g;for(o=g+
1;o<d;n++,o++)e[n]=e[o];d--;o=2*d}}return b}function r(a,b,d){d===e&&(d=0);var h;h=x(b);var g=CubicVR.util.repackArray(h,3,h.length/3),m=[],n=a.points.length;h=0;for(iMax=b.length;h<iMax;h++)m.push([b[h][0],b[h][1],d]);a.addPoint(m);h=0;for(iMax=g.length;h<iMax;h++)a.addFace([g[h][0]+n,g[h][1]+n,g[h][2]+n])}function n(a,b){var d=b[0]-a[0],e=b[1]-a[1];return Math.sqrt(d*d+e*e)}function o(a,b){var d,e,h=[],g=a.length,m=b.length,o=[];for(d=0;d<g;d++)for(e=0;e<m;e++){var r=n(a[d],b[e]);h.push([r,d,e])}h.sort(function(a,
c){return a[0]>c[0]});for(d=0;d<5;d++)for(e=0;e<h.length;e++)d!=e&&h[d][1]!=h[e][1]&&h[d][2]!=h[e][2]&&h[d][1]<h[e][1]&&h[d][2]<h[e][2]&&Math.abs(h[d][1]-h[e][1])<4&&Math.abs(h[d][2]-h[e][2])<4&&o.push([d,e]);o.sort(function(a,c){return h[a[0]][0]+h[a[1]][0]>h[c[0]][0]+h[c[1]][0]});if(o.length>10)o.length=10;e=[];for(d=0;d<o.length;d++)e.push([h[o[d][0]],h[o[d][1]]]);return e}function g(a,b){var d=o(a,b),e;if(!d.length)return null;e=d[0][0];var h=d[0][1],d=h[1]-e[1],h=h[2]-e[2],g=a.slice(e[1]),g=
g.concat(a.slice(0,e[1])),m=b.slice(e[2]),m=m.concat(b.slice(0,e[2])),n=[];for(e=d;e<g.length;e++)n.push(g[e]);n.push(g[0]);for(e=h;e<m.length;e++)n.push(m[e]);n.push(m[0]);var r=[];for(e=0;e<=d;e++)r.push(g[e]);for(e=0;e<=h;e++)r.push(m[e]);return[n,r]}function d(a){for(var b=[0,0],d=0;d<a.length;d++)b[0]+=a[d][0],b[1]+=a[d][1];b[0]/=a.length;b[1]/=a.length;return b}function m(a,b,d){for(var e=[],h=0;h<a.length;h++){var g=[a[h][0]-b[0],a[h][1]-b[1]],m=Math.sqrt(g[0]*g[0]+g[1]*g[1])+d,g=Math.atan2(g[1],
g[0]);e[h]=[b[0]+Math.cos(g)*m,b[1]+Math.sin(g)*m]}return e}function a(a,b,d,e,h){var g,m=a.points.length;if(b.length!=d.length)return null;var n=b.length;for(g=0;g<n;g++)a.addPoint([b[g][0],b[g][1],e]);for(g=0;g<n;g++)a.addPoint([d[g][0],d[g][1],h]);for(g=0;g<n-1;g++)a.addFace([m+g,m+g+1,m+(g+n+1),m+(g+n)]);g=n-1;a.addFace([m+g,m,m+n,m+(g+n)])}function b(a){this.points=a;this.cuts=[];this.result=[]}var e=v.undef,h=1.0E-10;b.prototype={cut:function(a){this.cuts.push(a)},toMesh:function(a){if(this.points.length!==
0){var b;a||(a=new CubicVR.Mesh);this.result=[this.points];for(b=0;b<this.cuts.length;b++){var d=this.cuts[b].points.slice(0),d=d.reverse(),d=g(this.result[0],d);this.result[0]=d[0];this.result.push(d[1])}for(b=0;b<this.result.length;b++)r(a,this.result[b]);a.removeDoubles();return a}},toExtrudedMesh:function(c,b,d){if(this.points.length!==0){var h,m;b===e&&(b=0);d===e&&(d=0);var n=b!=d;c||(c=new CubicVR.Mesh);this.result=[this.points];for(m=0;m<this.cuts.length;m++)h=this.cuts[m].points.slice(0),
h=h.reverse(),h=g(this.result[0],h),this.result[0]=h[0],this.result.push(h[1]);h=new CubicVR.Mesh;for(m=0;m<this.result.length;m++)r(h,this.result[m],d);c.booleanAdd(h);h.flipFaces();if(n)for(m=0;m<h.points.length;m++)h.points[m][2]=b;c.booleanAdd(h);if(n){a(c,this.points,this.points,b,d);for(m=0;m<this.cuts.length;m++)h=this.cuts[m].points.slice(0),h=h.reverse(),a(c,h,h,b,d)}c.removeDoubles();return c}},toExtrudedBeveledMesh:function(c,b,e,h,n,o,v){var u=[],D=[],B,z,w,y;if(this.points.length!==0){typeof b===
"object"&&(v=b,b=v.front||0,e=v.back||0,h=v.frontDepth||0,n=v.frontShift||0,o=v.backDepth||0,v=v.backShift||0);var x=b!==e,C=o!==0,E=h!==0;c||(c=new CubicVR.Mesh);E?(z=d(this.points),z=m(this.points,z,-n),this.result=[z.slice(0)]):this.result=[this.points.slice(0)];for(y=0;y<this.cuts.length;y++)w=d(this.cuts[y].points),w=m(this.cuts[y].points,w,n),w=w.reverse(),u.push(w),w=g(this.result[0],w),this.result[0]=w[0],this.result.push(w[1]);n=new CubicVR.Mesh;for(y=0;y<this.result.length;y++)r(n,this.result[y],
b-h);n.flipFaces();c.booleanAdd(n);if(C||E){B=d(this.points);B=m(this.points,B,-v);this.result=[B.slice(0)];for(y=0;y<this.cuts.length;y++)w=d(this.cuts[y].points),w=m(this.cuts[y].points,w,v),w=w.reverse(),D.push(w),w=g(this.result[0],w),this.result[0]=w[0],this.result.push(w[1]);n=new CubicVR.Mesh;for(y=0;y<this.result.length;y++)r(n,this.result[y],e+o)}else{for(y=0;y<n.points.length;y++)n.points[y][2]=e;n.flipFaces()}c.booleanAdd(n);E&&a(c,z,this.points,b-h,b);x&&a(c,this.points,this.points,b,
e);C&&a(c,this.points,B,e,e+o);for(y=0;y<u.length;y++)w=this.cuts[y].points.slice(0).reverse(),E&&a(c,u[y],w,b-h,b),x&&a(c,w,w,b,e),C&&a(c,w,D[y],e,e+o);c.removeDoubles();return c}}};return{polygon:{triangulate2D:x,toMesh:r,findNearPair:function(a,b){for(var d=[0,0],e=n(a[0],b[0]),h=a.length,g=b.length,m=0;m<h;m++)for(var o=0;o<g;o++){var r=n(a[m],b[o]);r<e&&(d[0]=m,d[1]=o,e=r)}return d},subtract:g,addOffset:function(a,b){for(var d=[],e=0,h=a.length;e<h;e++){var g=a[e];d.push([g[0]+b[0],g[1]+b[1]])}return d}},
Polygon:b}});CubicVR.RegisterModule("Primitives",function(v){function x(d,c,e,g,m,n){var o=CubicVR.mat4,r=CubicVR.vec3,u=[],v,B=[0,1,0],z=[1,0,0],w=[0,0,0],y=d.points.length,x,C,E;for(x=v=0;x<b;x+=b/e){if(v===e)break;z=[Math.cos(x),0,Math.sin(x)];C=0;for(E=c.length;C<E;C++)w=r.add(r.multiply(z,c[C][0]),r.multiply(B,c[C][1])),u[v]===a&&(u[v]=[]),u[v].push(w);v++}E=null;m!==a&&(E=m.getResult!==a?m.getResult():m);for(C=0;C<e;C++){m=0;for(v=c.length;m<v;m++)E?d.addPoint(o.vec3_multiply(u[C][m],E)):d.addPoint(u[C][m])}d.setFaceMaterial(g);
for(m=0;m<e;m++){C=0;for(E=c.length-1;C<E;C++)o=C+c.length*m,u=C+c.length*((m+1)%e),r.equal(d.points[y+o],d.points[y+u])?d.addFace([y+o+1,y+u+1,y+u]):r.equal(d.points[y+o+1],d.points[y+u+1])?d.addFace([y+o,y+o+1,y+u]):d.addFace([y+o,y+o+1,y+u+1,y+u])}n!==a&&(c=null,n.apply!==a?c=n:n&&(c=new CubicVR.UVMapper(n)),c!==null&&(d.calcFaceNormals(),c.apply(d,g)))}function r(b,c,d,e,g){var m=CubicVR.mat4;c*=0.5;var n=b.points.length;b.setFaceMaterial(d);e!==a?(e=e.getResult!==a?e.getResult():e,b.addPoint([m.vec3_multiply([c,
-c,0],e),m.vec3_multiply([c,c,0],e),m.vec3_multiply([-c,c,0],e),m.vec3_multiply([-c,-c,0],e)])):b.addPoint([[c,-c,0],[c,c,0],[-c,c,0],[-c,-c,0]]);b.addFace([[n+0,n+1,n+2,n+3],[n+3,n+2,n+1,n+0]]);g!==a&&(m=null,g.apply!==a?m=g:g&&(m=new CubicVR.UVMapper(g)),m!==null&&(b.calcFaceNormals(),m.apply(b,d)))}function n(b,c,d,e,g){var m=CubicVR.mat4,n,o;typeof c==="object"?(n=c[0]/2,o=c[1]/2,c=c[2]/2):n=o=c/=2;var r=b.points.length;b.setFaceMaterial(d);e!==a?(e=e.getResult!==a?e.getResult():e,b.addPoint([m.vec3_multiply([n,
-o,c],e),m.vec3_multiply([n,o,c],e),m.vec3_multiply([-n,o,c],e),m.vec3_multiply([-n,-o,c],e),m.vec3_multiply([n,-o,-c],e),m.vec3_multiply([n,o,-c],e),m.vec3_multiply([-n,o,-c],e),m.vec3_multiply([-n,-o,-c],e)])):b.addPoint([[n,-o,c],[n,o,c],[-n,o,c],[-n,-o,c],[n,-o,-c],[n,o,-c],[-n,o,-c],[-n,-o,-c]]);b.addFace([[r+0,r+1,r+2,r+3],[r+7,r+6,r+5,r+4],[r+4,r+5,r+1,r+0],[r+5,r+6,r+2,r+1],[r+6,r+7,r+3,r+2],[r+7,r+4,r+0,r+3]]);g!==a&&(m=null,g.apply!==a?m=g:g&&(m=new CubicVR.UVMapper(g)),m!==null&&(b.calcFaceNormals(),
m.apply(b,d)))}function o(a,c,d,e,g,m,n,o){var r=[];d-=c;c+=d/2;for(var v=b/g,x=0,z=0;z<=g;z++)r.push([c+Math.cos(x)*d,Math.sin(x)*d,0]),x+=v;CubicVR.genLatheObject(a,r,e,m,n,o)}function g(a,b,d,e,g,m,n){CubicVR.genLatheObject(a,[[0,-d/2,0],[b/2,-d/2,0],[0,d/2,0]],e,g,m,n)}function d(a,b,d,e,g,m,n){CubicVR.genLatheObject(a,[[0,-d/2,0],[b,-d/2,0],[b,d/2,0],[0,d/2,0]],e,g,m,n)}function m(a,b,d,g,m,n,o){var r=[],g=(g/=2)|0;d|=0;for(var u=Math.PI/g,v=-e,x=0;x<=g;x++)r.push([Math.cos(v)*b,Math.sin(v)*
b,0]),v+=u;CubicVR.genLatheObject(a,r,d,m,n,o)}var a=v.undef,b=2*Math.PI,e=Math.PI/2;return{genPlaneObject:r,genBoxObject:n,genLatheObject:x,genTorusObject:o,genConeObject:g,genCylinderObject:d,genSphereObject:m,primitives:{lathe:function(b){var c,d;if(b.points==a)return null;c=b.mesh!==a?b.mesh:new CubicVR.Mesh(b.name!==a?b.name:a);d=b.material!==a?b.material:new CubicVR.Material;x(c,b.points,b.divisions!==a?b.divisions:24,d,b.transform!==a?b.transform:a,b.uvmapper!==a?b.uvmapper:a);return c},box:function(b){var c,
d;c=b.mesh!==a?b.mesh:new CubicVR.Mesh(b.name!==a?b.name:a);d=b.material!==a?b.material:new CubicVR.Material;n(c,b.size!==a?b.size:1,d,b.transform!==a?b.transform:a,b.uvmapper!==a?b.uvmapper:a);return c},plane:function(b){var c,d;c=b.mesh!==a?b.mesh:new CubicVR.Mesh(b.name!==a?b.name:a);d=b.material!==a?b.material:new CubicVR.Material;r(c,b.size!==a?b.size:1,d,b.transform!==a?b.transform:a,b.uvmapper!==a?b.uvmapper:a);return c},sphere:function(b){var c,d;c=b.mesh!==a?b.mesh:new CubicVR.Mesh(b.name!==
a?b.name:a);d=b.material!==a?b.material:new CubicVR.Material;m(c,b.radius!==a?b.radius:1,b.lon!==a?b.lon:24,b.lat!==a?b.lat:24,d,b.transform!==a?b.transform:a,b.uvmapper!==a?b.uvmapper:a);return c},torus:function(b){var c,d;c=b.mesh!==a?b.mesh:new CubicVR.Mesh(b.name!==a?b.name:a);d=b.material!==a?b.material:new CubicVR.Material;o(c,b.innerRadius!==a?b.innerRadius:0.75,b.outerRadius!==a?b.outerRadius:1,b.lon!==a?b.lon:24,b.lat!==a?b.lat:24,d,b.transform!==a?b.transform:a,b.uvmapper!==a?b.uvmapper:
a);return c},cone:function(b){var c,d;c=b.mesh!==a?b.mesh:new CubicVR.Mesh(b.name!==a?b.name:a);d=b.material!==a?b.material:new CubicVR.Material;g(c,b.base!==a?b.base:1,b.height!==a?b.height:1,b.lon!==a?b.lon:24,d,b.transform!==a?b.transform:a,b.uvmapper!==a?b.uvmapper:a);return c},cylinder:function(b){var c,e,g,m,n,o;c=b.mesh!==a?b.mesh:new CubicVR.Mesh(b.name!==a?b.name:a);e=b.material!==a?b.material:new CubicVR.Material;g=b.transform!==a?b.transform:a;m=b.uvmapper!==a?b.uvmapper:a;n=b.radius!==
a?b.radius:1;o=b.height!==a?b.height:1;lon=b.lon!==a?b.lon:24;d(c,n,o,lon,e,g,m);return c}}}});CubicVR.RegisterModule("Renderer",function(v){var x=v.undef;return{renderObject:function(r,n,o,g){if(r.compiled!==null){var d=0,m=CubicVR.GLCore.gl,a=g===x?0:g.length,b,e=0,h,c=null,q=r.instanceMaterials||r.materials,t=!1,s,L,A;m.depthFunc(m.LEQUAL);o===x&&(o=cubicvr_identity);for(var I=0,u=r.compiled.elements_ref.length;I<u;I++){var c=q[I],D=0,e=!1;c.opacity!==1?(m.enable(m.BLEND),m.depthMask(0),m.blendFunc(m.SRC_ALPHA,m.ONE_MINUS_SRC_ALPHA)):(m.depthMask(1),m.disable(m.BLEND),m.blendFunc(m.ONE,
m.ONE));for(var B=0,z=r.compiled.elements_ref[I].length;B<z;B++)if(h=r.compiled.elements_ref[I][B][0],e=!1,s=r.compiled.elements_ref[I][B][1],D+=s,!r.segment_state[h])if(D>s){d+=s*2;D-=s;if(a){L=!1;for(s=0;s<a;){nLights=a-s;if(nLights>v.MAX_LIGHTS)nLights=v.MAX_LIGHTS;s>0&&!L&&(m.enable(m.BLEND),m.blendFunc(m.ONE,m.ONE),m.depthFunc(m.EQUAL),L=!0);b=g[s];A=b.light_type;for(e=0;e<nLights;e++)if(g[e+s].light_type!=A){nLights=e;break}c.use(b.light_type,nLights);b=c.shader[b.light_type][nLights];m.uniformMatrix4fv(b.uMVMatrix,
!1,n.mvMatrix);m.uniformMatrix4fv(b.uPMatrix,!1,n.pMatrix);m.uniformMatrix4fv(b.uOMatrix,!1,o);m.uniformMatrix3fv(b.uNMatrix,!1,n.nMatrix);t||(c.bindObject(r,b),t=b.aTextureCoord!=-1);for(e=0;e<nLights;e++)g[e+s].setupShader(b,e);m.drawElements(m.TRIANGLES,D,m.UNSIGNED_SHORT,d);s+=nLights}L&&(m.disable(m.BLEND),m.depthFunc(m.LEQUAL))}else c.use(0,0),m.uniformMatrix4fv(c.shader[0][0].uMVMatrix,!1,n.mvMatrix),m.uniformMatrix4fv(c.shader[0][0].uPMatrix,!1,n.pMatrix),m.uniformMatrix4fv(c.shader[0][0].uOMatrix,
!1,o),m.uniformMatrix3fv(c.shader[0][0].uNMatrix,!1,n.nMatrix),t||(c.bindObject(r,c.shader[0][0]),t=c.shader[0][0].aTextureCoord!=-1),m.drawElements(m.TRIANGLES,D,m.UNSIGNED_SHORT,d);d+=D*2;D=0;e=!0}else d+=D*2,D=0;if(!e&&r.segment_state[h]){if(a){L=!1;for(s=0;s<a;){nLights=a-s;if(nLights>v.MAX_LIGHTS)nLights=v.MAX_LIGHTS;s>0&&!L&&(m.enable(m.BLEND),m.blendFunc(m.ONE,m.ONE),m.depthFunc(m.EQUAL),L=!0);b=g[s];A=b.light_type;for(e=0;e<nLights;e++)if(g[e+s].light_type!=A){nLights=e;break}c.use(b.light_type,
nLights);b=c.shader[b.light_type][nLights];m.uniformMatrix4fv(b.uMVMatrix,!1,n.mvMatrix);m.uniformMatrix4fv(b.uPMatrix,!1,n.pMatrix);m.uniformMatrix4fv(b.uOMatrix,!1,o);m.uniformMatrix3fv(b.uNMatrix,!1,n.nMatrix);t||(c.bindObject(r,b),t=b.aTextureCoord!=-1);for(e=0;e<nLights;e++)g[e+s].setupShader(b,e);m.drawElements(m.TRIANGLES,D,m.UNSIGNED_SHORT,d);s+=nLights}L&&(m.disable(m.BLEND),m.depthFunc(m.LEQUAL))}else c.use(0,0),m.uniformMatrix4fv(c.shader[0][0].uMVMatrix,!1,n.mvMatrix),m.uniformMatrix4fv(c.shader[0][0].uPMatrix,
!1,n.pMatrix),m.uniformMatrix4fv(c.shader[0][0].uOMatrix,!1,o),m.uniformMatrix3fv(c.shader[0][0].uNMatrix,!1,n.nMatrix),t||(c.bindObject(r,c.shader[0][0]),t=c.shader[0][0].aTextureCoord!=-1),m.drawElements(m.TRIANGLES,D,m.UNSIGNED_SHORT,d);d+=D*2}}c&&b&&c.clearObject(r,b);m.depthMask(1);m.bindBuffer(m.ELEMENT_ARRAY_BUFFER,null)}}}});CubicVR.RegisterModule("Scene",function(v){function x(a,b){return a.light_type-b.light_type}function r(c,d){var e=null;c!==g&&c!==null&&(e=c.compile?null:c);e?(this.morphWeight=e.morphWeight||0,this.morphSource=e.morphSource||-1,this.morphTarget=e.morphTarget||-1,this.position=e.position===g?[0,0,0]:e.position,this.rotation=e.rotation===g?[0,0,0]:e.rotation,this.scale=e.scale===g?[1,1,1]:e.scale,this.shadowCast=e.shadowCast===g?!0:e.shadowCast,this.motion=e.motion===g?null:e.motion,this.obj=e.mesh===
g?c!==g&&e.faces!==g?c:null:e.mesh,this.name=e.name===g?d!==g?d:null:e.name):(this.position=[0,0,0],this.rotation=[0,0,0],this.scale=[1,1,1],this.motion=null,this.obj=c,this.name=d,this.shadowCast=!0);this.parent=this.children=null;this.drawn_this_frame=!1;this.lposition=[0,0,0];this.lrotation=[0,0,0];this.lscale=[0,0,0];this.lMatrix=b.identity();this.tMatrix=b.identity();this.dirty=!0;this.aabb=[];this.id=-1;this.octree_leaves=[];this.octree_common_root=null;this.octree_aabb=[[0,0,0],[0,0,0]];a.reset(this.octree_aabb,
[0,0,0]);this.ignore_octree=!1;this.was_culled=this.culled=this.visible=!0;this.dynamic_lights=[];this.static_lights=[];this.matrixLock=!1;this.instanceMaterials=null}function n(a,b,d,e,g,m){this.frames=0;this.sceneObjects=[];this.sceneObjectsByName=[];this.sceneObjectsById=[];this.lights=[];this.global_lights=[];this.dynamic_lights=[];this.pickables=[];this.stats=[];this.cameras=[];this.camerasByName=[];this.collect_stats=!1;typeof a==="object"?(this.octree=a.octree,this.skybox=a.skybox||null,this.camera=
new CubicVR.Camera(a.width,a.height,a.fov,a.nearclip,a.farclip),this.name=a.name||"scene"+h,this.destroy=a.destroy||function(){},this.update=a.update||function(){},this.enable=a.enable||function(){},this.disable=a.disable||function(){},a=a.setup&&a.setup(this),this.update=a.update||this.update,this.enable=a.enable||this.enable,this.disable=a.disable||this.disable,this.destroy=a.destroy||this.destroy):(this.skybox=null,this.octree=m,this.camera=new CubicVR.Camera(a,b,d,e,g),this.name="scene"+h);this.paused=
!1;++h}function o(){this.meshBin={};this.imageBin={};this.meshMap={};this.imageMap={};this.imageBinPtr={};this.meshBinPtr={}}var g=v.undef,d=CubicVR.enums,m=v.GLCore,a=CubicVR.aabb,b=CubicVR.mat4,e=0;r.prototype={getInstanceMaterials:function(){if(!this.obj)return null;if(this.instanceMaterials)return this.instanceMaterials;this.instanceMaterials=[];for(var a=0,b=this.obj.materials.length;a<b;a++)this.instanceMaterials[a]=this.obj.materials[a].clone();return this.instanceMaterials},getInstanceMaterial:function(a){for(var b=
this.getInstanceMaterials(),d=0,e=b.length;d<e;d++)if(b[d].name==a)return b[d];return null},setMorphSource:function(a){this.morphSource=a},setMorphTarget:function(a){this.morphTarget=a},getMorphSource:function(){return this.morphSource},getMorphTarget:function(){return this.morphTarget},setMorphWeight:function(a){this.morphWeight=a},morphTargetCount:function(){return this.obj.morphTargets!==null?this.obj.morphTargets.length:0},setMatrix:function(a){a?(this.tMatrix=a.slice(0),this.matrixLock=!0):this.matrixLock=
!1},doTransform:function(a){var d=CubicVR.vec3;if(!this.matrixLock&&(!d.equal(this.lposition,this.position)||!d.equal(this.lrotation,this.rotation)||!d.equal(this.lscale,this.scale)||a!==g))a!==g?this.tMatrix=a.slice(0):b.identity(this.tMatrix),b.identity(this.lMatrix),b.translate(this.position[0],this.position[1],this.position[2],this.lMatrix),b.rotate(this.rotation[0],this.rotation[1],this.rotation[2],this.lMatrix),this.scale[0]===1&&this.scale[1]===1&&this.scale[2]===1||b.scale(this.scale[0],this.scale[1],
this.scale[2],this.lMatrix),b.multiply(this.tMatrix.slice(0),this.lMatrix,this.tMatrix),this.lposition[0]=this.position[0],this.lposition[1]=this.position[1],this.lposition[2]=this.position[2],this.lrotation[0]=this.rotation[0],this.lrotation[1]=this.rotation[1],this.lrotation[2]=this.rotation[2],this.lscale[0]=this.scale[0],this.lscale[1]=this.scale[1],this.lscale[2]=this.scale[2],this.dirty=!0},adjust_octree:function(){var b=this.getAABB(),d=this.octree_aabb,e=b[0][0],h=b[0][1],m=b[0][2],n=b[1][0],
o=b[1][1],r=b[1][2],v=d[0][0],x=d[0][1],z=d[0][2],w=d[1][0],y=d[1][1],d=d[1][2];if(this.octree_leaves.length>0&&(e<v||h<x||m<z||n>w||o>y||r>d)){for(e=0;e<this.octree_leaves.length;++e)this.octree_leaves[e].remove(this);this.octree_leaves=[];this.static_lights=[];e=this.octree_common_root;this.octree_common_root=null;if(e!==null){for(;;)if(!e.contains_point(b[0])||!e.contains_point(b[1]))if(e._root!==g&&e._root!==null)e=e._root;else break;else break;a.reset(this.octree_aabb,this.position);e.insert(this)}}},
bindChild:function(a){if(this.children===null)this.children=[];a.parent=this;this.children.push(a)},control:function(a,b,e){a===d.motion.POS?this.position[b]=e:a===d.motion.SCL?this.scale[b]=e:a===d.motion.ROT&&(this.rotation[b]=e)},getAABB:function(){var a=CubicVR.mat4,b=CubicVR.vec3;if(this.dirty){var d=Array(8);this.doTransform();var e,h;if(this.obj){if(!this.obj.bb)return this.aabb=[b.add([-1,-1,-1],this.position),b.add([1,1,1],this.position)];e=this.obj.bb[0];h=this.obj.bb[1]}if(!this.obj||e===
g||h===g)return this.aabb=[b.add([-1,-1,-1],this.position),b.add([1,1,1],this.position)];var m=e;e=b.subtract(h,e);d[0]=[m[0],m[1],m[2]];d[1]=[m[0],m[1],m[2]+e[2]];d[2]=[m[0]+e[0],m[1],m[2]];d[3]=[m[0]+e[0],m[1],m[2]+e[2]];d[4]=[m[0],m[1]+e[1],m[2]];d[5]=[m[0],m[1]+e[1],m[2]+e[2]];d[6]=[m[0]+e[0],m[1]+e[1],m[2]];d[7]=[m[0]+e[0],m[1]+e[1],m[2]+e[2]];m=a.vec3_multiply(d[0],this.tMatrix);e=[m[0],m[1],m[2]];h=[m[0],m[1],m[2]];for(b=1;b<8;++b)m=a.vec3_multiply(d[b],this.tMatrix),e[0]>m[0]&&(e[0]=m[0]),
e[1]>m[1]&&(e[1]=m[1]),e[2]>m[2]&&(e[2]=m[2]),h[0]<m[0]&&(h[0]=m[0]),h[1]<m[1]&&(h[1]=m[1]),h[2]<m[2]&&(h[2]=m[2]);this.aabb[0]=e;this.aabb[1]=h;this.dirty=!1}return this.aabb}};var h=0;n.prototype={attachOctree:function(b){this.octree=b;b.init&&b.init(this);b=this.lights;this.lights=[];for(var d=0,m=b.length;d<m;d++)this.bindLight(b[d]);b=this.sceneObjects;if(this.octree!==g){d=0;for(m=b.length;d<m;++d){var h=b[d];if(h.obj!==null){if(h.id<0)h.id=e,++e;this.sceneObjectsById[h.id]=h;a.reset(h.octree_aabb,
h.position);this.octree.insert(h);(h.octree_common_root===void 0||h.octree_common_root===null)&&log("!!",h.name,"octree_common_root is null")}}}},setSkyBox:function(a){this.skybox=a},getSceneObject:function(a){return this.sceneObjectsByName[a]},bindSceneObject:function(b,d,m){if(this.sceneObjects.indexOf(b)==-1){this.sceneObjects.push(b);d!==g&&d&&this.pickables.push(b);b.name!==null&&(this.sceneObjectsByName[b.name]=b);if(this.octree!==g&&(m===g||m==="true")){if(b.id<0)b.id=e,++e;this.sceneObjectsById[b.id]=
b;a.reset(b.octree_aabb,b.position);this.octree.insert(b)}if(b.children)for(var h=0,n=b.children.length;h<n;h++)this.bindSceneObject(b.children[h],d,m);return b}},removeLight:function(a){a=this.lights.indexOf(a);a>=0&&this.lights.splice(a,1)},removeSceneObject:function(a){var b;b=this.sceneObjects.indexOf(a);b>=0&&this.sceneObjects.splice(b,1);b=this.pickables.indexOf(a);b>=0&&this.pickables.splice(b,1);a.name!==null&&this.sceneObjectsByName[a.name]!==g&&delete this.sceneObjectsByName[a.name];if(a.children){b=
0;for(var d=a.children.length;b<d;b++)this.removeSceneObject(a.children[b])}},bindLight:function(a,b){this.lights.push(a);if(this.octree!==g&&(b===g||b==="true"))a.method===d.light.method.GLOBAL?this.global_lights.push(a):(a.method===d.light.method.DYNAMIC&&this.dynamic_lights.push(a),this.octree.insert_light(a));this.lights=this.lights.sort(x)},bindCamera:function(a){this.cameras.indexOf(a)===-1&&(this.cameras.push(a),this.camerasByName[a.name]=a);this.camera=a},removeCamera:function(a){typeof a!==
"object"&&(a=this.getCamera(camName));this.cameras.indexOf(a)===-1&&(this.cameras.push(a),this.camerasByName[a.name]=a);return a},setCamera:function(a){if(a)typeof a!=="object"&&(a=this.getCamera(a)),this.camera=a},getCamera:function(a){if(a===g)return this.camera;return this.camerasByName[a]},evaluate:function(a){var b,d;b=0;for(d=this.sceneObjects.length;b<d;b++)this.sceneObjects[b].motion&&this.sceneObjects[b].motion.apply(a,this.sceneObjects[b]);if(this.camera.motion!==null){if(this.camera.targetSceneObject!==
null)this.camera.target=this.camera.targetSceneObject.position;this.camera.motion.apply(a,this.camera)}b=0;for(d=this.lights.length;b<d;b++){var e=this.lights[b];e.motion!==null&&e.motion.apply(a,e)}},prepareTransforms:function(a){var b,d;if(a){if(a.children){b=0;for(d=a.children.length;b<d;b++)a.children[b].doTransform(a.tMatrix),this.prepareTransforms(a.children[b])}}else if(this.sceneObjects.length!==0){b=0;for(d=this.sceneObjects.length;b<d;++b)this.prepareTransforms(this.sceneObjects[b])}},renderSceneObjectChildren:function(a,
b,d){for(var e=m.gl,h=!1,g=0,n=a.children.length;g<n;g++){var o=a.children[g];if(o.visible!==!1){try{o.doTransform(a.tMatrix)}catch(r){break}var v=o.obj;if(v){o.scale[0]<0&&(h=!h);o.scale[1]<0&&(h=!h);o.scale[2]<0&&(h=!h);h&&e.cullFace(e.FRONT);if(v.morphTargets&&(o.morphSource!==-1&&v.setMorphSource(o.morphSource),o.morphTarget!==-1&&v.setMorphTarget(o.morphTarget),o.morphWeight!==null))v.morphWeight=o.morphWeight;o.instanceMaterials&&v.bindInstanceMaterials(o.instanceMaterials);CubicVR.renderObject(v,
b,o.tMatrix,d);o.instanceMaterials&&v.bindInstanceMaterials(null);h&&e.cullFace(e.BACK)}o.children&&this.renderSceneObjectChildren(o,b,d)}}},updateShadows:function(){var a=m.gl,b=!1;if(v.features.lightShadows){this.updateCamera();for(var e=!1,h=a.getParameter(a.VIEWPORT),g=0,n=this.lights.length;g<n;g++){var o=this.lights[g];if(o.light_type==d.light.type.SPOT_SHADOW||o.light_type==d.light.type.SPOT_SHADOW_PROJECTOR||o.light_type==d.light.type.AREA){var e=!0,r=new CubicVR.Light(d.light.type.DEPTH_PACK);
if(o.light_type===d.light.type.AREA)o.areaCam=this.camera,o.updateAreaLight();m.shadow_near=o.dummyCam.nearclip;m.shadow_far=o.dummyCam.farclip;o.shadowBegin();for(var x=0,B=this.sceneObjects.length;x<B;x++){var z=this.sceneObjects[x];if(!z.parent&&!(z.visible===!1||z.shadowCast===!1)){z.doTransform();if(z.obj){z.scale[0]<0&&(b=!b);z.scale[1]<0&&(b=!b);z.scale[2]<0&&(b=!b);b&&a.cullFace(a.FRONT);var w=z.obj;if(w.morphTargets&&(z.morphSource!==-1&&w.setMorphSource(z.morphSource),z.morphTarget!==-1&&
w.setMorphTarget(z.morphTarget),z.morphWeight!==null))w.morphWeight=z.morphWeight;z.instanceMaterials&&w.bindInstanceMaterials(z.instanceMaterials);CubicVR.renderObject(w,o.dummyCam,z.tMatrix,[r]);z.instanceMaterials&&w.bindInstanceMaterials(null);b&&a.cullFace(a.BACK);b=!1}z.children&&this.renderSceneObjectChildren(z,o.dummyCam,[r])}}o.shadowEnd()}}e&&a.viewport(h[0],h[1],h[2],h[3])}},updateCamera:function(){this.camera.manual===!1&&(this.camera.targeted?this.camera.lookat(this.camera.position[0],
this.camera.position[1],this.camera.position[2],this.camera.target[0],this.camera.target[1],this.camera.target[2],0,1,0):this.camera.calcProjection());m.depth_alpha_near=this.camera.nearclip;m.depth_alpha_far=this.camera.farclip},resize:function(a,b){this.camera&&this.camera.setDimensions(a,b)},doTransform:function(){for(var a=this.octree!==g,b=0,d=this.sceneObjects.length;b<d;b++){var e=this.sceneObjects[b];if(e.parent===null&&(e.doTransform(),a&&(lights=[],e.dirty&&e.obj!==null&&e.adjust_octree(),
!(e.visible===!1||a&&(e.ignore_octree||e.drawn_this_frame===!0||e.culled===!0)))))lights=e.dynamic_lights,lights=lights.concat(e.static_lights),lights=lights.concat(this.global_lights),this.collect_stats&&(lights_rendered=Math.max(lights.length,lights_rendered),lights_rendered===lights.length&&(lights_list=lights),++objects_rendered),lights=lights.length===0?[m.emptyLight]:lights.sort(x),e.drawn_this_frame=!0}},render:function(){++this.frames;var a=m.gl,d;d=0;if(this.octree!==g)this.octree.reset_node_visibility(),
this.octree.cleanup(),d=this.octree.get_frustum_hits(this.camera),d=d.lights.length;this.doTransform();this.updateCamera();var e,h;e=0;for(h=this.lights.length;e<h;e++)this.lights[e].prepare(this.camera);var n=!1,o=[];e=0;for(h=this.sceneObjects.length;e<h;e++){var r=this.lights,u=this.sceneObjects[e];if(!(u.visible===!1||u.parent!==null)){if(u.obj){u.scale[0]<0&&(n=!n);u.scale[1]<0&&(n=!n);u.scale[2]<0&&(n=!n);n&&a.cullFace(a.FRONT);var v=u.obj;if(v.morphTargets!==null&&(u.morphSource!==-1&&v.setMorphSource(u.morphSource),
u.morphTarget!==-1&&v.setMorphTarget(u.morphTarget),u.morphWeight!==null))v.morphWeight=u.morphWeight;u.instanceMaterials&&v.bindInstanceMaterials(u.instanceMaterials);CubicVR.renderObject(v,this.camera,u.tMatrix,r);u.instanceMaterials&&v.bindInstanceMaterials(null);n&&a.cullFace(a.BACK);n=!1}u.children&&this.renderSceneObjectChildren(u,this.camera,r)}}if(this.collect_stats)this.stats["objects.num_rendered"]=0,this.stats["lights.num_rendered"]=d,this.stats["lights.rendered"]=o,this.stats["lights.num_global"]=
this.global_lights.length,this.stats["lights.num_dynamic"]=this.dynamic_lights.length;if(this.skybox!==null&&this.skybox.ready===!0)a.cullFace(a.FRONT),d=this.camera.farclip*2/Math.sqrt(3),this.skybox.scene_object.position=this.camera.parent?b.vec3_multiply(this.camera.position,this.camera.parent.tMatrix):[this.camera.position[0],this.camera.position[1],this.camera.position[2]],this.skybox.scene_object.scale=[d,d,d],this.skybox.scene_object.doTransform(),CubicVR.renderObject(this.skybox.scene_object.obj,
this.camera,this.skybox.scene_object.tMatrix,[]),a.cullFace(a.BACK)},bbRayTest:function(a,b,d){var e=CubicVR.vec3,h=[],b=b.length===2?this.camera.unProject(b[0],b[1]):e.add(a,b),g;for(g in this.pickables)if(this.pickables.hasOwnProperty(g)){var m=this.pickables[g];if(m.visible===!0){var n,o;o=m.getAABB();n=o[0];o=o[1];o[0]-n[0]<0.2&&(n[0]-=0.1,o[0]+=0.1);o[1]-n[1]<0.2&&(n[1]-=0.1,o[1]+=0.1);o[2]-n[2]<0.2&&(n[2]-=0.1,o[2]+=0.1);var r=e.multiply(e.add(n,o),0.5),v=e.getClosestTo(a,b,r),r=e.length(e.subtract(v,
r));(v[0]>=n[0]&&v[0]<=o[0]?1:0)+(v[1]>=n[1]&&v[1]<=o[1]?1:0)+(v[2]>=n[2]&&v[2]<=o[2]?1:0)>=d&&h.push({dist:r,obj:m})}}h.length&&h.sort(function(a,b){if(a.dist==b.dist)return 0;return a.dist<b.dist?-1:1});return h}};o.prototype={addMesh:function(a,b,d){this.meshBin[a]===g&&(this.meshBin[a]=[],this.meshBinPtr[a]===g&&(this.meshBinPtr[a]=0));this.meshMap[b]===g&&(this.meshMap[b]=d,this.meshBin[a].push(d))},addImage:function(a,b,d){this.imageBin[a]===g&&(this.imageBin[a]=[],this.imageBinPtr[a]===g&&
(this.imageBinPtr[a]=0));this.imageMap[b]===g&&(this.imageMap[b]=d,this.imageBin[a].push(d))},getMeshes:function(a){return this.meshBin[a]},getImages:function(a){return this.imageBin[a]},rewindMeshes:function(a){this.meshBinPtr[a]=0},rewindImages:function(a){this.imageBinPtr[a]=0},getNextMesh:function(a){var b=this.meshBinPtr[a];if(b<this.meshBin[a].length)return this.meshBinPtr[a]++,this.meshBin[a][b];return null},loadNextMesh:function(a){a=this.getNextMesh(a);if(a!==null)return a.compiled===null&&
(a.triangulateQuads(),a.compile(),a.clean()),!0;return!1},isMeshBinEmpty:function(a){return this.meshBinPtr[a]===this.meshBin[a].length},loadNextImage:function(a){a=this.getNextImage(a);if(a!==null)a.src=a.deferredSrc},getNextImage:function(a){var b=this.imageBinPtr[a];if(b<this.imageBin[a].length)return this.imageBinPtr[a]++,this.imageBin[a][b];return null},isImageBinEmpty:function(a){return this.imageBinPtr[a]===this.imageBin[a].length}};return{Scene:n,SceneObject:r,SkyBox:function(a){var b=a.texture,
a=a.mapping,d=this;this.mapping=null;this.ready=!1;this.texture=null;this.onready=function(){b.onready=null;var a=1/v.Images[d.texture.tex_id].width;if(d.mapping===null)d.mapping=[[1/3,0.5,2/3-a,1],[0,0.5,1/3,1],[0,0,1/3-a,0.5],[2/3,0,1,0.5],[2/3+a,0.5,1,1],[1/3,0,2/3,0.5]];var a=new CubicVR.Material({name:"skybox",textures:{color:b}}),c=new CubicVR.Mesh;c.sky_mapping=d.mapping;CubicVR.primitives.box({mesh:c,size:1,material:a,uvmapper:{projectionMode:CubicVR.enums.uv.projection.SKY,scale:[1,1,1]}});
c.prepare();d.scene_object=new CubicVR.SceneObject(c);d.ready=!0};if(b){if(typeof b==="string")b=new CubicVR.Texture(b,null,null,null,this.onready);else if(!b.loaded)b.onready=this.onready;this.texture=b;if(a)this.mapping=a,this.onready()}},DeferredBin:o}});CubicVR.RegisterModule("ScenePhysics",function(v){function x(a,b){b.setX(a[0]);b.setY(a[1]);b.setZ(a[2])}function r(a){return new Ammo.btVector3(a[0],a[1],a[2])}function n(a){b.fromEuler(a[0],a[1],a[2]);return new Ammo.btQuaternion(b.x,b.y,b.z,b.w)}function o(a){return[a.x(),a.y(),a.z()]}var g=v.undef,d=CubicVR.enums,m=v.nop;d.physics={body:{STATIC:0,DYNAMIC:1,SOFT:2},constraint:{P2P:0}};var a,b,e,v=function(a,b){this.properties=new CubicVR.RigidProperties(b?b:{});this.collisionEvents=[];this.parent=
null;this.init_position=a.position.slice(0);this.init_rotation=a.rotation.slice(0);this.sceneObject=a;this.transform=new Ammo.btTransform;this.transform.setIdentity();this.transform.setOrigin(r(this.init_position));this.transform.setRotation(n(this.init_rotation));this.shape=null;this.motionState=new Ammo.btDefaultMotionState(this.transform);this.localInertia=new Ammo.btVector3(0,0,0);this.body=this.bodyInit=null;this.noDeactivate=!1};v.prototype={getProperties:function(){return this.properties},
getSceneObject:function(){return this.sceneObject},getInitialPosition:function(){return this.init_position},getInitialRotation:function(){return this.init_rotation},setInitialPosition:function(){this.init_position=init_position_in},setInitialRotation:function(){this.init_rotation=init_rotation_in},getType:function(){return this.properties.type},getMass:function(){return this.properties.mass},getRestitution:function(){return this.properties.restitution},getCollisionMap:function(){return this.properties.collision},
setMass:function(a){this.properties.mass=a},setRestitution:function(a){this.restitution=a},getBody:function(){if(!this.body){var a=this.getCollisionShape();this.getMass()&&a.calculateLocalInertia(this.getMass(),this.localInertia);this.bodyInit=new Ammo.btRigidBodyConstructionInfo(this.getMass(),this.motionState,a,this.localInertia);this.body=new Ammo.btRigidBody(this.bodyInit);this.getRestitution()&&this.body.setRestitution(this.getRestitution())}return this.body},updateSceneObject:function(c){if(this.body&&
(this.body.isActive()||c))return this.body.getMotionState().getWorldTransform(a),c=a.getOrigin(),c.x!=c.x?console.log("origin is NaN"):(this.sceneObject.position[0]=c.x(),this.sceneObject.position[1]=c.y(),this.sceneObject.position[2]=c.z()),c=a.getRotation(),b.x=c.x(),b.y=c.y(),b.z=c.z(),b.w=c.w(),b.x!=b.x?console.log("rotation is NaN"):(c=b.toEuler(),this.sceneObject.rotation[0]=c[0],this.sceneObject.rotation[1]=c[1],this.sceneObject.rotation[2]=c[2]),!0},reset:function(){var a=this.body.getWorldTransform().getOrigin();
x(this.init_position,a);var a=this.body.getWorldTransform().getRotation(),c=this.init_rotation;b.fromEuler(c[0],c[1],c[2]);a.setX(this.init_rotation[0]);a.setY(this.init_rotation[1]);a.setZ(this.init_rotation[2]);a.setW(this.init_rotation[3]);x([0,0,0],e);this.body.setLinearVelocity(e);this.body.setAngularVelocity(e);this.activate()},getCollisionShape:function(){if(!this.shape){var b;b=this.getCollisionMap();if(b.getResult())b=b.getResult();else{var c=b.getShapes(),e,h,g,o=[];h=0;for(g=c.length;h<
g;h++){e=c[h];var u=null;if(e.type===d.collision.shape.BOX)u=new Ammo.btBoxShape(new Ammo.btVector3(e.size[0]/2,e.size[1]/2,e.size[2]/2));else if(e.type===d.collision.shape.SPHERE)u=new Ammo.btSphereShape(e.radius);else if(e.type===d.collision.shape.CAPSULE)u=new Ammo.btCapsuleShape(e.radius,e.height);else if(e.type===d.collision.shape.CYLINDER)u=new Ammo.btCylinderShape(new Ammo.btVector3(e.size[0]/2,e.size[1]/2,e.size[2]/2));else if(e.type===d.collision.shape.CONE)u=new Ammo.btConeShape(e.radius,
e.height);else if(e.type===d.collision.shape.MESH){var u=e.mesh,v=new Ammo.btTriangleMesh,x=e.size,z=new Ammo.btVector3(0,0,0),w=new Ammo.btVector3(0,0,0),y=new Ammo.btVector3(0,0,0);f=0;for(fMax=u.faces.length;f<fMax;f++){var P=u.faces[f];P.points.length===3&&(z.setValue(u.points[P.points[0]][0]*x[0],u.points[P.points[0]][1]*x[1],u.points[P.points[0]][2]*x[2]),w.setValue(u.points[P.points[1]][0]*x[0],u.points[P.points[1]][1]*x[1],u.points[P.points[1]][2]*x[2]),y.setValue(u.points[P.points[2]][0]*
x[0],u.points[P.points[2]][1]*x[1],u.points[P.points[2]][2]*x[2]),v.addTriangle(z,w,y))}this.getMass()===0||this.getType()==d.physics.body.STATIC?(this.setMass(0),u=new Ammo.btBvhTriangleMeshShape(v,!0)):u=new Ammo.btConvexTriangleMeshShape(v,!0)}else e.type===d.collision.shape.HEIGHTFIELD&&m();u&&(e.margin!==0&&u.setMargin(e.margin),o.push({cShape:e,btShape:u}))}c=null;if(o.length===1)c=o[0].btShape;else if(o.length>1){a=new Ammo.btTransform;c=new Ammo.btCompoundShape(!1);h=0;for(g=o.length;h<g;h++)a.setIdentity(),
a.setOrigin(r(o[h].cShape.position)),a.setRotation(n(o[h].cShape.rotation)),c.addChildShape(a,o[h].btShape)}b.setResult(c);b=c}this.shape=b}return this.shape},setAngularVelocity:function(a){this.body&&(x(a,e),this.body.setAngularVelocity(e))},setLinearVelocity:function(a){this.body&&(x(a,e),this.body.setLinearVelocity(e))},getAngularVelocity:function(){return o(this.body.getAngularVelocity())},getLinearVelocity:function(){return o(this.body.getLinearVelocity())},activate:function(a){this.noDeactivate=
a||!1;this.body&&(this.noDeactivate&&this.body.setActivationState(Ammo.DISABLE_DEACTIVATION),this.body.activate())},setAngularFactor:function(a){this.body&&a!==g&&(a.length||(a=[a,a,a]),x(a,e),this.body.setAngularFactor(e))}};var h=function(a){a=a||{};this.ctype=a.ctype||d.physics.constraint.P2P;this.strength=a.strength||0.1;this.maxImpulse=a.maxImpulse||0;this.rigidBodyA=a.rigidBodyA||a.rigidBody||null;this.rigidBodyB=a.rigidBodyB||null;this.positionA=a.positionA||[0,0,0];this.positionB=a.positionB||
a.position||[0,0,0];this.damping=a.damping!=g?a.damping:1;this.btConstraint=null;this.localPivotA=r(this.positionA);this.localPivotB=r(this.positionB)};h.prototype={getConstraint:function(){if(!this.btConstraint){if(!this.rigidBodyA)return!1;if(this.ctype===d.physics.constraint.P2P&&(this.btConstraint=this.rigidBodyA&&this.rigidBodyB?new Ammo.btPoint2PointConstraint(this.rigidBodyA.getBody(),this.rigidBodyB.getBody(),this.localPivotA,this.localPivotB):new Ammo.btPoint2PointConstraint(this.rigidBodyA.getBody(),
this.localPivotA),this.btConstraint.get_m_setting().set_m_tau(this.strength),this.btConstraint.get_m_setting().set_m_damping(this.damping),this.maxImpulse&&this.btConstraint.get_m_setting().set_m_impulseClamp(this.maxImpulse),this.btConstraint===NULL))this.btConstraint=null}return this.btConstraint},setStrength:function(a){this.strength=a;this.btConstraint&&this.btConstraint.get_m_setting().set_m_tau(this.strength)},setDamping:function(a){this.damping=a;this.btConstraint&&this.btConstraint.get_m_setting().set_damping(this.damping)},
setMaxImpulse:function(a){this.maxImpulse=a;this.btConstraint&&this.btConstraint.get_m_setting().set_impulseClamp(this.maxImpulse)},getStrength:function(){return this.strength},setPosition:function(a){this.positionB=a;this.btConstraint&&(x(this.positionB,this.localPivotB),this.btConstraint.setPivotB(this.localPivotB))},getPosition:function(){return this.positionB}};var c=function(){this.rigidObjects=[];this.active_count=0;this.collisionConfiguration=new Ammo.btDefaultCollisionConfiguration;this.dispatcher=
new Ammo.btCollisionDispatcher(this.collisionConfiguration);this.overlappingPairCache=new Ammo.btDbvtBroadphase;this.solver=new Ammo.btSequentialImpulseConstraintSolver;this.dynamicsWorld=new Ammo.btDiscreteDynamicsWorld(this.dispatcher,this.overlappingPairCache,this.solver,this.collisionConfiguration);this.dynamicsWorld.setGravity(new Ammo.btVector3(0,-10,0));if(!a||!b)e=new Ammo.btVector3,a=new Ammo.btTransform,b=new CubicVR.Quaternion};c.prototype={addConstraint:function(a){var b=a.getConstraint();
if(b)return this.dynamicsWorld.addConstraint(b),a.rigidBodyA.activate(!0),!0;return!1},removeConstraint:function(a){if(a=a.getConstraint())return this.dynamicsWorld.removeConstraint(a),!0;return!1},setGravity:function(a){x(a,e);this.dynamicsWorld.setGravity(e)},bindSceneObject:function(a,b){var c=new CubicVR.RigidBody(a,b);this.rigidObjects.push(c);c.getBody();c.activate();this.dynamicsWorld.addRigidBody(c.getBody());c.updateSceneObject(!0);return c},bindRigidBody:function(a){if(this.rigidObjects.indexOf(a)===
-1){this.rigidObjects.push(a);var b=a.getBody();a.activate();this.dynamicsWorld.addRigidBody(b);a.updateSceneObject(!0)}},getActiveCount:function(){return this.active_count},stepSimulation:function(a,b){this.dynamicsWorld.stepSimulation(a,b||2);for(var c=0,e=0,d=this.rigidObjects.length;e<d;e++)this.rigidObjects[e].updateSceneObject()&&c++;this.active_count=c},reset:function(){for(var a=0,b=this.rigidObjects.length;a<b;a++)this.rigidObjects[a].reset()},getRayHit:function(a,b,c,e){var d,a=r(a);d=r(b);
c=c||!1;e=e||!1;b=new Ammo.ClosestRayResultCallback(a,d);this.dynamicsWorld.rayTest(a,d,b);if(b.hasHit()&&(body=Ammo.btRigidBody.prototype.upcast(b.get_m_collisionObject()),body!==NULL&&!(body.isStaticObject()&&!c||body.isKinematicObject()&&!e))){e=body;c=b.get_m_hitPointWorld();a=0;for(b=this.rigidObjects.length;a<b;a++)if(Ammo.compare(this.rigidObjects[a].body,e))return e=this.rigidObjects[a],a=this.rigidObjects[a].body.getCenterOfMassTransform().inverse().op_mul(c),{position:o(c),localPosition:o(a),
rigidBody:e}}}};return{ScenePhysics:c,Constraint:h,RigidProperties:function(a){this.type=a.type!==g?a.type:d.physics.body.DYNAMIC;this.mass=a.mass!==g?a.mass:this.type?1:0;this.size=a.size||[1,1,1];this.restitution=a.restitution||(this.type?0:1);this.friction=a.friction||1;if((this.collision=a.collision)&&!this.collision.getShapes)this.collision=new CubicVR.CollisionMap(this.collision)},RigidBody:v}});CubicVR.RegisterModule("Shader",function(v){function x(a,b){var e=CubicVR.util,h,c;this.uniforms=[];this.uniform_type=[];this.uniform_typelist=[];a.indexOf("\n")!==-1?h=d(n.gl,a,"x-shader/x-vertex"):(h=m(n.gl,a),h===null&&(c=e.getURL(a),h=d(n.gl,c,"x-shader/x-vertex")));b.indexOf("\n")!==-1?c=d(n.gl,b,"x-shader/x-fragment"):(c=m(n.gl,b),c===null&&(c=e.getURL(b),c=d(n.gl,c,"x-shader/x-fragment")));this.shader=n.gl.createProgram();n.gl.attachShader(this.shader,h);n.gl.attachShader(this.shader,c);n.gl.linkProgram(this.shader);
if(!n.gl.getProgramParameter(this.shader,n.gl.LINK_STATUS))throw Error("Could not initialise shader vert("+a+"), frag("+b+")");}var r=v.undef,n=v.GLCore,o=CubicVR.enums,g=v.log;o.shader={map:{COLOR:1,SPECULAR:2,NORMAL:4,BUMP:8,REFLECT:16,ENVSPHERE:32,AMBIENT:64,ALPHA:128},uniform:{MATRIX:0,VECTOR:1,FLOAT:2,ARRAY_VERTEX:3,ARRAY_UV:4,ARRAY_FLOAT:5,INT:6}};var d=function(a,b,e){if(e==="x-shader/x-fragment")e=a.createShader(a.FRAGMENT_SHADER);else if(e==="x-shader/x-vertex")e=a.createShader(a.VERTEX_SHADER);
else return null;a.shaderSource(e,b);a.compileShader(e);if(!a.getShaderParameter(e,a.COMPILE_STATUS))return g(a.getShaderInfoLog(e)),null;return e},m=function(a,b){var e=document.getElementById(b);if(!e)return null;for(var d="",c=e.firstChild;c;)c.nodeType===3&&(d+=c.textContent),c=c.nextSibling;if(e.type==="x-shader/x-fragment")e=a.createShader(a.FRAGMENT_SHADER);else if(e.type==="x-shader/x-vertex")e=a.createShader(a.VERTEX_SHADER);else return null;a.shaderSource(e,d);a.compileShader(e);a.getShaderParameter(e,
a.COMPILE_STATUS)||g(a.getShaderInfoLog(e));return e};x.prototype={bindSelf:function(a){var b,e,d;a.indexOf(".")!==-1?a.indexOf("[")!==-1?(b=a.split("["),d=b[0],b=b[1].split("]"),e=b[0],b=b[1].split("."),b=b[1],this[d]===r&&(this[d]=[]),this[d][e]===r&&(this[d][e]={}),this[d][e][b]=this.uniforms[a]):(b=a.split("."),d=b[0],b=b[1],this[d]===r&&(this[d]={}),this[d][b]=this.uniforms[a]):a.indexOf("[")!==-1?(b=a.split("["),d=b[0],b=b[1].split("]"),e=b[0],this[d]===r&&(this[d]=[]),this[d][e]=this.uniforms[a]):
this[a]=this.uniforms[a]},addMatrix:function(a,b){this.use();this.uniforms[a]=n.gl.getUniformLocation(this.shader,a);this.uniform_type[a]=o.shader.uniform.MATRIX;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);b!==r&&this.setMatrix(a,b);this.bindSelf(a);return this.uniforms[a]},addVector:function(a,b){this.use();this.uniforms[a]=n.gl.getUniformLocation(this.shader,a);this.uniform_type[a]=o.shader.uniform.VECTOR;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);
b!==r&&this.setVector(a,b);this.bindSelf(a);return this.uniforms[a]},addFloat:function(a,b){this.use();this.uniforms[a]=n.gl.getUniformLocation(this.shader,a);this.uniform_type[a]=o.shader.uniform.FLOAT;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);b!==r&&this.setFloat(a,b);this.bindSelf(a);return this.uniforms[a]},addVertexArray:function(a){this.use();this.uniforms[a]=n.gl.getAttribLocation(this.shader,a);this.uniform_type[a]=o.shader.uniform.ARRAY_VERTEX;this.uniform_typelist.push([this.uniforms[a],
this.uniform_type[a]]);this.bindSelf(a);return this.uniforms[a]},addUVArray:function(a){this.use();this.uniforms[a]=n.gl.getAttribLocation(this.shader,a);this.uniform_type[a]=o.shader.uniform.ARRAY_UV;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);this.bindSelf(a);return this.uniforms[a]},addFloatArray:function(a){this.use();this.uniforms[a]=n.gl.getAttribLocation(this.shader,a);this.uniform_type[a]=o.shader.uniform.ARRAY_FLOAT;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);
this.bindSelf(a);return this.uniforms[a]},addInt:function(a,b){this.use();this.uniforms[a]=n.gl.getUniformLocation(this.shader,a);this.uniform_type[a]=o.shader.uniform.INT;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);b!==r&&this.setInt(a,b);this.bindSelf(a);return this.uniforms[a]},use:function(){n.gl.useProgram(this.shader)},setMatrix:function(a,b){var d=this.uniforms[a];if(d!==null){var h=b.length;h===16?n.gl.uniformMatrix4fv(d,!1,b):h===9?n.gl.uniformMatrix3fv(d,!1,b):h===
4&&n.gl.uniformMatrix2fv(d,!1,b)}},setInt:function(a,b){var d=this.uniforms[a];d!==null&&n.gl.uniform1i(d,b)},setFloat:function(a,b){var d=this.uniforms[a];d!==null&&n.gl.uniform1f(d,b)},setVector:function(a,b){var d=this.uniforms[a];if(d!==null){var h=b.length;h==3?n.gl.uniform3fv(d,b):h==2?n.gl.uniform2fv(d,b):n.gl.uniform4fv(d,b)}},clearArray:function(a){a=this.uniforms[a];a!==null&&n.gl.disableVertexAttribArray(a)},bindArray:function(a,b){var d=n.gl,h=this.uniforms[a];if(h!==null){var c=this.uniform_type[a];
c===o.shader.uniform.ARRAY_VERTEX?(d.bindBuffer(d.ARRAY_BUFFER,b),d.vertexAttribPointer(h,3,d.FLOAT,!1,0,0),d.enableVertexAttribArray(h)):c===o.shader.uniform.ARRAY_UV?(d.bindBuffer(d.ARRAY_BUFFER,b),d.vertexAttribPointer(h,2,d.FLOAT,!1,0,0)):c===o.shader.uniform.ARRAY_FLOAT&&(d.bindBuffer(d.ARRAY_BUFFER,b),d.vertexAttribPointer(h,1,d.FLOAT,!1,0,0))}}};return{Shader:x}});CubicVR.RegisterModule("UVMapper",function(v){function x(a){a!==r?(this.rotation=a.rotation===r?[0,0,0]:a.rotation,this.scale=a.scale===r?[1,1,1]:a.scale,this.center=a.center===r?[0,0,0]:a.center,this.projection_mode=a.projectionMode===r?n.uv.projection.PLANAR:a.projectionMode,this.projection_axis=a.projectionAxis===r?n.uv.axis.X:a.projectionAxis,this.wrap_w_count=a.wrapW===r?1:a.wrapW,this.wrap_h_count=a.wrapH===r?1:a.wrapH):(this.rotation=[0,0,0],this.scale=[1,1,1],this.center=[0,0,0],this.projection_mode=
n.uv.projection.PLANAR,this.projection_axis=n.uv.axis.X,this.wrap_h_count=this.wrap_w_count=1)}var r=v.undef,n=CubicVR.enums,o=2*Math.PI,g=Math.PI/2;n.uv={axis:{X:0,Y:1,Z:2},projection:{UV:0,PLANAR:1,CYLINDRICAL:2,SPHERICAL:3,CUBIC:4,SKY:5}};var d=function(a,b,d){return a===0&&d===0?0:d===0?a<0?g:-g:d<0?-Math.atan(a/d)+Math.PI:-Math.atan(a/d)},m=function(a,b,d){var h;a===0&&d===0?(h=0,a=b!==0?b<0?-g:g:0):(h=d===0?a<0?g:-g:d<0?-Math.atan(a/d)+Math.PI:-Math.atan(a/d),a=Math.sqrt(a*a+d*d),a=a===0?b<
0?-g:g:Math.atan(b/a));return[h,a]};x.prototype={setRotation:function(a){this.rotation=a},setScale:function(a){this.scale=a},setCenter:function(a){this.center=a},setProjectionAxis:function(a){this.projection_axis=a},setProjectionMode:function(a){this.projection_mode=a},setWrapW:function(a){this.wrap_w_count=a},setWrapH:function(a){this.wrap_h_count=a},apply:function(a,b,e,h,c){var q=CubicVR.mat4,t,s,v,x,I,u=new CubicVR.Transform,D=!1,B=null;if(this.center[0]||this.center[1]||this.center[2])u.translate(-this.center[0],
-this.center[1],-this.center[2]),D=!0;if(this.rotation[0]||this.rotation[1]||this.rotation[2])this.rotation[0]&&u.rotate(this.rotation[2],0,0,1),this.rotation[1]&&u.rotate(this.rotation[1],0,1,0),this.rotation[2]&&u.rotate(this.rotation[0],1,0,0),D=!0;D&&(B=u.getResult());typeof b==="object"&&(b=a.materials.indexOf(b));var u=0,z=a.faces.length;h&&(u=h);for(c&&(z=c+1);u<z;u++)if(a.faces[u].material===b&&!(e!==r&&a.faces[u].segment!==e)){var w,y,P;if(this.projection_mode===n.uv.projection.CUBIC||this.projection_mode===
n.uv.projection.SKY)w=Math.abs(a.faces[u].normal[0]),y=Math.abs(a.faces[u].normal[1]),P=Math.abs(a.faces[u].normal[2]);for(var h=[],c=0,C=a.faces[u].points.length;c<C;c++){s=a.faces[u].points[c];var E=a.faces[u].points[(c+1)%3],Q=a.faces[u].points[(c+2)%3];t=a.points[s];var J=a.points[E],H=a.points[Q],F;D&&(t=q.vec3_multiply(t,B));F=this.projection_mode;if(F===n.uv.projection.SKY)s=a.sky_mapping,w>=y&&w>=P&&(v=t[2]/this.scale[2]+this.scale[2]/2,x=-t[1]/this.scale[1]+this.scale[1]/2,a.faces[u].normal[0]<
0?(v=(s[2][2]-s[2][0])*(1-v),x=1-(s[2][3]-s[2][1])*x,v+=s[2][0],x+=s[2][1]):(v*=s[3][2]-s[3][0],x=1-(s[3][3]-s[3][1])*x,v+=s[3][0],x+=s[3][1])),y>=w&&y>=P&&(v=t[0]/this.scale[0]+this.scale[0]/2,x=-t[2]/this.scale[2]+this.scale[2]/2,a.faces[u].normal[1]<0?(v*=s[1][2]-s[1][0],x=1-(s[1][3]-s[1][1])*x,v+=s[1][0],x-=s[1][1]):(v*=s[0][2]-s[0][0],x=1-(s[0][3]-s[0][1])*x,v+=s[0][0],x-=s[0][1])),P>=w&&P>=y&&(v=t[0]/this.scale[0]+this.scale[0]/2,x=t[1]/this.scale[1]+this.scale[1]/2,a.faces[u].normal[2]<0?(v*=
s[4][2]-s[4][0],x=1-(s[4][3]-s[4][1])*(1-x),v+=s[4][0],x-=s[4][1]):(v=(s[5][2]-s[5][0])*(1-v),x=1-(s[5][3]-s[5][1])*(1-x),v+=s[5][0],x+=s[5][1])),a.faces[u].setUV([v,x],c);else if(F===n.uv.projection.CUBIC)w>=y&&w>=P&&(v=t[2]/this.scale[2]+0.5,x=t[1]/this.scale[1]+0.5),y>=w&&y>=P&&(v=-t[0]/this.scale[0]+0.5,x=t[2]/this.scale[2]+0.5),P>=w&&P>=y&&(v=-t[0]/this.scale[0]+0.5,x=t[1]/this.scale[1]+0.5),a.faces[u].normal[0]>0&&(v=-v),a.faces[u].normal[1]<0&&(v=-v),a.faces[u].normal[2]>0&&(v=-v),a.faces[u].setUV([v,
x],c);else if(F===n.uv.projection.PLANAR)v=this.projection_axis===n.uv.axis.X?t[2]/this.scale[2]+0.5:-t[0]/this.scale[0]+0.5,x=this.projection_axis===n.uv.axis.Y?t[2]/this.scale[2]+0.5:t[1]/this.scale[1]+0.5,a.faces[u].setUV([v,x],c);else{if(F===n.uv.projection.CYLINDRICAL)F=this.projection_axis,F===n.uv.axis.X?(I=d(t[2],t[0],-t[1]),x=-t[0]/this.scale[0]+0.5):F===n.uv.axis.Y?(I=d(-t[0],t[1],t[2]),x=-t[1]/this.scale[1]+0.5):F===n.uv.axis.Z&&(I=d(-t[0],t[2],-t[1]),x=-t[2]/this.scale[2]+0.5),I=1-I/o,
this.wrap_w_count!==1&&(I*=this.wrap_w_count),t=I,s=x;else if(F===n.uv.projection.SPHERICAL){var G,O,K;F=this.projection_axis;F===n.uv.axis.X?(G=h[s]?h[s]:m(t[2],t[0],-t[1]),h[s]||(h[s]=G),O=h[E]?h[E]:m(J[2],J[0],-J[1]),h[E]||(h[E]=O),K=h[Q]?h[Q]:m(H[2],H[0],-H[1]),h[Q]||(h[Q]=K)):F===n.uv.axis.Y?(G=h[s]?h[s]:m(t[0],-t[1],t[2]),h[s]||(h[s]=G),O=h[E]?h[E]:m(J[0],-J[1],J[2]),h[E]||(h[E]=O),K=h[Q]?h[Q]:m(H[0],-H[1],H[2]),h[Q]||(h[Q]=K)):F===n.uv.axis.Z&&(G=h[s]?h[s]:m(-t[0],t[2],-t[1]),h[s]||(h[s]=G),
O=h[E]?h[E]:m(-J[0],J[2],-J[1]),h[E]||(h[E]=O),K=h[Q]?h[Q]:m(-H[0],H[2],-H[1]),h[Q]||(h[Q]=K));Math.abs(G[0]-O[0])>g&&Math.abs(G[0]-K[0])>g&&(G[0]>O[0]&&G[0]>K[0]?G[0]-=o:G[0]+=o);Math.abs(G[1]-O[1])>g&&Math.abs(G[1]-K[1])>g&&(G[1]>O[1]&&G[1]>K[1]?G[1]-=o:G[1]+=o);I=1-G[0]/o;s=0.5-G[1]/Math.PI;this.wrap_w_count!==1&&(I*=this.wrap_w_count);this.wrap_h_count!==1&&(s*=this.wrap_h_count);t=I}else s=t=0;a.faces[u].setUV([t,s],c)}}}return this}};return{UVMapper:x}});CubicVR.RegisterModule("Utility",function(v){var x=v.undef;return{util:{getScriptContents:function(r){var n=document.getElementById(r),o="",g="";if(n){if(n.src!==""||n.attributes.srcUrl!==x)g=n.src!==""?n.src:n.attributes.srcUrl.value}else g=r;if(g.length!==0){if(r=new XMLHttpRequest,r.open("GET",g,!1),r.send(null),r.status===200||r.status===0)o=r.responseText}else for(g=n.firstChild;g;)g.nodeType===3&&(o+=g.textContent),g=g.nextSibling;return o},getURL:function(r){try{var n=new XMLHttpRequest;n.open("GET",
r,!1);n.send(null);if(n.status===200||n.status===0)if(n.responseText.length)return n.responseText;else if(n.responseXML)return n.responseXML}catch(o){alert(r+" failed to load.")}return null},getXML:function(r){try{var n=new XMLHttpRequest;n.open("GET",r,!1);n.overrideMimeType("application/xml");n.send(null);if(n.status===200||n.status===0)return n.responseXML}catch(o){try{alert(r+" failed to load.")}catch(g){throw o;}}return null},getJSON:function(r){try{var n=new XMLHttpRequest;n.open("GET",r,!1);
n.overrideMimeType("application/json");n.send(null);if(n.status===200||n.status===0)return eval("("+n.responseText+")")}catch(o){try{alert(r+" failed to load.")}catch(g){throw o;}}return null},repackArray:function(r,n,o){r.length!==parseInt(n,10)*parseInt(o,10)&&log("array repack error, data size !== stride*count: data.length="+r.length+" stride="+n+" count="+o);for(var o=[],g=0,d=0,m=r.length;d<m;d++){var a=d%n;a===0&&(o[g]=[]);o[g][a]=r[d];a===n-1&&g++}return o},collectTextNode:function(r){if(!r)return"";
for(var n="",r=r.childNodes,o=0,g=r.length;o<g;o++)n+=r[o].nodeValue;return n},floatDelimArray:function(r,n){for(var o=r.split(n?n:","),g=0,d=o.length;g<d;g++)o[g]=parseFloat(o[g]);o[o.length-1]!==o[o.length-1]&&o.pop();return o},intDelimArray:function(r,n){for(var o=r.split(n?n:","),g=0,d=o.length;g<d;g++)o[g]=parseInt(o[g],10);o[o.length-1]!==o[o.length-1]&&o.pop();return o},textDelimArray:function(r,n){for(var o=r.split(n?n:","),g=0,d=o.length;g<d;g++)o[g]=o[g];return o},xml2badgerfish:function(r){var n=
{},o=[],g,d,m,a,b,e=/^\s+|\s+$/g;r.jsonParent=n;for(o.push(r);o.length;){d=o.pop();var h=null;m=d.jsonParent;r=0;for(g=d.childNodes.length;r<g;r++)a=d.childNodes[r],b=a.tagName,b!==x&&(h=h||{},h[b]=h[b]||0,h[b]++);if(d.attributes&&d.attributes.length){r=0;for(g=d.attributes.length;r<g;r++)a=d.attributes[r],m["@"+a.name]=a.value}r=0;for(g=d.childNodes.length;r<g;r++)if(a=d.childNodes[r],b=a.tagName,a.nodeType===1)h[b]>1?(m[b]=m[b]||[],m[b].push({}),a.jsonParent=m[b][m[b].length-1]):(m[b]=m[b]||{},
a.jsonParent=m[b]),o.push(a);else if(a.nodeType===3&&a.nodeValue.replace(e,"")!=="")m.$=m.$||"",m.$+=a.nodeValue}return n}}}});CubicVR.RegisterModule("Worker",function(v){function x(a){var b=this;this.message=a.message||function(){};this.send=function(a,b){postMessage({message:a,data:b})};self.addEventListener("message",function(a){a.data.message!=="init"&&b.message(a.data)},!1)}function r(a){function b(a){setTimeout(function(){c.send("test",a)},1E3)}a&&b(a);var c=new x({message:b})}function n(a){function b(a){a=s.getURL(a);c.send("done",a.length)}var c;c=new x({message:function(a){b(a)}});a&&b(a)}function o(a){function b(a){a=
s.getURL(a);c.send("loaded",a)}var c,d;c=new x({message:function(a){if(a.message==="parse")d=new t,CubicVR.loadCollada("","",d,a.data),c.send("parsed");else if(a.message==="getMesh"){if(a=d.meshMap[":"+a.data]){var b=a.triangulateQuads().compileVBO(a.compileMap());c.send("getMesh",{mesh:a,vbo:b})}}else throw Error("Not a SceneFileWorker command: "+a.message);}});a&&b(a)}function g(b){function c(b){var e=new a,h;for(h in b)b.hasOwnProperty(h)&&(e[h]=b[h]);b=e.triangulateQuads().compileVBO(e.compileMap());
d.send("done",b)}var d;d=new x({message:function(a){c(a)}});b&&c(b)}try{if(!window)self.window=self,self.document={},self.fakeWindow=!0,self.console={log:function(){}}}catch(d){self.window=self,self.document={},self.fakeWindow=!0,self.console={log:function(){}}}var m=v.undef,a=CubicVR.Mesh,b=CubicVR.Texture,e=CubicVR.Material,h=CubicVR.SceneObject,c=CubicVR.Motion,q=CubicVR.Envelope,t=CubicVR.DeferredBin,s=CubicVR.util;return{Worker:function(a){this.worker=new Worker(CubicVR.getScriptLocation()+"CubicVR.js");
this.message=a.message||function(){};this.error=a.error||function(a){console.log("Error: "+a.message+": "+a.lineno)};this.type=a.type;var b=this;this.worker.onmessage=function(a){b.message(a.data)};this.worker.onerror=function(a){b.error(a)};this.init=function(a){b.send("init",{type:b.type,data:a})};this.send=function(a,c){b.worker.postMessage({message:a,data:c})};this.send("CubicVR_InitWorker",CubicVR.getScriptLocation());(a.data||a.autoStart)&&b.init(a.data)},ResourcePool:function(){function c(b){var d=
b.parsed||function(){},e={},h;b.url.match(/\.dae/)&&(h=new CubicVR.Worker({type:"sceneFile",data:b.url,message:function(b){if(b.message==="loaded"){var b=(new DOMParser).parseFromString(b.data,"text/xml"),c=s.xml2badgerfish(b);console.log(b);h.send("parse",c)}else if(b.message==="getMesh"){var c=new a,g;for(g in b.data.mesh)b.data.mesh.hasOwnProperty(g)&&(c[g]=b.data.mesh[g]);c.bindBuffer(c.bufferVBO(b.data.vbo));e.getMesh&&e.getMesh(c)}else b.message==="parsed"&&d()}}));this.getSceneObject=function(a,
b){h.send("getMesh",a);e.getMesh=b}}function d(a,b){for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b}var g=this,m={};this.createSceneFileManager=function(a){var b=new c({url:a.url,parsed:a.parsed});return m[a.url]=b};this.removeSceneFileManager=function(a){if(typeof settings==="string")delete m[settings];else for(var b in m)m[b]===a&&delete m[b]};this.createSceneObjectFromMesh=function(c){var m=c.scene,n=c.object,o=c.assetBase||"",q=g.createSceneFileManager({url:c.mesh,parsed:function(){n&&
q.getSceneObject(n,function(c){for(var c=d(c,new a),g=0,n=c.materials.length;g<n;++g){for(var q=d(c.materials[g],new e),r=0,s=q.textures.length;r<s;++r){var t=q.textures[g];q.textures[g]=new b(o+t.img_path,t.filter_type)}c.materials[g]=q}c=new h(c);m.bindSceneObject(c)})}})};this.loadFile=function(a,b){b=b||function(){};new CubicVR.Worker({type:"file",data:mesh,message:function(a){b(a.data)}})}},loadColladaWorker:function(d,g,n,o){var r;try{r=new Worker(CubicVR.getScriptLocation()+"collada.js")}catch(s){throw Error("Can't find collada.js");
}var t=[],v=[];r.onmessage=function(g){function r(a,b){for(var c in a)b[c]=a[c]}function s(a){if(a.motion){for(var b=a.motion.controllers,d=[],e=0,g=b.length;e<g;++e){var h=b[e];if(h){for(var m=[],n=0,o=h.length;n<o;++n){var t=h[n];if(t){var u=t.keys[0];if(t.keys.length>1)u.prev=null,u.next=t.keys[1],u=t.keys[1];for(var v=1,w=t.keys.length-1;v<w;++v)u.prev=t.keys[v-1],u.next=t.keys[v+1],u=t.keys[v+1];if(t.keys.length>1)u=t.keys[t.keys.length-1],u.prev=t.keys[t.keys.length-2],u.next=null;t.firstKey=
t.keys[0];t.lastKey=t.keys[t.keys.length-1];t.keys=t.firstKey;u=new q;r(t,u);m[n]=u}else h[n]=null}d[e]=m}else b[e]=null}a.motion.controllers=d;b=new c;r(a.motion,b);a.motion=b}}function x(b){var c=new h;r(b,c);if(b.obj!==null){var e=v[b.obj.id];if(e===m)if(e=new a,r(b.obj,e),c.obj=e,v[b.obj.id]=e,o){if(e.points.length>0){o.addMesh(d,d+":"+e.id,e);for(var g=0,n=e.faces.length;g<n;++g){var q=e.faces[g],s=q.material;q.material=t[s]!==m?t[s]:0}}}else c.obj.triangulateQuads(),c.obj.calcNormals(),c.obj.compile(),
c.obj.clean();else c.obj=e}c.trans=new Transform;if(b.children&&b.children.length>0&&(c.children=[],b.children)){e=0;for(g=b.children.length;e<g;++e)n=x(b.children[e]),c.bindChild(n)}return c}var A;A=g.data.message;if(A=="materials"){var B=JSON.parse(g.data.data),g=0;for(A=B.length;g<A;++g){var D=new e(B[g].name),F=D.material_id;r(B[g],D);D.material_id=F;t[B[g].material_id]=F;for(var F=0,G=B[g].textures.length;F<G;++F){var O=B[g].textures[F];if(O){var K=Texture_ref[O.img_path];K===m?(O=new b(O.img_path,
O.filter_type,o,d),D.textures[F]=O):D.textures[F]=Textures_obj[K]}else D.textures[F]=0}}}else if(A=="scene"){B=JSON.parse(g.data.data);g=0;for(A=B.sceneObjects.length;g<A;++g){D=B.sceneObjects[g];D.obj!==null&&nop();if(D.reassembled===m)s(D),D.reassembled=!0;B.sceneObjects[g]=x(D)}D=new Scene;g=D.camera;A=g.transform;r(B.camera,g);r(B.camera.transform,A);s(g);D.camera=g;D.camera.transform=A;D.camera.frustum=new Frustum;g=0;for(A=B.sceneObjects.length;g<A;++g){F=B.sceneObjects[g];D.bindSceneObject(F);
try{F.getAABB()}catch(T){}}g=0;for(A=B.lights.length;g<A;++g)F=new Light,r(B.lights[g],F),F.trans=new Transform,s(F),D.bindLight(F);n(D)}else console.log("message from collada worker:",g.data.message)};r.onerror=function(a){console.log("error from collada worker:",a.message)};r.postMessage({message:"start",params:{meshUrl:d,prefix:g,rootDir:CubicVR.getScriptLocation()}})},InitWorker:function(){var a={test:r,prepareMesh:g,file:n,sceneFile:o};self.addEventListener("message",function(b){if(b.data.message===
"init"){var c=b.data.data.type;if(c in a)new a[c](b.data.data.data);else throw Error("Invalid worker type.");}},!1)}}});
/* Auto Embed ./CubicVR_Core.vs */
window.CubicVR.CubicVRCoreVS="attribute vec3 aVertexPosition;\nattribute vec3 aNormal;\nattribute vec2 aTextureCoord;\n#if hasVertexColorMap\nattribute vec3 aColor;\nvarying vec3 cmapColor;\n#endif\n#if hasMorph\nattribute vec3 amVertexPosition;\nattribute vec3 amNormal;\nuniform float morphWeight;\n#endif\nvarying vec2 vTextureCoord;\n#if !perPixel\n#if lightPoint||lightDirectional||lightSpot||lightArea\nuniform vec3 lDir[loopCount];\nuniform vec3 lPos[loopCount];\nuniform vec3 lSpec[loopCount];\nuniform vec3 lDiff[loopCount];\nuniform float lInt[loopCount];\nuniform float lDist[loopCount];\n#if lightSpot\nuniform float lCut[loopCount];\n#endif\nvarying vec3 vColor;\nvarying vec3 vSpec;\n#endif\nuniform vec3 mDiff;\nuniform vec3 mSpec;\nuniform float mShine;\n#endif\nuniform mat4 uMVMatrix;\nuniform mat4 uPMatrix;\nuniform mat4 uOMatrix;\nuniform mat3 uNMatrix;\nvarying vec3 vNormal;\nvarying vec4 vPosition;\n#if !depthPack\n#if hasShadow\nvarying vec4 shadowProj[loopCount];\nuniform mat4 spMatrix[loopCount];\n#endif\n#if hasEnvSphereMap\n#if hasNormalMap\nvarying vec3 u;\n#else\nvarying vec2 vEnvTextureCoord;\n#endif\n#endif\n#if hasBumpMap||hasNormalMap\nvarying vec3 eyeVec;\n#endif\n#endif \nvoid main(void)\n{\nmat4 uMVOMatrix = uMVMatrix * uOMatrix;\nmat4 uMVPMatrix = uPMatrix * uMVMatrix;\n#if hasMorph\nvPosition = uMVOMatrix * vec4(aVertexPosition+(amVertexPosition-aVertexPosition)*morphWeight, 1.0);\ngl_Position = uMVPMatrix * uOMatrix * vec4(aVertexPosition+(amVertexPosition-aVertexPosition)*morphWeight, 1.0);\n#else\nvPosition = uMVOMatrix * vec4(aVertexPosition, 1.0);\ngl_Position = uMVPMatrix * uOMatrix * vec4(aVertexPosition, 1.0);\n#endif\nvTextureCoord = aTextureCoord;\n#if !depthPack\n#if hasVertexColorMap\ncmapColor = aColor;\n#endif\n#if hasMorph\nvNormal = uNMatrix * normalize(uOMatrix*vec4(aNormal+(amNormal-aNormal)*morphWeight,0.0)).xyz;\n#else\nvNormal = uNMatrix * normalize(uOMatrix*vec4(aNormal,0.0)).xyz;\n#endif\n#if !perPixel\n#if lightPoint\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 accum = vec3(0.0,0.0,0.0);\nfor (int i = 0; i < loopCount; i++) {\nvec3 lDir = lPos[i]-vPosition.xyz;\nfloat dist = length(lDir);\nvec3 halfVector = normalize(vec3(0.0,0.0,1.0)+lDir);\nfloat NdotL = max(dot(normalize(lDir),vNormal),0.0);\nif (NdotL > 0.0) {\nfloat att = clamp(((lDist[i]-dist)/lDist[i]), 0.0, 1.0)*lInt[i];\naccum += att * NdotL * lDiff[i] * mDiff;\nfloat NdotHV = max(dot(vNormal, halfVector),0.0);\nvec3 spec2 = lSpec[i] * mSpec * pow(NdotHV,mShine);\nspecTotal += spec2;\n}\n}\nvColor = accum;\nvSpec = specTotal;\n#endif\n#if lightDirectional\nfloat NdotL;\nfloat NdotHV = 0.0;\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nvec3 accum = vec3(0.0,0.0,0.0);\nvec3 halfVector;\nfor (int i = 0; i < loopCount; i++) {\nhalfVector = normalize(vec3(0.0,0.0,1.0)-lDir[i]);\nNdotL = max(dot(normalize(-lDir[i]),vNormal),0.0);\nif (NdotL > 0.0)   {\naccum += lInt[i] * mDiff * lDiff[i] * NdotL;\nNdotHV = max(dot(vNormal, halfVector),0.0);\nspec2 = lSpec[i] * mSpec * pow(NdotHV,mShine);\nspecTotal += spec2;\n}\n}\nvColor = accum;\nvSpec = specTotal;\n#endif\n#if lightSpot\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nvec3 accum = vec3(0.0,0.0,0.0);\nvec3 halfVector;\nfloat spotEffect;\nfloat spotDot;\nfloat power;\nfor (int i = 0; i < loopCount; i++) {\nvec3 l = lPos[i]-vPosition.xyz;\nfloat dist = length(l);\nfloat att = clamp(((lDist[i]-dist)/lDist[i]), 0.0, 1.0)*lInt[i];\natt = clamp(att,0.0,1.0);\nspotDot = dot(normalize(-l), normalize(lDir[i]));\nif ( spotDot < cos((lCut[i]/2.0)*(3.14159/180.0)) ) {\nspotEffect = 0.0;\n}\nelse {\nspotEffect = pow(spotDot, 1.0);\n}\natt *= spotEffect;\nvec3 v = normalize(-vPosition.xyz);\nvec3 h = normalize(l + v);\nfloat NdotL = max(0.0, dot(vNormal, normalize(l)));\nfloat NdotH = max(0.0, dot(vNormal, h));\nif (NdotL > 0.0) {\npower = pow(NdotH, mShine);\n}\nelse {\npower = 0.0;\n}\naccum += att * lDiff[i] * mDiff * NdotL;\nspec2 = lSpec[i] * mSpec * power;\nspecTotal += spec2*spotEffect;\n}\nvColor = accum;\nvSpec = specTotal;\n#endif\n#endif \n#if hasBumpMap||hasNormalMap\nvec3 tangent;\nvec3 binormal;\nvec3 c1 = cross( aNormal, vec3(0.0, 0.0, 1.0) );\nvec3 c2 = cross( aNormal, vec3(0.0, 1.0, 0.0) );\nif ( length(c1) > length(c2) )  {\ntangent = c1;\n}  else {\ntangent = c2;\n}\ntangent = normalize(tangent);\nbinormal = cross(aNormal, tangent);\nbinormal = normalize(binormal);\nmat3 TBNMatrix = mat3( (vec3 (uMVOMatrix * vec4 (tangent, 0.0))),\n(vec3 (uMVOMatrix * vec4 (binormal, 0.0))),\n(vec3 (uMVOMatrix * vec4 (aNormal, 0.0)))\n);\neyeVec = vec3(uMVOMatrix * vec4(aVertexPosition,1.0)) * TBNMatrix;\n#endif\n#if (lightSpot||lightArea) && hasShadow\nfor (int i = 0; i < loopCount; i++)\n{\n#if hasShadow\n#if hasMorph\nshadowProj[i] = spMatrix[i] * (uOMatrix * vec4(aVertexPosition+(amVertexPosition-aVertexPosition)*morphWeight, 1.0));\n#else\nshadowProj[i] = spMatrix[i] * (uOMatrix * vec4(aVertexPosition, 1.0));\n#endif\n#endif\n}\n#endif\n#if hasEnvSphereMap\n#if hasNormalMap\nu = normalize( vPosition.xyz );\n#else\nvec3 ws = (uMVMatrix * vec4(aVertexPosition,1.0)).xyz;\nvec3 u = normalize( vPosition.xyz );\nvec3 r = reflect(ws, vNormal );\nfloat m = 2.0 * sqrt( r.x*r.x + r.y*r.y + (r.z+1.0)*(r.z+1.0) );\nvEnvTextureCoord.s = r.x/m + 0.5;\nvEnvTextureCoord.t = r.y/m + 0.5;\n#endif\n#endif\n#endif \n}\n";
/* Auto Embed ./CubicVR_Core.fs */
window.CubicVR.CubicVRCoreFS="#ifdef GL_ES\n#if perPixel\nprecision highp float;\n#else\nprecision lowp float;\n#endif\n#endif\nuniform vec3 mAmb;\nuniform vec3 lAmb;\nuniform vec3 mColor;\n#if perPixel\nuniform vec3 mDiff;\nuniform vec3 mSpec;\nuniform float mShine;\n#if lightPoint||lightDirectional||lightSpot||lightArea\nuniform vec3 lDir[loopCount];\nuniform vec3 lPos[loopCount];\nuniform vec3 lSpec[loopCount];\nuniform vec3 lDiff[loopCount];\nuniform float lInt[loopCount];\nuniform float lDist[loopCount];\n#if lightSpot\nuniform float lCut[loopCount];\n#endif\n#endif\n#if hasProjector\nuniform sampler2D lProjTex[loopCount];\n#endif\n#if hasShadow\nvarying vec4 shadowProj[loopCount];\nuniform sampler2D lDepthTex[loopCount];\nuniform vec3 lDepth[loopCount];\n#endif\n#else \nvarying vec3 vColor;\nvarying vec3 vSpec;\n#endif  \nvarying vec3 vNormal;\nvarying vec2 vTextureCoord;\n#if hasVertexColorMap\nvarying vec3 cmapColor;\n#endif\n#if alphaDepth||depthPack||hasShadow\nuniform vec3 depthInfo;\nfloat ConvertDepth3(float d) { return (depthInfo.x*depthInfo.y)/(depthInfo.y-d*(depthInfo.y-depthInfo.x));  }\nfloat DepthRange( float d ) { return ( d - depthInfo.x ) / ( depthInfo.y - depthInfo.x ); }\nfloat ConvertDepth3A(float d, float near, float far) { return (near*far)/(far-d*(far-near));  }\nfloat DepthRangeA( float d, float near, float far ) { return ( d - near ) / ( far - near ); }\n#endif\n#if depthPack\nvec4 packFloatToVec4i(const float value)\n{\nconst vec4 bitSh = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);\nconst vec4 bitMsk = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);\nvec4 res = fract(value * bitSh);\nres -= res.xxyz * bitMsk;\nreturn res;\n}\n#endif\n#if hasShadow\nfloat unpackFloatFromVec4i(const vec4 value)\n{\nconst vec4 bitSh = vec4(1.0/(256.0*256.0*256.0), 1.0/(256.0*256.0), 1.0/256.0, 1.0);\nreturn(dot(value, bitSh));\n}\n#if softShadow\nfloat getShadowVal(sampler2D shadowTex,vec4 shadowCoord, float proj, float texel_size) {\nvec2 filterTaps[6];\nfilterTaps[0] = vec2(-0.326212,-0.40581);\nfilterTaps[1] = vec2(-0.840144,-0.07358);\nfilterTaps[2] = vec2(-0.695914,0.457137);\nfilterTaps[3] = vec2(-0.203345,0.620716);\nfilterTaps[4] = vec2(0.96234,-0.194983);\nfilterTaps[5] = vec2(0.473434,-0.480026);\n/*  filterTaps[6] = vec2(0.519456,0.767022);\nfilterTaps[7] = vec2(0.185461,-0.893124);\nfilterTaps[8] = vec2(0.507431,0.064425);\nfilterTaps[9] = vec2(0.89642,0.412458) ;\nfilterTaps[10] =vec2(-0.32194,-0.932615);\nfilterTaps[11] =vec2(-0.791559,-0.59771); */\nfloat shadow = 0.0;\nvec4  shadowSample;\nfloat distanceFromLight;\nfor (int i = 0; i < 6; i++) {\nshadowSample = texture2D(shadowTex,shadowCoord.st+filterTaps[i]*(2.0*texel_size));\ndistanceFromLight = unpackFloatFromVec4i(shadowSample);\nshadow += distanceFromLight <= shadowCoord.z ? 0.0 : 1.0 ;\n}\nshadow /= 6.0;\nreturn shadow;\n}\n#else\nfloat getShadowVal(sampler2D shadowTex,vec4 shadowCoord, float proj, float texel_size) {\nvec4 shadowSample = texture2D(shadowTex,shadowCoord.st);\nfloat distanceFromLight = unpackFloatFromVec4i(shadowSample);\nfloat shadow = 1.0;\nshadow = distanceFromLight <= (shadowCoord.z) ? 0.0 : 1.0 ;\nreturn shadow;\n}\n#endif\n#endif\n#if !depthPack\n#if hasColorMap\nuniform sampler2D colorMap;\n#endif\n#if hasBumpMap\nvarying vec3 eyeVec;\nuniform sampler2D bumpMap;\n#endif\n#if hasEnvSphereMap\nuniform sampler2D envSphereMap;\nuniform float envAmount;\n#if hasNormalMap\nvarying vec3 u;\n#else\nvarying vec2 vEnvTextureCoord;\n#endif\n#endif\n#if hasReflectMap\nuniform sampler2D reflectMap;\n#endif\n#if hasNormalMap\nuniform sampler2D normalMap;\n#endif\nuniform float mAlpha;\n#if hasAmbientMap\nuniform sampler2D ambientMap;\n#endif\n#if hasSpecularMap\nuniform sampler2D specularMap;\n#endif\n#endif \n#if hasAlphaMap\nuniform sampler2D alphaMap;\n#endif\nvarying vec4 vPosition;\nuniform mat4 uPMatrix;\nvoid main(void)\n{\n#if depthPack\nvec2 texCoord = vTextureCoord;\n#else\nvec3 n;\nvec4 color = vec4(0.0,0.0,0.0,0.0);\n#if hasBumpMap\nfloat height = texture2D(bumpMap, vTextureCoord.xy).r;\nfloat v = (height) * 0.05 - 0.04; \nvec3 eye = normalize(eyeVec);\nvec2 texCoord = vTextureCoord.xy + (eye.xy * v);\n#else\nvec2 texCoord = vTextureCoord;\n#endif\n#if hasNormalMap\nvec3 bumpNorm = vec3(texture2D(normalMap, texCoord));\nn = (vec4(normalize(vNormal),1.0)).xyz;\nbumpNorm = (bumpNorm-0.5)*2.0;\nbumpNorm.y = -bumpNorm.y;\nn = normalize((n+bumpNorm)/2.0);\n#else\nn = normalize(vNormal);\n#endif\n#if hasColorMap\n#if !(lightPoint||lightDirectional||lightSpot||lightArea)\ncolor = texture2D(colorMap, vec2(texCoord.s, texCoord.t)).rgba;\ncolor.rgb *= mColor;\n#else\ncolor = texture2D(colorMap, vec2(texCoord.s, texCoord.t)).rgba;\ncolor.rgb *= mColor;\n#endif\nif (color.a<=0.9) discard;\n#else\n#if hasVertexColorMap\ncolor = vec4(cmapColor,1.0);\n#else\ncolor = vec4(mColor,1.0);\n#endif\n#endif\n#if hasAlphaMap\ncolor.a = texture2D(alphaMap, texCoord).r;\n#if alphaDepth\nif (color.a < 0.9) discard;\n#else\n#if !hasAlpha\nif (color.a<0.9) discard;\n#else\nif (color.a==0.0) discard;\n#endif\n#endif\n#else\n#if hasAlpha\ncolor.a = mAlpha;\n#endif\n#endif\nvec3 accum = lAmb;\n#if perPixel\n#if lightPoint\nvec3 specTotal = vec3(0.0,0.0,0.0);\nfor (int i = 0; i < loopCount; i++) {\nvec3 lDir = lPos[i]-vPosition.xyz;\nfloat dist = length(lDir);\nvec3 halfVector = normalize(vec3(0.0,0.0,1.0)+lDir);\nfloat NdotL = max(dot(normalize(lDir),n),0.0);\nif (NdotL > 0.0) {\nfloat att = clamp(((lDist[i]-dist)/lDist[i]), 0.0, 1.0)*lInt[i];\naccum += att * NdotL * lDiff[i] * mDiff;\nfloat NdotHV = max(dot(n, halfVector),0.0);\n#if hasSpecularMap\nvec3 spec2 = lSpec[i] * texture2D(specularMap, vec2(texCoord.s, texCoord.t)).rgb * pow(NdotHV,mShine);\n#else\nvec3 spec2 = lSpec[i] * mSpec * pow(NdotHV,mShine);\n#endif\nspecTotal += spec2;\n}\n}\ncolor.rgb *= accum;\ncolor.rgb += specTotal;\n#endif\n#if lightDirectional\nfloat NdotL;\nfloat NdotHV = 0.0;\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nvec3 halfVector;\nfor (int i = 0; i < loopCount; i++) {\nhalfVector = normalize(vec3(0.0,0.0,1.0)-lDir[i]);\nNdotL = max(dot(normalize(-lDir[i]),n),0.0);\nif (NdotL > 0.0)   {\naccum += lInt[i] * mDiff * lDiff[i] * NdotL;\nNdotHV = max(dot(n, halfVector),0.0);\n#if hasSpecularMap\nspec2 = lSpec[i] * texture2D(specularMap, vec2(texCoord.s, texCoord.t)).rgb * pow(NdotHV,mShine);\n#else\nspec2 = lSpec[i] * mSpec * pow(NdotHV,mShine);\n#endif\nspecTotal += spec2;\n}\n}\ncolor.rgb *= accum;\ncolor.rgb += specTotal;\n#endif\n#if lightArea\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nfloat NdotL;\nfloat NdotHV = 0.0;\nvec3 halfVector;\nfor (int i = 0; i < loopCount; i++) {\nhalfVector = normalize(vec3(0.0,0.0,1.0)-lDir[i]);\nNdotL = max(dot(normalize(-lDir[i]),n),0.0);\nif (NdotL > 0.0)   {\nNdotHV = max(dot(n, halfVector),0.0);\n#if hasShadow\nvec4 shadowCoord = shadowProj[i] / shadowProj[i].w;\nshadowCoord.z = DepthRangeA(ConvertDepth3A(shadowCoord.z,lDepth[i].x,lDepth[i].y),lDepth[i].x,lDepth[i].y);\nvec4 shadowSample;\nfloat shadow = 1.0;\nif (shadowCoord.s > 0.000&&shadowCoord.s < 1.000 && shadowCoord.t > 0.000 && shadowCoord.t < 1.000) if (i == 0) { shadow = getShadowVal(lDepthTex[0],shadowCoord,shadowProj[i].w,lDepth[i].z);}\n#if loopCount>1\nelse if (i == 1) { shadow = getShadowVal(lDepthTex[1],shadowCoord,shadowProj[i].w,lDepth[i].z); }\n#endif\n#if loopCount>2\nelse if (i == 2) { shadow = getShadowVal(lDepthTex[2],shadowCoord,shadowProj[i].w,lDepth[i].z); }\n#endif\n#if loopCount>3\nelse if (i == 3) { shadow = getShadowVal(lDepthTex[3],shadowCoord,shadowProj[i].w,lDepth[i].z);  }\n#endif\n#if loopCount>4\nelse if (i == 4) { shadow = getShadowVal(lDepthTex[4],shadowCoord,shadowProj[i].w,lDepth[i].z);  }\n#endif\n#if loopCount>5\nelse if (i == 5) { shadow = getShadowVal(lDepthTex[5],shadowCoord,shadowProj[i].w,lDepth[i].z);  }\n#endif\n#if loopCount>6\nelse if (i == 6) { shadow = getShadowVal(lDepthTex[6],shadowCoord,shadowProj[i].w,lDepth[i].z);  }\n#endif\n#if loopCount>7\nelse if (i == 7) { shadow = getShadowVal(lDepthTex[7],shadowCoord,shadowProj[i].w,lDepth[i].z); }\n#endif\naccum += shadow * lInt[i] * mDiff * lDiff[i] * NdotL;\n#else\naccum += lInt[i] * mDiff * lDiff[i] * NdotL;\n#endif\n#if hasSpecularMap\nspec2 = lSpec[i] * texture2D(specularMap, vec2(texCoord.s, texCoord.t)).rgb * pow(NdotHV,mShine);\n#else\nspec2 = lSpec[i] * mSpec * pow(NdotHV,mShine);\n#endif\n#if hasShadow\nspec2 *= shadow;\n#endif\nspecTotal += spec2;\n#if hasShadow\n#endif\n}\n}\ncolor.rgb *= accum;\ncolor.rgb += specTotal;\n#endif\n#if lightSpot\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nvec3 halfVector;\nfloat spotEffect;\nfloat spotDot;\nfloat power;\nfor (int i = 0; i < loopCount; i++) {\nvec3 l = lPos[i]-vPosition.xyz;\nfloat dist = length(l);\nfloat att = clamp(((lDist[i]-dist)/lDist[i]), 0.0, 1.0)*lInt[i];\natt = clamp(att,0.0,1.0);\nspotDot = dot(normalize(-l), normalize(lDir[i]));\nif ( spotDot < cos((lCut[i]/2.0)*(3.14159/180.0)) ) {\nspotEffect = 0.0;\n}\nelse {\nspotEffect = pow(spotDot, 1.0);\n}\n#if !hasProjector\natt *= spotEffect;\n#endif\nvec3 v = normalize(-vPosition.xyz);\nvec3 h = normalize(l + v);\nfloat NdotL = max(0.0, dot(n, normalize(l)));\nfloat NdotH = max(0.0, dot(n, h));\nif (NdotL > 0.0) {\npower = pow(NdotH, mShine);\n}\nelse {\npower = 0.0;\n}\n#if hasShadow\nvec4 shadowCoord = shadowProj[i] / shadowProj[i].w;\nshadowCoord.z = DepthRangeA(ConvertDepth3A(shadowCoord.z,lDepth[i].x,lDepth[i].y),lDepth[i].x,lDepth[i].y);\nvec4 shadowSample;\nfloat shadow = 1.0;\nif (shadowCoord.s >= 0.000&&shadowCoord.s <= 1.000 && shadowCoord.t >= 0.000 && shadowCoord.t <= 1.000) if (i == 0) { shadow = getShadowVal(lDepthTex[0],shadowCoord,shadowProj[i].w,lDepth[i].z);}\n#if loopCount>1\nelse if (i == 1) { shadow = getShadowVal(lDepthTex[1],shadowCoord,shadowProj[i].w,lDepth[i].z); }\n#endif\n#if loopCount>2\nelse if (i == 2) { shadow = getShadowVal(lDepthTex[2],shadowCoord,shadowProj[i].w,lDepth[i].z); }\n#endif\n#if loopCount>3\nelse if (i == 3) { shadow = getShadowVal(lDepthTex[3],shadowCoord,shadowProj[i].w,lDepth[i].z);  }\n#endif\n#if loopCount>4\nelse if (i == 4) { shadow = getShadowVal(lDepthTex[4],shadowCoord,shadowProj[i].w,lDepth[i].z);  }\n#endif\n#if loopCount>5\nelse if (i == 5) { shadow = getShadowVal(lDepthTex[5],shadowCoord,shadowProj[i].w,lDepth[i].z);  }\n#endif\n#if loopCount>6\nelse if (i == 6) { shadow = getShadowVal(lDepthTex[6],shadowCoord,shadowProj[i].w,lDepth[i].z);  }\n#endif\n#if loopCount>7\nelse if (i == 7) { shadow = getShadowVal(lDepthTex[7],shadowCoord,shadowProj[i].w,lDepth[i].z); }\n#endif\natt = att * shadow;\n#endif\n#if hasProjector && hasShadow\nif (shadowCoord.s >= 0.0&&shadowCoord.s <= 1.0 && shadowCoord.t >= 0.0 && shadowCoord.t <= 1.0 && spotDot > cos((90.0)*(3.14159/180.0))) {\nvec3 projTex = texture2D(lProjTex[i],shadowCoord.st).rgb;\naccum += att * projTex * lInt[i] * mDiff * lDiff[i] * NdotL;\n}\n#else\naccum += att * lDiff[i] * mDiff * NdotL;\n#endif\n#if hasSpecularMap\nspec2 = lSpec[i] * texture2D(specularMap, vec2(texCoord.s, texCoord.t)).rgb * power;\n#else\nspec2 = lSpec[i] * mSpec * power;\n#endif\n#if hasShadow\nspec2 *= shadow;\n#endif\nspecTotal += spec2*spotEffect;\n}\ncolor.rgb *= accum;\ncolor.rgb += specTotal;\n#if hasShadow\n#endif\n#endif\n#else\n#if lightPoint||lightDirectional||lightSpot||lightArea\ncolor.rgb *= vColor;\ncolor.rgb += vSpec;\n#endif\n#endif \n#if hasReflectMap\nfloat environmentAmount = texture2D( reflectMap, texCoord).r;\n#endif\n#if hasEnvSphereMap\n#if hasNormalMap\nvec3 r = reflect( u, n );\nfloat m = 2.0 * sqrt( r.x*r.x + r.y*r.y + (r.z+1.0)*(r.z+1.0) );\nvec3 coord;\ncoord.s = r.x/m + 0.5;\ncoord.t = r.y/m + 0.5;\n#if hasReflectMap\ncolor.rgb += mColor*accum*texture2D( envSphereMap, coord.st).rgb * environmentAmount;\n#else\ncolor.rgb += mColor*accum*texture2D( envSphereMap, coord.st).rgb * envAmount;\n#endif\n#else\n#if hasReflectMap\ncolor.rgb += mColor*accum*texture2D( envSphereMap, vEnvTextureCoord).rgb * environmentAmount;\n#else\ncolor.rgb += mColor*accum*texture2D( envSphereMap, vEnvTextureCoord).rgb*envAmount;\n#endif\n#endif\n#endif\n#if hasAmbientMap\n#if lightPoint||lightDirectional||lightSpot||lightArea\ncolor.rgb += texture2D(ambientMap, texCoord).rgb*(vec3(1.0,1.0,1.0)+mColor*mAmb);\n#else\ncolor.rgb = color.rgb*texture2D(ambientMap, texCoord).rgb;\n#endif\n#else\n#if !hasColorMap\ncolor.rgb += mColor*mAmb;\n#else\ncolor.rgb += mAmb*texture2D(colorMap, texCoord).rgb;\n#endif\n#endif\n#if alphaDepth\n#if !hasAlpha\nfloat linear_depth = DepthRange( ConvertDepth3(gl_FragCoord.z) );\ncolor.a = linear_depth;\n#endif\n#endif\ngl_FragColor = clamp(color,0.0,1.0);\n#endif \n#if depthPack\n#if hasAlphaMap\nfloat alphaVal = texture2D(alphaMap, texCoord).r;\nif (alphaVal < 0.9) discard;\n#endif\ngl_FragColor = packFloatToVec4i(DepthRange( ConvertDepth3(gl_FragCoord.z)));\n#endif\n}\n";
